<?php

date_default_timezone_set('Europe/Berlin');
drupal_add_css(drupal_get_path('module', 'lovak') . '/css/lovak.css');


function lovak_help($section) {
  switch ($section) {
    case 'admin/modules#description':
    function lovak_importalas(){
    }
    return t('Lovak adatbázismûveletek');
  }
}

function lovak_perm(){
    return array('lovak', 'lovak adm', 'lovak_lista', 'lovak listaforma', 'lovak jz');
}

function theme_lovak_block($felirat) {
  return $felirat . ' Itt a LO blokkom';
}

function lovak_menu() {
  $items = array();
  $access = array('lovak');
  $access_adm = array('lovak adm');
  $access_jz = array('lovak jz');

   $items['lovak/utlevel'] = array(
    'title' => 'Upload utlevel.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('lovak_utlevel_upload_form'),
    'access arguments' => $access_adm,
    'type' => MENU_NORMAL_ITEM,
  );
   
  $items['lovak/keres'] = array(
    'title' => 'Loker Test autocomplete',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('loker_form'),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );
 
  $items['lovak/autocomplete'] = array(
    'page callback' => 'lovak_autocomplete',
    'access arguments' => $access,
    'type' => MENU_CALLBACK,
  );
  
    
  $items['lovak'] = array(
    'title' => drupal_convert_to_utf8(t('Lovak keresése'), 'iso-8859-2'),
    'description' => 'Lovak',
    'page callback' => 'lovak_page',
    'access arguments' => $access,
    'type' => MENU_CALLBACK,
  );

  $items['lovak/adm/%'] = array(
    'title' => drupal_convert_to_utf8(t('Lovak felvitele-módosítása'), 'iso-8859-2'),
    'description' => 'Lovak',
    'page callback' => 'lovak_page',
    'access arguments' => $access_adm,
    'file' => 'lovak.module',
    'type' => MENU_CALLBACK,
  );

   $items['lovak/admfed/%'] = array(
    'title' => drupal_convert_to_utf8(t('Fedeztetés keresése'), 'iso-8859-2'),
    'description' => 'Lovak fedeztetes',
    'page callback' => 'lovak_page',
    'access arguments' => $access_adm,
    'file' => 'lovak.module',
    'type' => MENU_CALLBACK,
  );


  $items['lovak/lista/csiko'] = array(
    'title' => drupal_convert_to_utf8(t('Évjárat listája'), 'iso-8859-2'),
    'description' => 'Lovak',
    'page callback' => 'lovak_page',
    'access arguments' => $access,
    'file' => 'lovak.module',
    'type' => MENU_CALLBACK,
  );
  

  $items['lovak/lista/varipub'] = array(
    'title' => drupal_convert_to_utf8(t('Beállítható lista'), 'iso-8859-2'),
    'description' => 'Lovak',
    'page callback' => 'lovak_page',
    'access arguments' => $access,
    'file' => 'lovak.module',
    'type' => MENU_CALLBACK,
  );
  $items['lovak/teny'] = array(
    'title' => drupal_convert_to_utf8(t('Származás modellezése'), 'iso-8859-2'),
    'page callback' => 'lokerteny',
    'access arguments' => $access,
    'file' => 'lovak.module',
    'type' => MENU_CALLBACK,
  );

  $items['lovak/listavari'] = array(
    'title' => drupal_convert_to_utf8(t('Lovak listája'), 'iso-8859-2'),
    'page callback' => 'lovak_listavari',
    'access arguments' => $access_adm,
    'file' => 'lovak.module',
    'type' => MENU_CALLBACK,
  );

  $items['lovak/listafedeztetes'] = array(
    'title' => drupal_convert_to_utf8(t('Lovak listája'), 'iso-8859-2'),
    'page callback' => 'lovak_listafedeztetes',
    'access arguments' => $access_adm,
    'file' => 'lovak.module',
    'type' => MENU_CALLBACK,
  );
  $items['lovak/listatranszponder'] = array(
    'title' => drupal_convert_to_utf8(t('Lovak listája'), 'iso-8859-2'),
    'page callback' => 'lovak_listatranszponder',
    'access arguments' => $access_adm,
    'file' => 'lovak.module',
    'type' => MENU_CALLBACK,
  );

  $items['lovak/listaforma'] = array(
    'title' => drupal_convert_to_utf8(t('Lovak keresése'), 'iso-8859-2'),
    'page callback' => 'lovak_listaforma',
    'access arguments' => $access_adm,
    'file' => 'lovak.module',
    'type' => MENU_CALLBACK,
  );
  
  $items['lovak/menstat'] = array(
    'title' => drupal_convert_to_utf8(t('Lovak keresése'), 'iso-8859-2'),
    'page callback' => 'lovak_menstat',
    'access arguments' => $access,
    'file' => 'lovak.module',
    'type' => MENU_CALLBACK,
  );

  $items['lovak/listaujlovak'] = array(
    'title' => drupal_convert_to_utf8(t('Lovak keresése'), 'iso-8859-2'),
    'page callback' => 'lovak_listaujlovak',
    'access arguments' => $access_adm,
    'file' => 'lovak.module',
    'type' => MENU_CALLBACK,
  );
  $items['lovak/listamodlovak'] = array(
    'title' =>drupal_convert_to_utf8(t('Lovak keresése'), 'iso-8859-2'),
    'page callback' => 'lovak_listamodlovak',
    'access arguments' => $access_adm,
    'file' => 'lovak.module',
    'type' => MENU_CALLBACK,
  );
  $items['lovak/listabekerult'] = array(
    'title' =>drupal_convert_to_utf8(t('Lovak keresése'), 'iso-8859-2'),
    'page callback' => 'lovak_listabekerult',
    'access arguments' => $access_adm,
    'file' => 'lovak.module',
    'type' => MENU_CALLBACK,
  );
  $items['lovak/listamodtullovak'] = array(
    'title' =>drupal_convert_to_utf8(t('Lovak keresése'), 'iso-8859-2'),
    'page callback' => 'lovak_listamodtullovak',
    'access arguments' => $access_adm,
    'file' => 'lovak.module',
    'type' => MENU_CALLBACK,
  );
  $items['lovak/importalas'] = array(
    'title' =>drupal_convert_to_utf8(t('Lovak keresése'), 'iso-8859-2'),
    'page callback' => 'lovak_importalas',
    'access arguments' => $access_adm,
    'file' => 'lovak.module',
    'type' => MENU_CALLBACK,
  );
  $items['lovak/arveres'] = array(
    'title' =>drupal_convert_to_utf8(t('Lovak keresése'), 'iso-8859-2'),
    'page callback' => 'lovak_arveres',
    'access arguments' => $access_adm,
    'file' => 'lovak.module',
    'type' => MENU_CALLBACK,
  );
 
  
  return $items;
}


function loker_formz($form, &$form_state, $vid) {
  $form = array();
 
  $form['colors'] = array(
    '#title' => t('Colors').$vid,
    '#type' => 'textfield',
    '#maxlength' => 60,
    '#autocomplete_path' => 'lovak/engine/$vid',
  );
 
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => 'Submit',
  );
 
  return $form;
}



function lovak_page($flag='normal'){
 global $user, $remo, $remono;
 
 //print_r($_GET);
  if(isset($_GET["lovak_dbturk"])){
    
        $res = db_query("SELECT neve, ev, apja, apja_ev, anyja, anyja_ev FROM lovak WHERE lo_vagy_fed='LO'");
        $res=db_fetch_array($res);
        //print_r($res);
        foreach($res as $k => $v){
          $nev=$k[neve];
          //print "<br>Neve:".$nev;
        }
  }
  if(isset($_GET["lovak_upload"])){lovak_upload();return;}
  if(isset($_GET["lovak_upload_report"])){lovak_upload_report();return;}
  if(isset($_GET["lovak_evbeiras_univerzalis"])){lovak_evbeiras_univerzalis();return;}
  if(isset($_GET["lovak_evbeiras"])){lovak_evbeiras();return;}
  if(isset($_GET["lovak_evbeiras_apja"])){lovak_evbeiras_apja();return;}
  if(isset($_GET["lovak_evbeiras_anyja"])){lovak_evbeiras_anyja();return;}
  if(isset($_GET["lovak_mod"])){lovak_mod();return;}
  if(isset($_GET["lovak_teny"])){lovak_teny();return;}
  if(isset($_GET["ivadekai"])){ivadekai("apja");ivadekai($_GET["mod"], $_GET["ordered"], $_GET["lo_no"]);return;}
  //print_r($_GET);
  foreach($_GET as $k=>$v){
        //print "<br>key:".$v;
        if(substr($k,0,7)=='lokeres'){
            preg_match('!_(.+)!', $k, $no);
            $kerno=$no['1'];
            $eredmeny = db_query("SELECT neve, ev FROM lovak WHERE no = '$kerno' && lo_vagy_fed='LO'");
            $tal_db=db_affected_rows();
            if($tal_db){
                $res=db_fetch_array($eredmeny);
                $lonev=$res['neve'];
                $ev=$res['ev'];
                lovak_sablon($lonev,$ev);
                return;
            }
        }
        if(substr($v,0,11)=='lovak/teszt'){lovak_teszt();return;}
        if(substr($v,0,12)=='lovak/admfed'){$sa=explode('/',$v);if(isset($sa['2'])){$action=$sa['2'];}lovak_admfed($action);return;}
        if(substr($v,0,9)=='lovak/adm'){$sa=explode('/',$v);if(isset($sa['2'])){$action=$sa['2'];}lovak_adm($action);return;}
        if(substr($v,0,10)=='lovak/teny'){$sa=explode('/',$v);if(isset($sa['2'])){$action=$sa['2'];}lokerteny();return;}
        if(substr($v,0,15)=='lovak/listavari'){$sa=explode('/',$v);if(isset($sa['2'])){$listafajta=$sa['2'];}lovak_listavari($listafajta);return;}
//        if(substr($v,0,15)=='lovak/listavari'){$sa=explode('/',$v);if(isset($sa['2'])){$listafajta=$sa['2'];}lovak_listavari($listafajta);return;}
        if(substr($v,0,21)=='lovak/listafedeztetes'){$sa=explode('/',$v);if(isset($sa['2'])){$listafajta=$sa['2'];}lovak_listafedeztetes($listafajta);return;}
        if(substr($v,0,23)=='lovak/listatranszponder'){$sa=explode('/',$v);if(isset($sa['2'])){$listafajta=$sa['2'];}lovak_listatranszponder($listafajta);return;}
        if(substr($v,0,18)=='lovak/menstat'){$sa=explode('/',$v);if(isset($sa['2'])){$listafajta=$sa['2'];}lovak_menstat($listafajta);return;}
        if(substr($v,0,18)=='lovak/listaujlovak'){$sa=explode('/',$v);if(isset($sa['2'])){$listafajta=$sa['2'];}lovak_listaujlovak($listafajta);return;}
        if(substr($v,0,19)=='lovak/listamodlovak'){$sa=explode('/',$v);if(isset($sa['2'])){$listafajta=$sa['2'];}lovak_listamodlovak($listafajta);return;}
        if(substr($v,0,19)=='lovak/listabekerult'){$sa=explode('/',$v);if(isset($sa['2'])){$listafajta=$sa['2'];}lovak_listamodlovak($listafajta);return;}
        if(substr($v,0,22)=='lovak/listamodtullovak'){$sa=explode('/',$v);if(isset($sa['2'])){$listafajta=$sa['2'];}lovak_listamodtullovak($listafajta);return;}
        if(substr($v,0,16)=='lovak/importalas'){$sa=explode('/',$v);if(isset($sa['2'])){$listafajta=$sa['2'];}lovak_importalas($listafajta);return;}
        if(substr($v,0,11)=='lovak/lista'){$sa=explode('/',$v);if(isset($sa['2'])){$listafajta=$sa['2'];}lovak_lista($listafajta);return;}
        if(substr($v,0,12)=='lovak/sablon'){
            $sa=explode('/',$v);
            if(isset($sa['2'])){
                $no=$sa['2'];
            }
            if(isset($sa['3'])){
                $vaneforma=$sa['3'];
                $iloid=$sa['4'];
                if(empty($orszag)){$orszag="";}
                //_mailuzenet($iloid);
                lovak_sablon($no,"","","","",$vaneforma,$iloid,$orszag);
            }else{
            lovak_sablon($no);
            }
            return;
        }
        if(substr($v,0,11)=='lovak/forma'){$sa=explode('/',$v);if(isset($sa['2'])){$no=$sa['2'];}lovak_forma($no);return;}
        if(substr($k,0,8)=='lovakmod'){
            preg_match('!_(.+)!', $k, $no);
            $kerno=$no['1'];
            $eredmeny = db_query("SELECT neve, ev FROM lovak WHERE no = '$kerno' && lo_vagy_fed='LO'");
            $tal_db=db_affected_rows();
            if($tal_db){
                $res=db_fetch_array($eredmeny);
                $lonev=$res['neve'];
                $ev=$res['ev'];
                lovak_mod($lonev,$ev);
                return;
            }
        }
        if(substr($v,0,11)=='lovak/upgrd'){
        
            $sa=explode('/',$v);
            if(isset($sa['2'])){
                $no=$sa['2'];
            }
            //print_r($sa);
            //print "<br>no".$no;
            lovak_upgrd($sa['2']);
            return;
        }
  }

  //print "<br>lovak";
$kateg="normal";
$hova="normal";
$block_v_page="block";

$ret="";
if(isset($_POST['lonev'])){
//print_r($_POST['lonev']);
//return;
    $lonev_ev_o=$_POST['lonev'];
    $lodarabok = explode("--", $lonev_ev_o);
    $lonev=$lodarabok[0];
    $ev=$lodarabok[1];
    $orszag=$lodarabok[2];
 //print "<br>lonev:".$lonev;
 //print "<br>kateg:".$kateg;
    
    if($kateg == "normal"){
        if(trim($orszag)==""){
            if($ev==0){
              print "<br>ev0";
                $res=db_query("SELECT no, ev, szine, neme, rekord, penz, tulajdonos, nevel FROM lovak WHERE binary neve = '%s' && ev = 0 && lo_vagy_fed='LO'", $lonev);
            }else{
              print "<br>evNEM0";
                $res=db_query("SELECT no, ev, szine, neme, rekord, penz, tulajdonos, nevel FROM lovak WHERE binary neve = '%s' && ev = '%d' && lo_vagy_fed='LO'", $lonev, $ev);
            }
        }else{
            if($ev==0){
              print "<br>ev0";
                $res=db_query("SELECT no, ev, szine, neme, rekord, penz, tulajdonos, nevel FROM lovak WHERE binary neve = '%s' && orszag = '%s' && ev = 0 && lo_vagy_fed='LO'", $lonev, $orszag);
            }else{
              //print "<br>evNEM0";
                $res=db_query("SELECT no, ev, szine, neme, rekord, penz, tulajdonos, nevel FROM {lovak} WHERE binary neve = :neve && ev = :ev && orszag = :orszag && lo_vagy_fed = :lo_vagy_fed", array(":neve" => $lonev, ":ev" => $ev, ":orszag" => $orszag, ":lo_vagy_fed" => 'LO'));
                
                //$query=db_query("SELECT no, ev, szine, neme, rekord, penz, tulajdonos, nevel FROM {lovak} WHERE neve = :neve", array(":neve" => $lonev));
            }
            
            //print_r($res);
        }
    }
    if($kateg == "norm_feddel"){
        if(trim($orszag)==""){
            if($ev==0){
                $res=db_query("SELECT no, ev, szine, neme, rekord, penz, tulajdonos, nevel FROM lovak WHERE binary neve = '%s' && ev = 0", $lonev);
            }else{
                $res=db_query("SELECT no, ev, szine, neme, rekord, penz, tulajdonos, nevel FROM lovak WHERE binary neve = '%s' && ev = '%d'", $lonev, $ev);
            }
        }else{
            if($ev==0){
                $res=db_query("SELECT no, ev, szine, neme, rekord, penz, tulajdonos, nevel FROM lovak WHERE binary neve = '%s' && orszag = '%s' && ev = 0", $lonev, $orszag);
            }else{
                $res=db_query("SELECT no, ev, szine, neme, rekord, penz, tulajdonos, nevel FROM lovak WHERE binary neve = '%s' && ev = '%d' && orszag = '%s'", $lonev, $ev, $orszag);
            }
        }
    }

    if($kateg == "anyja"){
        $eredmeny = db_query("SELECT $field, ev, no FROM lovak WHERE $field LIKE '$lokernev%' && neme = 'k' && lo_vagy_fed='LO' ORDER BY $field");
    }
    if($kateg == "apja"){
        $eredmeny = db_query("SELECT $field, ev, no FROM lovak WHERE $field LIKE '$lokernev%' && neme = 'm' && fedezomen = 'IGEN' && lo_vagy_fed='LO' ORDER BY $field");
    }
    //$res = $query->fetchAll();
    foreach ($res as $record) {
        $lonev_no=$record->no;
        $ev=$record->ev;
        $szine=$record->szine;
        $neme=$record->neme;
        $rekord=$record->rekord;
        $penz=$record->penz;
        $tulajdonos=$record->tulajdonos;
        $nevel=$record->nevel;
        //print_r($record);
    }
    //print_r($record);
    //print "<br>no:".$lonev_no;
    //print "<br>penz:".$penz;
    
    $ret=$lonev_no;
    $no=$lonev_no;
    if($lonev_no == ""){
        $out='';
        $out.='<center><font size="5">'.$lonev.' ???</font><br>
        <img name="nincsilyenlo" src="/themes/ugetomarine/nincsilyenlo.gif" width="400" height="400" border="0" usemap="#m_nincsilyenlo" alt=""><map name="m_nincsilyenlo">
<area shape="rect" coords="115,351,289,379" href="/" alt="" >
<area shape="rect" coords="158,313,246,336" href="/lovak" alt="" >
</map></center>
        ';
        print theme($block_v_page, $out);
        //header("location: /");
        return $ret;
    }
    if($hova=="normal"){
      //print "<br>normal";
        //megnezni van-e forma adat a FORMA tablaban ehhez a lohoz
        $vaneforma=0;
        $res_lovak=db_query("SELECT neve, ev, orszag, szine, neme FROM {lovak} WHERE no = :no", array(":no" => $no));
        //print "<br>select";
        if(count($res_lovak)>=1){
          foreach ($res_lovak as $record2) {  
            $lonev=$record2->neve;
            $ev=$record2->ev;
            $orszag=$record2->orszag;
            $szine=$record2->szine;
            $neme=$record2->neme;
          }
        }
        //print "<br>ev:".$ev;
        //return;
        $iloid=0;
        $res_lo=db_query("SELECT ILOID FROM {LO} WHERE SLONEV = :slonev", array(":slonev" => $lonev));
        $talalt=count($res_lo);
        
        if($talalt==1){
            foreach ($res_lo as $record3) {
              $iloid=$record3->ILOID;
              //_mailuzenet($lonev);
              //_mailuzenet($iloid);
            }  
        }
        //_mailuzenet($iloid);
        //FUTASOK KILISTAZASA NL KFT ADATBAZISABOL, kiveve azokat amik le vannak tiltva
        if($iloid!=0 && $iloid!=2877 && $iloid!=3339){
            //$res_forma=db_query("SELECT FDIJ FROM FORMA WHERE ILOID = '%d' && IFUTAMID!=0 && DTDATUM>'2000'", $iloid);
            $res_forma=db_query("SELECT ILOID FROM {LO} WHERE ILOID = :iloid", array(":iloid" => $iloid));
            if(count($res_forma)>0){
                $vaneforma=1;
            }
        }
        //print "<br>f:".$vaneforma;
        //if($lonev_no==8407){

header("location:/lovak/sablon/$lonev_no/$vaneforma/$iloid");
//$out.='v1';
            if($vaneforma==1){
               
                $out.="
                    &nbsp; &nbsp; &nbsp; ..<a href='http://195.228.135.95/php/uloforma.php?id=$iloid' title='Fut&aacute;sok versenyekben1' target='_new'>&nbsp; &nbsp; &nbsp; &nbsp; <img src='/themes/ugetomarine/futicon.jpg' border='0' alt='Fut&aacute;sok'></a>
                ";

            }

            $out.="</div>
               </td>
              </tr>
              <tr>
               <td></td>
              </tr>
            </table>
            ";


        //header("location: /lovak/sablon/".$lonev_no);
    }else{
     //   print "<br>lonev_no".$lonev_no;
        header("location: /lovak/adm/".$lonev_no);
        return;
    }
}else{
    //print "<br>nonisset lonev";
   // if($kateg=='norm_feddel'){
   //       $out=drupal_render(drupal_get_form('lokerfed_form'));
   // }else{
          $out = drupal_render(drupal_get_form('loker_form'));
   // }

}


return $out;
}

function lovak_cron() {
 $time = time();
 $hours =date("G",$time);
 
 
 //node-ban levo egy napnal regebbi pedigre es forma adatok rendszeres kigyomlalasa
 $res=db_query("DELETE FROM node WHERE changed < '$time'-3000000 && nid > 998000000 && nid < 999999998");
 $res=db_query("DELETE FROM node_revisions WHERE timestamp < '$time'-3000000 && nid > 998000000 && nid < 999999998");

 // automatikus adatátvétel NL.KFT-tõl......., ha jött új ló, akkor lovak_upgrd is indul.
// lovak_importalas();
 if($hours==3){
      lovak_importalas();
 }

if($hours==4){
 _syncFORMA();
 _synclovak();
 _syncLO();
}

 return;
}

function lovak_admfed($action="new"){
   global $no, $user;
   print "<br>LOVAKFED";

}

function lovak_teszt(){
   print "<br>LOVAKteszt";
   _synclovak();
   _syncFORMA();
   
return;
}



function lovak_adm($action="new"){
    global $no, $user;

    $out="";
    $err="";

    //print "<br>act:".$action;

    if($action=="mod"){
        loker("norm_feddel","mod","page");
        return;
    }

    if($action!="mod" && $action!="new"){
        $no=$action;
        $action="update";
    }
    

    //print_r($_POST);
    if(isset($_POST['szine'])){
        $szine=$_POST['szine'];
        $neme=$_POST['neme'];
        $lo_vagy_fed=$_POST['lo_vagy_fed'];
        $lonev=$_POST['lonev'];
        $sa=explode('--',$lonev);
        if(isset($sa['0'])){$lonev=$sa['0'];}else{$lonev="";}
        if(isset($sa['1'])){$ev=$sa['1'];}else{$ev="";}
        if(isset($sa['2'])){$orszag=$sa['2'];}else{$orszag="";}unset($sa);
        $egybevetes=$_POST['egybevetes'];
        $anyja=$_POST['lonev_anyja'];
        $sa=explode('--',$anyja);
        if(isset($sa['0'])){$anyja=$sa['0'];}else{$anyja="";}
        if(isset($sa['1'])){$anyja_ev=$sa['1'];}else{$anyja_ev="";}
        if(isset($sa['2'])){$anyja_orszag=$sa['2'];}else{$anyja_orszag="";}unset($sa);
        $apja=$_POST['lonev_apja'];
        $sa=explode('--',$apja);
        if(isset($sa['0'])){$apja=$sa['0'];}else{$apja="";}
        if(isset($sa['1'])){$apja_ev=$sa['1'];}else{$apja_ev="";}
        if(isset($sa['2'])){$apja_orszag=$sa['2'];}else{$apja_orszag="";}unset($sa);
        $rekord=$_POST['rekord'];
        $penz=$_POST['penz'];
        $ellet=$_POST['ellet'];
        $fedez=$_POST['fedez'];
        $belyeg=$_POST['belyeg'];
        $tulajdonos=$_POST['tulajdonos'];
        $tulajdonos_osszes=$_POST['tulajdonos_osszes'];
        $tuldat=$_POST['tuldat'];
        $nevel=$_POST['nevel'];
        $imp_orsz=$_POST['imp_orsz'];
        $imp_kelt=$_POST['imp_kelt'];
        $exp_orsz=$_POST['exp_orsz'];
        $exp_kelt=$_POST['exp_kelt'];
        $kimult_kelt=$_POST['kimult_kelt'];
        $kiherelve_kelt=$_POST['kiherelve_kelt'];
        $elozo=$_POST['elozo'];
        $fedezomen=$_POST['fedezomen'];
        $aktiv=$_POST['aktiv'];
        $loazon=$_POST['loazon'];
        $transzponder=$_POST['transzponder'];
        $ueln=$_POST['ueln'];
        //$utlevel=$_POST['utlevel'];
        $megjegyzes=$_POST['megjegyzes'];
        $szures=$_POST['szures'];
        
        
        if($szine=="0"){$szine=" ";}if($szine=="1"){$szine="f";}if($szine=="2"){$szine="f/sz";}if($szine=="3"){$szine="p";}if($szine=="4"){$szine="p/stp";}if($szine=="5"){$szine="p/vlp";}if($szine=="6"){$szine="s";}if($szine=="7"){$szine="stp";}if($szine=="8"){$szine="stp/f";}if($szine=="9"){$szine="stp/sz";}if($szine=="10"){$szine="sz";}if($szine=="11"){$szine="sz/stp";}if($szine=="12"){$szine="tarka";}if($szine=="13"){$szine="vlp";}
        if($neme=="0"){$neme=" ";}if($neme=="1"){$neme="m";}if($neme=="2"){$neme="k";}if($neme=="3"){$neme="h";}
        if($fedezomen=="0"){$fedezomen="NEM";}if($fedezomen=="1"){$fedezomen="IGEN";}
        if($aktiv=="0"){$aktiv="NEM";}if($aktiv=="1"){$aktiv="IGEN";}
        if($lo_vagy_fed=="0"){$lo_vagy_fed="LO";}
        if($lo_vagy_fed=="1"){$lo_vagy_fed="FEDEZTETES";}
        if($lo_vagy_fed=="2"){$lo_vagy_fed="SIKERTELEN FEDEZTETES";}
        if($lo_vagy_fed=="3"){$lo_vagy_fed="JELENTES NEM ERKEZETT";}
        if($lo_vagy_fed=="4"){$lo_vagy_fed="VETELT";}
        if($lo_vagy_fed=="5"){$lo_vagy_fed="HOLT ELLES";}
        if($lo_vagy_fed=="6"){$lo_vagy_fed="ELETKEPTELEN";}
        if($lo_vagy_fed=="7"){$lo_vagy_fed="IKREKET VETELT";}
         if($lo_vagy_fed=="8"){$lo_vagy_fed="XX OTA JELENTES NEM ERKEZETT";}
        
        
        $torles=$_POST['torles'];
        if(trim($lonev)==""){$err="nincs l&oacute; megadva";}
        //if(trim($anyja)==""){$err="nincs anyja megadva";}
        if($action=="update"){
        }else{
            db_query("SELECT * from lovak WHERE binary neve='%s' && ev='%d' && (orszag='%s' || orszag='') && lo_vagy_fed='LO'", $lonev,$ev,$orszag);
            if(db_affected_rows()>0){$err.="Van m&aacute;r ilyen nev&ucirc; l&oacute;".db_affected_rows().$lonev;}
        }
        if($err!="" && $torles=="0"){
            $out.=$err;
        }else{
            if($action=="update"){

                //HA AZ UTOLSO TULAJDONOST TOROLNI KELL
                if($torles=="2"){
                    db_query("DELETE FROM tulajdonos WHERE no='%d' ORDER BY datum DESC LIMIT 1", $no);
                    if(db_affected_rows()){
                        print "<br>torles $no :".db_affected_rows();
                    }
                }

                //HA A LOVAT TOROLNI KELL
                if($torles=="1"){
                    $out.=$lonev." T&Ouml;R&Ouml;LVE !!!";
                    db_query("DELETE FROM lovak WHERE no='%d'",$no);
                    db_query("DELETE FROM tulajdonos WHERE no='%d'",$no);
                }else{ //HA A LOVAT MODOSITANI KELL
                    //modositas datumanak beirasa
                    $mkt=gmdate("Y-m-d\TH:i:s\Z");

                    //begyûjteni a jelenlegi értékeket a VALTOZASNAPLO ba történõ bejegyzés miatt
                    $valtres=db_query("SELECT * FROM lovak WHERE no = '%d'", $no);
                    print db_affected_rows();
                    if(db_affected_rows()==1){
                       while($egysor_valtres = db_fetch_array($valtres)) {
                            $tulajdonos_r=$egysor_valtres['tulajdonos'];
                            $imp_orsz_r=$egysor_valtres['imp_orsz'];
                            $imp_kelt_r=$egysor_valtres['imp_kelt'];
                            $exp_orsz_r=$egysor_valtres['exp_orsz'];
                            $exp_kelt_r=$egysor_valtres['exp_kelt'];
                            $kimult_r=$egysor_valtres['kimult'];
                            $herel_r=$egysor_valtres['herel'];
                            //print "<br>tulaj:".$egysor_valtres['tulajdonos'];
                       } 
                    }
                    //print "<br>regi:".$tulajdonos_r.'-'.$imp_orsz_r.'-'.$imp_kelt_r.'-'.$exp_orsz_r.'-'.$exp_kelt_r.'-'.$kimult_r.'-'.$herel_r;                     
                    //print "<br>uj:".$tulajdonos.'-'.$imp_orsz.'-'.$imp_kelt.'-'.$exp_orsz.'-'.$exp_kelt.'-'.$kimult_kelt.'-'.$herelve_kelt;                     
                    //return;
                    $uservar=$user->name;
                    $out.=$lonev." m&oacute;dos&iacute;t&aacute;sa megt&ouml;rt&eacute;nt...";
                    db_query("UPDATE lovak
                             SET neve='%s', ev='%s', orszag='%s', szine='%s', neme='%s', anyja='%s', anyja_ev='%s', anyja_orszag='%s', apja='%s', apja_ev='%s', apja_orszag='%s', rekord='%s', penz='%d', fedez='%s', ellet='%s', belyeg='%s', tulajdonos='%s', nevel='%s', imp_orsz='%s', imp_kelt='%s', exp_orsz='%s', exp_kelt='%s', kimult='%s', herel='%s', elozo='%s', fedezomen='%s', aktiv='%s', egybevetes='%s', lo_vagy_fed='%s', updater='%s', updated_date='%s', loazon='%s', transzponder='%s', ueln='%s', megjegyzes='%s', szures='%s'
                             WHERE no='%d'",
                             $lonev,$ev,$orszag,$szine,$neme,$anyja,$anyja_ev,$anyja_orszag,$apja,$apja_ev,$apja_orszag,$rekord,$penz,$fedez,$ellet,$belyeg,$tulajdonos,$nevel,$imp_orsz,$imp_kelt,$exp_orsz,$exp_kelt,$kimult_kelt,$kiherelve_kelt,$elozo,$fedezomen,$aktiv,$egybevetes,$lo_vagy_fed,$uservar,$mkt,$loazon,$transzponder,$ueln,$megjegyzes,$szures,$no);

                    
                    
                     //VALTOZASNAPLO-ba beirás
                    
                    //ha változtak ezek a változók, csak akkor kell beírni a valtozasnaplo-ba
                    //if($tulajdonos != $tulajdonos_r || $imp_orsz != $imp_orsz_r || $exp_orsz != $exp_orsz_r || $kimult_r != $kimult_kelt || $herel_r != $kiherelve_kelt){
                    if($tulajdonos != $tulajdonos_r){
                      db_query("INSERT INTO valtozasnaplo (no, neve, tulajdonos) VALUES ('%d', '%s', '%s')", $no, $lonev, $tulajdonos);  
                    }
                    if($imp_orsz != $imp_orsz_r || $imp_kelt != $imp_kelt_r){
                      db_query("INSERT INTO valtozasnaplo (no, neve, imp_orsz, imp_kelt) VALUES ('%d', '%s', '%s', '%s')", $no, $lonev, $imp_orsz, $imp_kelt);  
                    }
                    if($exp_orsz != $exp_orsz_r || $exp_kelt != $exp_kelt_r){
                      db_query("INSERT INTO valtozasnaplo (no, neve, exp_orsz, exp_kelt) VALUES ('%d', '%s', '%s', '%s')", $no, $lonev, $exp_orsz, $exp_kelt);  
                    }
                    if($kimult_kelt != $kimult_r){
                      db_query("INSERT INTO valtozasnaplo (no, neve, kimult_kelt) VALUES ('%d', '%s', '%s')", $no, $lonev, $kimult_kelt);  
                    }
                    if($kiherelve_kelt != $kiherelve_r){
                      db_query("INSERT INTO valtozasnaplo (no, neve, kiherelve_kelt) VALUES ('%d', '%s', '%s')", $no, $lonev, $kiherelve_kelt);  
                    }
                                        
                
                    //tulajdonos táblába beírás modosításnál
                    if($tulajdonos != ''){
                    //db_query("SELECT * FROM tulajdonos WHERE no = '%d' && tulajdonos = '%s' ORDER BY datum LIMIT 1", $no, $tulajdonos);
                    $tulres=db_query("SELECT * FROM tulajdonos WHERE no = '%d' ORDER BY datum DESC LIMIT 1", $no, $tulajdonos);
                        while($egysor_tulres = db_fetch_array($tulres)) {
                            $tul=$egysor_tulres['tulajdonos'];
                        }
                        //if(db_affected_rows()==0){
                        if($tul != $tulajdonos){
                            db_query("INSERT INTO tulajdonos (no, tulajdonos, datum) VALUES ('%d', '%s', '%s')", $no, $tulajdonos, $tuldat);
                        }else{
                            //db_query("UPDATE tulajdonos SET tulajdonos='%s', datum='%d' WHERE no='%d' && tulajdonos='%s'", $lonev,$ev,$orszag,$szine,$neme,$anyja,$anyja_ev,$anyja_orszag,$apja,$apja_ev,$apja_orszag,$rekord,$penz,$ellet,$belyeg,$tulajdonos,$nevel,$imp_orsz,$imp_kelt,$elozo,$fedezomen,$egybevetes,$uservar,$mkt,$no);
                        }
                    }


                    //if($neme!="k" && $apja_ev != 0 && $apja_orszag != ""){
                    //  db_query("SELECT * FROM lovak WHERE apja = '$lonev'");
                    //  if(db_affected_rows()==1){
                    //      db_query("UPDATE lovak SET apja_ev='%s', apja_orszag='%s' WHERE apja = '%s'", $apja_ev, $apja_orszag, $apja);
                    //  }
                    //}
                }
            }else{
                $out.=$lonev." felvitele megt&ouml;rt&eacute;nt...";
                $mkt=gmdate("Y-m-d\TH:i:s\Z");
                $uservar=$user->name;
                db_query("INSERT INTO lovak (neve, ev, orszag, szine, neme, anyja, anyja_ev, anyja_orszag, apja, apja_ev, apja_orszag, rekord, penz, fedez, ellet, belyeg, tulajdonos, nevel, imp_orsz, imp_kelt, exp_orsz, exp_kelt, kimult, herel, elozo, fedezomen, aktiv, egybevetes, lo_vagy_fed, author, authored_date, loazon, transzponder, ueln, megjegyzes, szures)
                         VALUES ('%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s','%s', '%s', '%s', '%s', '%s', '%s','%s', '%s')",
                         $lonev,$ev,$orszag,$szine,$neme,$anyja,$anyja_ev,$anyja_orszag,$apja,$apja_ev,$apja_orszag,$rekord,$penz,$fedez,$ellet,$belyeg,$tulajdonos,$nevel,$imp_orsz,$imp_kelt,$exp_orsz,$exp_kelt,$kimult_kelt,$kiherelve_kelt,$elozo,$fedezomen,$aktiv,$egybevetes,$lo_vagy_fed,$uservar,$mkt,$loazon,$transzponder,$ueln,$megjegyzes,$szures);

                $no=mysql_insert_id();

                //tulajdonos táblába beírás újfelvitelnél
                if($tulajdonos != ''){
                    db_query("SELECT * FROM tulajdonos WHERE no = '%d' && tulajdonos = '%s'", $no, $tulajdonos);
                    if(db_affected_rows()==0){
                        db_query("INSERT INTO tulajdonos (no, tulajdonos, datum) VALUES ('%d', '%s', '%s')", $no, $tulajdonos, $tuldat);
                    }else{
                        //db_query("UPDATE tulajdonos SET tulajdonos='%s', datum='%d' WHERE no='%d' && tulajdonos='%s'", $lonev,$ev,$orszag,$szine,$neme,$anyja,$anyja_ev,$anyja_orszag,$apja,$apja_ev,$apja_orszag,$rekord,$penz,$ellet,$belyeg,$tulajdonos,$nevel,$imp_orsz,$imp_kelt,$elozo,$fedezomen,$egybevetes,$uservar,$mkt,$no);
                    }
                }
                
                 //valtozasnaploba beírás
                // db_query("INSERT INTO valtozasnaplo (no, neve) VALUES ('%d', '%s')", $no, $lonev);  
                 db_query("INSERT INTO valtozasnaplo (no, neve, tulajdonos, imp_orsz, imp_kelt, exp_orsz, exp_kelt, kimult, herel) VALUES ('%d', '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s')", $no, $lonev, $tulajdonos, $imp_orsz, $imp_kelt, $exp_orsz, $exp_kelt, $kimult_kelt, $kiherelve_kelt);  
                   
                
                
            }

        }
    }else{
        $out.=drupal_get_form('lovak_new_form');

    }
    print theme("page", $out);

return;
}


function lovak_menstat($listafajta="apara"){

//print "<br>LISTAMENSTAT";
$param="Apam&eacute;n-statisztika (Magyarorsz&aacute;gon sz&uuml;letett lovakra)<br><br><br>";

    if((isset($_POST['apja']) && $_POST['apja']!='') || (isset($_POST['evad']) && $_POST['evad']!='')){
        if($listafajta == "apara"){
            $apja_szulev_nemzet=$_POST['apja'];
            $sa=explode('--',$apja_szulev_nemzet);
            //print $sa['0'];
            $apja=$sa['0'];
            $apjaker=preg_replace("/'/","\'",$apja);
            $apja_ev=$sa['1'];
            // Men szarmazasi lapja miatt kell a lovak/no azonositoo//////////////////////////////
            $apja_link=0;
            $res_apja_link=db_query("SELECT no FROM lovak WHERE neve = '$apjaker' && ev = '$apja_ev' && lo_vagy_fed='LO'");
            if(db_affected_rows()==1){
                while($egysor_apja_link = db_fetch_array($res_apja_link)) {
                    $apja_link=$egysor_apja_link['no'];
                }
            }       
            $param.="<a href='/lovak/sablon/$apja_link'><font size='3' color='black' ><b>".$apja."</b></font></a> &nbsp;ivad&eacute;kai";
            $apja=preg_replace("/'/","\'",$apja);
            //$evad=$_POST['evad'];
            $rekord=$_POST['rekord'];
            //$rekord=substr($rekord,0,4).substr($rekord,5,1);
            
            //ÖSSZES IVADÉK LEKÉRÉSE/////////////////////////////////////////////////////////////////////////
            $res_ossz=db_query("SELECT ev, neve, COUNT(neve) AS ossz FROM lovak WHERE apja = '$apja' && apja_ev = '$apja_ev' && orszag = 'HU' && lo_vagy_fed='LO' GROUP BY ev");
            if(db_affected_rows()<1){
                $out.="Nincs eredm&eacute;nye a list&aacute;nak";
            }else{
                //print db_affected_rows();
                $out.="".$param."<table class='varilista'><tr>";
                $out.="<td>&eacute;vj&aacute;rat</td><td>&ouml;ssz</td><td>futott</td><td>'$rekord' alatt</td><td>teny&eacute;szt&eacute;sbe &aacute;ll&iacute;tva - l&aacute;nya(i)</td>";
                $out.="</tr>";
                $ossz_sum=0;
                $futott_sum=0;
                $alatti_sum=0;
                $teny_sum=0;
                while($egysor = db_fetch_array($res_ossz)) {
                    //print "<br>";
                    //print_r($egysor);
                    $out.="<tr class='varilista'>";
                    $out.="<td>".$egysor['ev']."</td>";
                    $ev=$egysor['ev'];
                    $out.="<td>".$egysor['ossz']."</td>";   
                    $ossz_sum+=$egysor['ossz'];
                    //FUTOTT IVADÉKOK LEKÉRÉSE $egysor['ev'] ÉVJÁRATRA////////////////////////////////////////////////////////
                    $res_futott=db_query("SELECT ev, COUNT(neve) AS futott FROM lovak WHERE ev = '$ev' && apja = '$apja' && apja_ev = '$apja_ev' && rekord > 0 && orszag = 'HU' && lo_vagy_fed='LO' GROUP BY ev");
                    if(db_affected_rows()){
                        //print '<br>';
                        while($egysor_futott = db_fetch_array($res_futott)) {
                            //print '<br>';
                            //print_r($egysor_futott);
                            $out.="<td>".$egysor_futott['futott']."</td>";
                            $futott_sum+=$egysor_futott['futott'];
                        }
                    }else{
                        $out.="<td>-</td>"; 
                    }
                    //REKORD ALATTI IVADÉKOK LEKÉRÉSE $egysor['ev'] ÉVJÁRATRA/////////////////////////////////////////////////
                    $res_alatti=db_query("SELECT ev, COUNT(neve) AS alatti FROM lovak WHERE ev = '$ev' && apja = '$apja' && apja_ev = '$apja_ev' && rekord > 0 && rekord < '$rekord' && orszag = 'HU' && lo_vagy_fed='LO' GROUP BY ev");
                    if(db_affected_rows()){
                        while($egysor_alatti = db_fetch_array($res_alatti)) {
                            $out.="<td>".$egysor_alatti['alatti']."</td>";
                            $alatti_sum+=$egysor_alatti['alatti'];
                        }
                    }else{
                        $out.="<td>-</td>"; 
                    }
                    //TENYESZTESBE ALLITOTT IVADEKOK $egysor['ev'] ÉVJÁRATRA/////////////////////////////////////////////////
                    
                    
                    $res_teny=db_query("SELECT DISTINCT l1.neve AS teny 
                    FROM lovak AS l1 
                    INNER JOIN lovak AS l2 ON l1.neve = l2.anyja && l1.ev = l2.anyja_ev 
                    WHERE l1.ev = '$ev' && l1.apja = '$apja' && l1.apja_ev = '$apja_ev' && l2.anyja_orszag = 'HU' && l1.lo_vagy_fed='LO'
                    ");
    
                    
                    ////$res_teny=db_query("SELECT l1.ev, COUNT(l1.neve) AS teny FROM lovak AS l1 INNER JOIN lovak AS l2 ON l1.neve = l2.anyja && l1.ev = l2.anyja_ev WHERE l1.ev = '$ev' && l1.apja = '$apja' && l1.apja_ev = '$apja_ev' GROUP BY l1.ev");
                    //SELECT l1.ev, COUNT( l1.neve ) AS teny FROM lovak AS l1 INNER JOIN lovak AS l2 ON l1.neve = l2.anyja && l1.ev = l2.anyja_ev WHERE l1.apja = 'Dale Lobell' GROUP BY l1.ev
                    if(db_affected_rows()){
                        $out.="<td>";
                        while($egysor_teny = db_fetch_array($res_teny)) {
                            $out.=$egysor_teny['teny'].", ";
                            $teny_sum++;
                        }
                        $out.="</td>";
                    }else{
                        $out.="<td>-</td>"; 
                    }
                    
                }
                $out.="<tr><td>&ouml;ssz.</td><td>".$ossz_sum."</td><td>".$futott_sum."</td><td>".$alatti_sum."</td><td>".$teny_sum."</td></tr></table>";
                //print $out;
            }
        }
        if($listafajta == "evjaratra"){
            $evjarat=$_POST['evad'];
            $param.="$evjarat -ben sz&uuml;letett lovak apam&eacute;n-statisztik&aacute;ja";        
            $rekord=$_POST['rekord'];
            //ÖSSZES IVADÉK LEKÉRÉSE/////////////////////////////////////////////////////////////////////////
            $res_ossz=db_query("SELECT ev, apja, apja_ev, COUNT(neve) AS ossz FROM lovak WHERE ev = '$evjarat' && orszag = 'HU' && lo_vagy_fed='LO' GROUP BY apja, apja_ev");
            if(db_affected_rows()<1){
                $out.="Nincs eredm&eacute;nye a list&aacute;nak";
            }else{                                                    
                //print db_affected_rows();
                $out.="".$param."<table class='varilista'><tr>";
                $out.="<td>apam&eacute;n</td><td>&ouml;ssz</td><td>futott</td><td>'$rekord' alatt</td><td>teny&eacute;szt&eacute;sbe &aacute;ll&iacute;tva - l&aacute;nya(i)</td>";
                $out.="</tr>";
                $ossz_sum=0;
                $futott_sum=0;
                $alatti_sum=0;
                $teny_sum=0;
                while($egysor = db_fetch_array($res_ossz)) {
                    //print "<br>";
                    //print_r($egysor); 
                    $out.="<tr class='varilista'>";
                    $apja=$egysor['apja'];
                    $apjaprint=$egysor['apja'];
                    $apja_ev=$egysor['apja_ev'];
                    $apja=preg_replace("/'/","\'",$apja);
                        // Men szarmazasi lapja miatt kell a lovak/no azonositoo//////////////////////////////
                        $apja_link=0;
                        $res_apja_link=db_query("SELECT no FROM lovak WHERE neve = '$apja' && ev = '$apja_ev' && lo_vagy_fed='LO'");
                        if(db_affected_rows()==1){
                            while($egysor_apja_link = db_fetch_array($res_apja_link)) {
                                $apja_link=$egysor_apja_link['no'];
                            }
                        }
                        $apjalink="<a href='/lovak/sablon/$apja_link'><font size='2' color='black' ><b>".$apjaprint."</b></font></a>";

                    $out.="<td>".$apjalink."</td>";
                    $apja_ev=$egysor['apja_ev'];
                    $out.="<td>".$egysor['ossz']."</td>";   
                    $ossz_sum+=$egysor['ossz'];
                    //FUTOTT IVADÉKOK LEKÉRÉSE $egysor['apja'] -RA////////////////////////////////////////////////////////
                    $res_futott=db_query("SELECT COUNT(neve) AS futott FROM lovak WHERE ev = '$evjarat' && apja = '$apja' && apja_ev = '$apja_ev' && rekord > 0 && orszag = 'HU' && lo_vagy_fed='LO'");
                    if(db_affected_rows()){
                        //print '<br>';
                        while($egysor_futott = db_fetch_array($res_futott)) {
                            //print '<br>';
                            //print_r($egysor_futott);
                            $out.="<td>".$egysor_futott['futott']."</td>";
                            $futott_sum+=$egysor_futott['futott'];
                        }
                    }else{
                        $out.="<td>-</td>";
                    }
                    //REKORD ALATTI IVADÉKOK LEKÉRÉSE $egysor['ev'] ÉVJÁRATRA/////////////////////////////////////////////////
                    $res_alatti=db_query("SELECT COUNT(neve) AS alatti FROM lovak WHERE ev = '$evjarat' && apja = '$apja' && apja_ev = '$apja_ev' && rekord > 0 && rekord < '$rekord' && orszag = 'HU' && lo_vagy_fed='LO'");
                    if(db_affected_rows()){
                        while($egysor_alatti = db_fetch_array($res_alatti)) {
                            $out.="<td>".$egysor_alatti['alatti']."</td>";
                            $alatti_sum+=$egysor_alatti['alatti'];
                        }
                    }else{
                        $out.="<td>-</td>";
                    }
                    //TENYESZTESBE ALLITOTT IVADEKOK $egysor['ev'] ÉVJÁRATRA/////////////////////////////////////////////////


                    $res_teny=db_query("SELECT DISTINCT l1.neve AS teny 
                    FROM lovak AS l1
                    INNER JOIN lovak AS l2 ON l1.neve = l2.anyja && l1.ev = l2.anyja_ev
                    WHERE l1.ev = '$evjarat' && l1.apja = '$apja' && l1.apja_ev = '$apja_ev' && l1.lo_vagy_fed='LO'
                    ");
    
                    
                    ////$res_teny=db_query("SELECT l1.ev, COUNT(l1.neve) AS teny FROM lovak AS l1 INNER JOIN lovak AS l2 ON l1.neve = l2.anyja && l1.ev = l2.anyja_ev WHERE l1.ev = '$ev' && l1.apja = '$apja' && l1.apja_ev = '$apja_ev' GROUP BY l1.ev");
                    //SELECT l1.ev, COUNT( l1.neve ) AS teny FROM lovak AS l1 INNER JOIN lovak AS l2 ON l1.neve = l2.anyja && l1.ev = l2.anyja_ev WHERE l1.apja = 'Dale Lobell' GROUP BY l1.ev
                    if(db_affected_rows()){
                        $out.="<td>";
                        while($egysor_teny = db_fetch_array($res_teny)) {
                            $out.=$egysor_teny['teny'].", ";    
                            $teny_sum++;
                        }
                        $out.="</td>";
                    }else{
                        $out.="<td>-</td>";
                    }
                    
                }
                $out.="<tr><td>&ouml;ssz.</td><td>".$ossz_sum."</td><td>".$futott_sum."</td><td>".$alatti_sum."</td><td>".$teny_sum."</td></tr></table>";
                //print $out;
            }
        }
    }else{
        
        
        if($listafajta == "apara"){
            $out.=drupal_get_form('menstat_form_apara');
        }
        if($listafajta == "evjaratra"){
            $out.=drupal_get_form('menstat_form_evjaratra');
        }
    //  $out.=drupal_get_form('lista_variforma_form');
        print theme("page", $out);
        return;
    }
    $changed=time();
    $nidvege=substr(strval($changed),-2);
    $nidbe='9999000'.$nidvege;
    db_query("SELECT * FROM node WHERE nid='$nidbe'");
    if(db_affected_rows()==0){
        db_query("INSERT INTO node (nid, vid) VALUES ('%d', '%d')", $nidbe, $nidbe);
        db_query("INSERT INTO node_revisions (nid, vid) VALUES ('%d','%d')", $nidbe, $nidbe);
    }

    db_query("UPDATE node SET changed='%s',uid = '1', title='%s' where nid='$nidbe'", $changed, 'Lista');
    db_query("UPDATE node_revisions SET body='%s', teaser='%s', uid = '1', timestamp='%s' where nid='$nidbe'", $out, $out, $changed);
    header("location:/node/".$nidbe);
    return;
return;
}
function lovak_listaforma(){

    $param="Lista:<br>";            
    if(isset($_POST['evad']) && $_POST['evad']!=0){
            $evad=$_POST['evad'];
            $rekord=$_POST['rekord'];
            $rekord=conv_ug2nl($rekord);
            $rek=$rekord;
            $order='rekord';
            if($_POST['rendezes']==0){
                $order='rekord';
            }
            if($_POST['rendezes']==1){
                $order='lonev';
            }
            if($_POST['rendezes']==2){
                $order='apnev';
            }
            if($_POST['rendezes']==3){
                $order='orszag';
            }
            //print $_POST['rendezes'];
            $rekord=substr($rekord,0,4).substr($rekord,5,1);
            
            //print $order;
            $param.=" ".$evad."-&eacute;vben ";
            if($rekord!=""){
                $param.=" ".$rek." alatt";
                $rekord_condition="&& concat(substring(FORMA.SKORATLAG,1,4),substring(FORMA.SKORATLAG,6,1))< '$rekord'";
            }else{
                $rekord_condition="&& TRUE";
            }
            //&& concat(substring(FORMA.SKORATLAG,1,4),substring(FORMA.SKORATLAG,6,1))< '$rekord'
                                         
            $lista_res=db_query("SELECT lovak.orszag as orszag, lovak.neve, lovak.apja, LO.ILOID, LO.SLONEV as lonev,
                                 APLO.SLONEV as apnev,
                                 FORMA.DTDATUM, FORMA.FDIJ, MIN(FORMA.SKORATLAG) as rekord
                                    from FORMA, LO
                                       LEFT JOIN LO as APLO
                                       ON APLO.ILOID = LO.IAPAID
                                       LEFT JOIN lovak
                                       ON LO.SLONEV = lovak.neve
                                          WHERE LO.ILOID=FORMA.ILOID
                                             && left(FORMA.DTDATUM,4)='$evad'
                                             && FORMA.SKORATLAG > 0 
                                             ".$rekord_condition."
                                             && IFUTAMID!=0 && FORMA.SKORATLAG >= LO.SREKORD_RT
                                               GROUP BY LO.SLONEV
                                                 ORDER BY ".$order);
               
            $param.="<br>";
            //$out.=db_affected_rows();
            if(db_affected_rows()<1){
                $out.="Nincs eredm&eacute;nye a list&aacute;nak";
            }else{
                $out.="<b>".$param."</b><br><table class='varilista'><tr>";
                $out.="<td><b>L&oacute; neve</b></td><td>Rekord</td><td>Apa</td><td>Orsz.</td>";
                $out.="</tr>";
                while($egysor = db_fetch_array($lista_res)) {
                    $out.="<tr class='varilista'>";
                    $out.="<td><b>".$egysor['lonev']."</b></td>";
                    $out.="<td>".conv_nl2ug($egysor['rekord'])."</td>";
                    $out.="<td>".$egysor['apnev']."</td>";
                    //$orsz=_orszag($egysor['lonev'],$egysor['apnev'],$evad);
                    $out.="<td>".$egysor['orszag']."</td>";  
                }
                $out.="</tr></table>";
            }
        }else{
            $out.=drupal_get_form('lista_variforma_form');
            print theme("page", $out);
            return;
        }
            

    $changed=time();
    $nidvege=substr(strval($changed),-2);
    $nidbe='9999000'.$nidvege;
    db_query("SELECT * FROM node WHERE nid='$nidbe'");
    if(db_affected_rows()==0){
        db_query("INSERT INTO node (nid, vid) VALUES ('%d', '%d')", $nidbe, $nidbe);
        db_query("INSERT INTO node_revisions (nid, vid) VALUES ('%d','%d')", $nidbe, $nidbe);
    }

    db_query("UPDATE node SET changed='%s',uid = '1', title='%s' where nid='$nidbe'", $changed, 'Lista');
    db_query("UPDATE node_revisions SET body='%s', teaser='%s', uid = '1', timestamp='%s' where nid='$nidbe'", $out, $out, $changed);
    header("location:/node/".$nidbe);
    return;
}
function _orszag($lonev, $apnev, $ev){
   $orszag="";
   //print "<br>".$lonev.$apnev.$ev;
   $apnevker=preg_replace("/'/","\'",$apnev);
   $lonevker=preg_replace("/'/","\'",$lonev);
   $lista_res=db_query("SELECT neve, apja, ev, orszag FROM lovak WHERE neve='$lonevker' && apja='$apnevker'");
   if(db_affected_rows()<1){
      $orszag="nincs ilyen l&oacute; (UTOE adatb&aacute;zisban)";
   }
   while($egysor = db_fetch_array($lista_res)) {
      $orszag=$egysor['orszag'];
      if($orszag==""){
         $orszag="nincs megadva orsz&aacute;g (UTOE adatb&aacute;zisban)";
      }
   }
return $orszag;  
}

function lovak_listaujlovak(){

    $param="Lista:<br>";
    if(isset($_POST['evho']) && $_POST['evho']!=0){
            $evho=$_POST['evho'];

            $param.=" ".$evho."";
                $lista_res=db_query("SELECT no, neve, apja, anyja, author, authored_date FROM lovak WHERE left(authored_date,7)='$evho' && lo_vagy_fed='LO' ORDER BY authored_date");
                    
            $param.="<br>";
            if(db_affected_rows()<1){
                $out.="Nincs eredm&eacute;nye a list&aacute;nak";
            }else{
                $out.="<b>".$param."</b><br><table class='varilista'><tr>";
                $out.="<td>L&oacute; neve</td><td>Apja</td><td>Anyja</td><td>Szerz&otilde;</td><td>Felvitel id&otilde;pontja</td>";
                $out.="</tr>";
                while($egysor = db_fetch_array($lista_res)) {
                    $no=$egysor['no'];
                    $out.="<tr class='varilista'>";
                    $out.="<td><b><a href='/lovak/sablon/$no'>".$egysor['neve']."</a></b></td>";
                    $out.="<td><b>".$egysor['apja']."</b></td>";
                    $out.="<td><b>".$egysor['anyja']."</b></td>";
                    $out.="<td><b>".$egysor['author']."</b></td>";
                    $out.="<td><b>".$egysor['authored_date']."</b></td>";
                }
                $out.="</tr></table>";
            }
        }else{
            $out.=drupal_get_form('lista_ujlovak_form');
            print theme("page", $out);
            return;
        }
            

    $changed=time();
    $nidvege=substr(strval($changed),-2);
    $nidbe='9999000'.$nidvege;
    db_query("SELECT * FROM node WHERE nid='$nidbe'");
    if(db_affected_rows()==0){
        db_query("INSERT INTO node (nid, vid) VALUES ('%d', '%d')", $nidbe, $nidbe);
        db_query("INSERT INTO node_revisions (nid, vid) VALUES ('%d','%d')", $nidbe, $nidbe);
    }

    db_query("UPDATE node SET changed='%s', uid = '1', title='%s' where nid='$nidbe'", $changed, 'Lista');
    db_query("UPDATE node_revisions SET body='%s', teaser='%s', uid = '1', timestamp='%s' where nid='$nidbe'", $out, $out, $changed);
    header("location:/node/".$nidbe);
    return;
}

function lovak_listamodlovak(){

    $param="Lista:<br>";
    if(isset($_POST['evho']) && $_POST['evho']!=0){
            $evho=$_POST['evho'];

            $param.=" ".$evho."";
                $lista_res=db_query("SELECT no, neve, apja, anyja, updater, updated_date FROM lovak WHERE left(updated_date,7)='$evho' && lo_vagy_fed='LO' ORDER BY updated_date");

            $param.="<br>";
            if(db_affected_rows()<1){
                $out.="Nincs eredm&eacute;nye a list&aacute;nak";
            }else{
                $out.="<b>".$param."</b><br><table class='varilista'><tr>";
                $out.="<td>L&oacute; neve</td><td>Apja</td><td>Anyja</td><td>M&oacute;dos&iacute;totta</td><td>M&oacute;dos&iacute;t&aacute;s id&otilde;pontja</td>";
                $out.="</tr>";
                while($egysor = db_fetch_array($lista_res)) {
                    $no=$egysor['no'];
                    $out.="<tr class='varilista'>";
                    $out.="<td><b><a href='/lovak/sablon/$no'>".$egysor['neve']."</a></b></td>";
                    $out.="<td><b>".$egysor['apja']."</b></td>";
                    $out.="<td><b>".$egysor['anyja']."</b></td>";
                    $out.="<td><b>".$egysor['updater']."</b></td>";
                    $out.="<td><b>".$egysor['updated_date']."</b></td>";
                }
                $out.="</tr></table>";
            }
        }else{
            $out.=drupal_get_form('lista_modlovak_form');
            print theme("page", $out);
            return;
        }
            

    $changed=time();
    $nidvege=substr(strval($changed),-2);
    $nidbe='9999000'.$nidvege;
    db_query("SELECT * FROM node WHERE nid='$nidbe'");
    if(db_affected_rows()==0){
        db_query("INSERT INTO node (nid, vid) VALUES ('%d', '%d')", $nidbe, $nidbe);
        db_query("INSERT INTO node_revisions (nid, vid) VALUES ('%d','%d')", $nidbe, $nidbe);
    }

    db_query("UPDATE node SET changed='%s', uid = '1', title='%s' where nid='$nidbe'", $changed, 'Lista');
    db_query("UPDATE node_revisions SET body='%s', teaser='%s', uid = '1', timestamp='%s' where nid='$nidbe'", $out, $out, $changed);
    header("location:/node/".$nidbe);
    return;
}

function lovak_listabekerult(){
    $param="Lista: V&aacute;ltoz&aacute;sok<br>";
    if(isset($_POST['evho']) && $_POST['evho']!=0){
            $evho=$_POST['evho'];$year=substr($evho,0,4);$month=substr($evho,5,2);$param.=" ".$evho."";
            //BEKERULT LOVAK
              
            $lista_res=db_query("SELECT valtozasnaplo.neve as vneve, lovak.apja as apja, lovak.anyja as anyja, valtozasnaplo.timestamp as datum FROM valtozasnaplo
            INNER JOIN lovak ON lovak.no = valtozasnaplo.no
            WHERE left(valtozasnaplo.timestamp,7)='$evho' GROUP BY vneve ORDER BY vneve");
             
            $param.="<br>";
            if(db_affected_rows()<1){
                $out.="<br>Nincs eredm&eacute;nye az Ujonan bekerult list&aacute;nak";
            }else{
                $out.="<b>".$param."</b><br>";
                $out.="&Uacutejonan bekerult lovak<br>";
                $out.="<table class='varilista'><tr>";
                $out.="<td>L&oacute; neve</td><td>Apja</td><td>Anyja</td><td>Rogzitve</td>";
                while($egysor = db_fetch_array($lista_res)) { 
                  $out.="</tr>";
                  $out.="<tr>";
                  $out.="<td><b>".$egysor['vneve']."</b></td>"."<td>".$egysor['apja']."</td>"."<td>".$egysor['anyja']."</td>"."<td>".$egysor['datum']."</td>";
                }           
                $out.="</tr></table>";
            }
            //EXPORT
            $lista_res=db_query("SELECT valtozasnaplo.neve as vneve, lovak.apja as apja, lovak.anyja as anyja, valtozasnaplo.timestamp as datum,
            valtozasnaplo.exp_orsz as exporsz, valtozasnaplo.exp_kelt as expkelt FROM valtozasnaplo
            INNER JOIN lovak ON lovak.no = valtozasnaplo.no
            WHERE valtozasnaplo.tulajdonos = '' && valtozasnaplo.imp_orsz = '' && valtozasnaplo.imp_kelt = ''  && valtozasnaplo.exp_orsz != '' && valtozasnaplo.exp_kelt != ''
            && valtozasnaplo.kimult = '' && valtozasnaplo.herel = '' && left(valtozasnaplo.timestamp,7)='$evho' ORDER BY datum");
            $param.="<br>";
            if(db_affected_rows()<1){
                $out.="<br>Nincs eredm&eacute;nye az Export list&aacute;nak";
            }else{
                $out.="<br>";
                $out.="Export<br>";
                $out.="<table class='varilista'><tr>";
                $out.="<td>L&oacute; neve</td><td>Apja</td><td>Anyja</td><td>EXP orsz</td><td>EXP kelt</td><td>Rogzitve</td>";
                while($egysor = db_fetch_array($lista_res)) { 
                  $out.="</tr>";
                  $out.="<tr>";
                  $out.="<td>".$egysor['vneve']."</td>"."<td>".$egysor['apja']."</td>"."<td>".$egysor['anyja']."</td>"."<td><b>".$egysor['exporsz']."</b></td>"."<td><b>".$egysor['expkelt']."</b></td>"."<td>".$egysor['datum']."</td>";
                }           
                $out.="</tr></table>";
            }
            //IMPORT
            $lista_res=db_query("SELECT valtozasnaplo.neve as vneve, lovak.apja as apja, lovak.anyja as anyja, valtozasnaplo.timestamp as datum,
            valtozasnaplo.imp_orsz as imporsz, valtozasnaplo.imp_kelt as impkelt FROM valtozasnaplo
            INNER JOIN lovak ON lovak.no = valtozasnaplo.no
            WHERE valtozasnaplo.tulajdonos = '' && valtozasnaplo.imp_orsz != '' && valtozasnaplo.imp_kelt != ''  && valtozasnaplo.exp_orsz = '' && valtozasnaplo.exp_kelt = ''
            && valtozasnaplo.kimult = '' && valtozasnaplo.herel = '' && left(valtozasnaplo.timestamp,7)='$evho' ORDER BY datum");
            $param.="<br>";
            if(db_affected_rows()<1){
                $out.="<br>Nincs eredm&eacute;nye az Import list&aacute;nak";
            }else{
                $out.="<br>";
                $out.="Import<br>";
                $out.="<table class='varilista'><tr>";
                $out.="<td>L&oacute; neve</td><td>Apja</td><td>Anyja</td><td>IMP orsz</td><td>IMP kelt</td><td>Rogzitve</td>";
                while($egysor = db_fetch_array($lista_res)) { 
                  $out.="</tr>";
                  $out.="<tr>";
                  $out.="<td>".$egysor['vneve']."</td>"."<td>".$egysor['apja']."</td>"."<td>".$egysor['anyja']."</td>"."<td><b>".$egysor['imporsz']."</b></td>"."<td><b>".$egysor['impkelt']."</b></td>"."<td>".$egysor['datum']."</td>";
                }           
                $out.="</tr></table>";
            }
            //TULAJDONOS
            $lista_res=db_query("SELECT valtozasnaplo.neve as vneve, lovak.apja as apja, lovak.anyja as anyja, valtozasnaplo.timestamp as datum,
            valtozasnaplo.tulajdonos as tulajdonos FROM valtozasnaplo
            INNER JOIN lovak ON lovak.no = valtozasnaplo.no
            WHERE valtozasnaplo.tulajdonos != '' && valtozasnaplo.imp_orsz = '' && valtozasnaplo.imp_kelt = ''  && valtozasnaplo.exp_orsz = '' && valtozasnaplo.exp_kelt = ''
            && valtozasnaplo.kimult = '' && valtozasnaplo.herel = '' && left(valtozasnaplo.timestamp,7)='$evho' ORDER BY datum");
            $param.="<br>";
            if(db_affected_rows()<1){
                $out.="<br>Nincs eredm&eacute;nye az Tulajdonosvaltozas list&aacute;nak";
            }else{
                $out.="<br>";
                $out.="Tulajdonosv&aacute;ltoz&aacute;s<br>";
                $out.="<table class='varilista'><tr>";
                $out.="<td>L&oacute; neve</td><td>Apja</td><td>Anyja</td><td>Tulajdonos</td><td>Rogzitve</td>";
                while($egysor = db_fetch_array($lista_res)) { 
                  $out.="</tr>";
                  $out.="<tr>";
                  $out.="<td>".$egysor['vneve']."</td>"."<td>".$egysor['apja']."</td>"."<td>".$egysor['anyja']."</td>"."<td><b>".$egysor['tulajdonos']."</b></td>"."<td>".$egysor['datum']."</td>";
                }           
                $out.="</tr></table>";
            }
            
            
            
            
            
    }else{$out.=drupal_get_form('lista_modtullovak_form');print theme("page", $out);return;
    }



    $changed=time();
    $nidvege=substr(strval($changed),-2);
    $nidbe='9999000'.$nidvege;
    db_query("SELECT * FROM node WHERE nid='$nidbe'");
    if(db_affected_rows()==0){
        db_query("INSERT INTO node (nid, vid) VALUES ('%d', '%d')", $nidbe, $nidbe);
        db_query("INSERT INTO node_revisions (nid, vid) VALUES ('%d','%d')", $nidbe, $nidbe);
    }

    db_query("UPDATE node SET changed='%s', uid = '1', title='%s' where nid='$nidbe'", $changed, 'Lista');
    db_query("UPDATE node_revisions SET body='%s', teaser='%s', uid = '1', timestamp='%s' where nid='$nidbe'", $out, $out, $changed);
    header("location:/node/".$nidbe);
    return; 
}  

function lovak_listamodtullovak(){
    $param="Lista: lovak tulajdonosvaltozasai<br>";
    if(isset($_POST['evho']) && $_POST['evho']!=0){
            $evho=$_POST['evho'];
            $year=substr($evho,0,4);
            $month=substr($evho,5,2);
            $param.=" ".$evho."";
            $lista_res=db_query("SELECT lovak.no as no, lovak.neve as neve, tulajdonos.tulajdonos as tulaj, tulajdonos.datum as datum FROM lovak, tulajdonos
            WHERE lovak.no=tulajdonos.no && year(tulajdonos.datum) = '$year' && month(tulajdonos.datum) = '$month' && lovak.lo_vagy_fed='LO'");
            $param.="<br>";
            if(db_affected_rows()<1){
                $out.="Nincs eredm&eacute;nye a list&aacute;nak";
            }else{
                $out.="<b>".$param."</b><br><table class='varilista'><tr>";
                $out.="<td>L&oacute; neve</td><td>Tulajdonos</td><td>M&oacute;dos&iacute;t&aacute;s id&otilde;pontja</td>";
                $out.="</tr>";
                while($egysor = db_fetch_array($lista_res)) {
                    $no=$egysor['no'];
                    $ue_tul_res=db_query("SELECT no, tulajdonos, datum FROM tulajdonos WHERE no='$no' ORDER BY datum DESC");
                    while($ue_egysor = db_fetch_array($ue_tul_res)) {
                        $sz=0;
                        if(db_affected_rows($ue_tul_res)>1){
                            $ue_tul=$ue_egysor['tulajdonos'];
                            $ue_tul_datum=$ue_egysor['datum'];
                            if($sz==1){
                                break;
                            }
                        }else{
                            $ue_tul='';
                            $ue_tul_datum='';
                        }
                        $sz++;
                    }
                    $out.="<tr class='varilista'>";
                    $out.="<td><b>".$egysor['neve']."</b></td>";
                    if($ue_tul=='' || $ue_tul == $egysor['tulaj']){
                        $out.="<td><b>".$egysor['tulaj']."</b></td>";
                    }else{
                        $out.="<td><b>".$egysor['tulaj']."</b> /elozo:".$ue_tul."/</td>";
                    }
                    $out.="<td><b>".$egysor['datum']."</b></td>";
                }
                $out.="</tr></table>";
            }
        }else{
            $out.=drupal_get_form('lista_modtullovak_form');
            print theme("page", $out);
            return;
        }


    $changed=time();
    $nidvege=substr(strval($changed),-2);
    $nidbe='9999000'.$nidvege;
    db_query("SELECT * FROM node WHERE nid='$nidbe'");
    if(db_affected_rows()==0){
        db_query("INSERT INTO node (nid, vid) VALUES ('%d', '%d')", $nidbe, $nidbe);
        db_query("INSERT INTO node_revisions (nid, vid) VALUES ('%d','%d')", $nidbe, $nidbe);
    }

    db_query("UPDATE node SET changed='%s', uid = '1', title='%s' where nid='$nidbe'", $changed, 'Lista');
    db_query("UPDATE node_revisions SET body='%s', teaser='%s', uid = '1', timestamp='%s' where nid='$nidbe'", $out, $out, $changed);
    header("location:/node/".$nidbe);
    return;
}



function lovak_importalas(){
   //START melyik volt az utolsó versenynap NÁLUNK ??? /////////////////////////////////////////////////
  $resn=mysql_query("SELECT DTDATUM FROM FORMA WHERE IFUTAMID <> 0 ORDER BY DTDATUM DESC LIMIT 1");
  while($egysorn=mysql_fetch_row($resn)){
    foreach($egysorn as $k => $v){
      $utdate_nalunk.=$v;
    }
    //$str.="<br>";
  }
  print "<br>Utolsó versenynap n:".$utdate_nalunk;
  //END melyik volt az utolsó versenynap NÁLUNK ??? /////////////////////////////////////////////////

  
  //START melyik volt az utolsó versenynap az NL nél??? /////////////////////////////////////////////////
  db_set_active('nl');
  $resnl=mysql_query("SELECT DTDATUM FROM INT_FORMA WHERE IFUTAMID <> 0 AND IHELYEZES <> 0 ORDER BY DTDATUM DESC LIMIT 1");
  while($egysor=mysql_fetch_row($resnl)){
    foreach($egysor as $k => $v){
      $utdate_nl.=$v;
    }
    //$str.="<br>";
  }
  print "<br>Utolsó versenynap nl:".$utdate_nl;
  //END melyik volt az utolsó versenynap az NL nél??? /////////////////////////////////////////////////
  
  //START a különbözetet insertelni a SAJÁT -ba //////////////////////////////////////////////
  $resnl=mysql_query("SELECT IFORMAID, IFUTAMID, DTDATUM, ILOID, ITAV, IHELYEZES, FDIJ, SKORATLAG FROM INT_FORMA WHERE IFUTAMID <> 0 AND IHELYEZES <> 0 AND DTDATUM > '$utdate_nalunk' ORDER BY DTDATUM");
  while($egysor=mysql_fetch_row($resnl)){
    $updatesor[]=$egysor;
  }
  //print_r($updatesor);
  db_set_active('default');
  $jottujforma=0;
  foreach($updatesor as $egysor){
      $iformaid = $egysor[0]; $ifutamid = $egysor[1]; $dtdatum = $egysor[2]; $iloid = $egysor[3]; $itav = $egysor[4]; $ihelyezes = $egysor[5];
      $fdij = $egysor[6]; $skoratlag = $egysor[7];
      db_query("INSERT INTO FORMA VALUES ('%d','%d','%s','%d','%d','%d','%d','%s')", $iformaid, $ifutamid, $dtdatum, $iloid, $itav, $ihelyezes, $fdij, $skoratlag);
      $jottujforma++;    
  }
  print "<br>jöttujforma:".$jottujforma;
  //END a külömbözetet insertelni a SAJÁT -ba //////////////////////////////////////////////
  
  //START UPGRD tábla naprakésszé tétele/////////////////////////////////////////////////////////////////
  db_query("UPDATE UPGRD SET FORMA_upgrd_ujsorok = '$jottujforma', FORMA_upgrd_versenynap = '$utdate_nl', FORMA_upgrd_datum = NOW()");
  //END UPGRD tábla naprakésszé tétele/////////////////////////////////////////////////////////////////
  
 

  //>> saját LO tábla frissítése nl INT_LO táblából//////////////////////////////////////////
  db_set_active('nl');
  $db = mysql_connect("82.131.211.98:3306","ugetocom","Ugetocom1") or die("Nem sikerÃ¼lt kapcsolÃ³dni a MySQL szerver-hez!");
  //$db = mysql_connect("www.uzsoki.hu:3306","ugetocom","Ugetocom1") or die("Nem sikerÃ¼lt kapcsolÃ³dni a MySQL szerver-hez!");
	 mysql_select_db("UgetoInternet",$db) or die("Nem sikerÃ¼lt kapcsolÃ³dni az adatbÃ¡zishoz!");
	 mysql_query("set names 'utf8'");
   
   $reslo=mysql_query("SELECT ILOID, SLONEV, SLONEVELOZO, DTLONEVVALTOZAS, SORSZAG, ISZULETESIEV, IHALALEV, IKOR, IANYAID, IAPAID, ITENYESZTOID, ITENYESZTES, ISZIN, INEM, ISTATUSZ, IISTALLOID, SREKORD_RT, SREKORD_KT, SREKORD_HT, FELETNYEREMENY, IINTERNET, SROVIDNEV FROM INT_LO");  
   while($egysor=mysql_fetch_row($reslo)){
   $loarray[]=$egysor;
   }
   //print_r($loarray);
  db_set_active('default');
  db_query("DELETE FROM LO");
  $udatedlo=0;
  foreach($loarray as $egylo){
    $ILOID=$egylo[0];$SLONEV=$egylo[1];$SLONEVELOZO=$egylo[2];$DTLONEVVALTOZAS=$egylo[3];$SORSZAG=$egylo[4];$ISZULETESIEV=$egylo[5];
    $IHALEV=$egylo[6];$IKOR=$egylo[7];$IANYAID=$egylo[8];$IAPAID=$egylo[9];$ITENYESZTOID=$egylo[10];$ITENYESZTES=$egylo[11];
    $ISZIN=$egylo[12];$INEM=$egylo[13];$ISTATUSZ=$egylo[14];$IISTALLOID=$egylo[15];$SREKORD_RT=$egylo[16];$SREKORD_KT=$egylo[17];
    $SREKORD_HT=$egylo[18];$FELETNYEREMENY=$egylo[19];$IINTERNET=$egylo[20];$ROVIDNEV=$egylo[21];
    //print "<br>lonev:".$SLONEV;
    db_query("INSERT INTO LO VALUES ('%d','%s','%s','%s','%s','%d','%d','%d','%d','%d','%d','%d','%d','%d','%d','%d','%s','%s','%s','%d','%d','%s')", $ILOID,$SLONEV,$SLONEVELOZO,$DTLONEVVALTOZAS,$SORSZAG,$ISZULETESIEV,$IHALEV,$IKOR,$IANYAID,$IAPAID,$ITENYESZTOID,$ITENYESZTES,$ISZIN,$INEM,$ISTATUSZ,$IISTALLOID,$SREKORD_RT,$SREKORD_KT,$SREKORD_HT,$FELETNYEREMENY,$IINTERNET,$ROVIDNEV);
    $updatedlo++;
  }
  print "<br>UpdatedLo:".$updatedlo;
  //<< saját LO tábla frissítése nl INT_LO táblából//////////////////////////////////////////
  
  print "<br>JÖTT:".$jottujforma;
  //return;
  if($jottujforma < 1){
    print "<br>Nemjöttújforma";
    $lo_message.='Lo upgrade kiserlet megtortent. ';
    $lo_message.='Nem jott uj forma. ';
  }else{
    $lo_message.='Lo upgrade megtortent. ';
    $lo_message.='Jott uj forma. '.$jottujforma.' darab ujsor. LovakUpgrade is lefutott. ';    
    lovak_upgrd();
  }
  db_query("UPDATE UPGRD SET LO_upgrd_datum = NOW()");
  mailsend('zojuhasz@gmail.com','Lo upgrade',$lo_message);
}
function mailsend($mailto, $subject, $message){
$headers = "From: ugeto@ugeto.com \n";
    $headers.= "Content-Type: text/html; charset=UTF-8";
    $headers .= "MIME-Version: 1.0 ";
    global $language;
    $params['subject'] = $subject;
    $address=$mailto;
    $message=$message;
    $params['body']    =  $message;
    $params['headers'] = $headers;
    drupal_mail('smtp', 'smtp-test', $address, $language, $params);

}






function getUrlStream($url){
        $ret="";
        $ch = curl_init();
        // set url
        //curl_setopt($ch, CURLOPT_URL, "http://82.131.211.99/php/ugeto_UTOE.php?func=forma&param=2010.12.31&secu=abrakadabra");
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_PORT , 8080); 
        //return the transfer as a string
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
        // $output contains the output string
        $stream = curl_exec($ch);
        $ret=$stream;
        curl_close($ch);
        return $ret;
}

function conv_nl2ug($korido){
    $ret="";
    $ret=substr($korido,0,1).".".substr($korido,2,2).",".substr($korido,5,1);
return $ret;
}
function conv_ug2nl($korido){
    $ret="";
    $ret=substr($korido,0,1).":".substr($korido,2,2).",".substr($korido,5,1);
return $ret;
}

function lovak_listafedeztetes(){

//print_r($_POST);

        if(isset($_POST['ev'])){
            $ev=$_POST['ev'];
            $mk=$_POST['mk'];
            $evjarat_array=array('2014','2013','2012','2011','2010','2009','2008','2007','2006','2005','2004','2003','2002','2001','2000','1999','1998','1997','1996','1995','1994','1993','1992','1991','1990','1989','1988','1987','1986','1985','1984','1983','1982','1981','1980');
            $mk_array=array('M','K','Md','Kd');
            $ev=$evjarat_array[$ev];
            $mk=$mk_array[$mk];
            if($mk=='K'){$szerint='kanc&aacute;k szerint';}
            if($mk=='Kd'){$szerint='kanc&aacute;k szerint';}
            if($mk=='M'){$szerint='m&eacute;nek szerint';}
            if($mk=='Md'){$szerint='m&eacute;nek szerint';}
//print "<br>ev:".$ev;
            if($mk=='K'){
              $lista_res=db_query("SELECT no, neve, ev, fedez, orszag, apja, anyja, nevel, tulajdonos, rekord, penz, szine, neme from lovak WHERE ev='$ev' && lo_vagy_fed ='FEDEZTETES' ORDER BY neve");
            }
            if($mk=='M'){
              $lista_res=db_query("SELECT no, neve, ev, fedez, orszag, apja, anyja, nevel, tulajdonos, rekord, penz, szine, neme from lovak WHERE ev='$ev' && lo_vagy_fed ='FEDEZTETES' ORDER BY apja");
            }
            if($mk=='Kd'){
              $lista_res=db_query("SELECT no, neve, ev, fedez, orszag, apja, anyja, nevel, tulajdonos, rekord, penz, szine, neme from lovak WHERE ev='$ev' && lo_vagy_fed ='FEDEZTETES' ORDER BY neve, fedez");
            }
            if($mk=='Md'){
              $lista_res=db_query("SELECT no, neve, ev, fedez, orszag, apja, anyja, nevel, tulajdonos, rekord, penz, szine, neme from lovak WHERE ev='$ev' && lo_vagy_fed ='FEDEZTETES' ORDER BY apja, fedez");
            }
            if(db_affected_rows()<1){
                $out.="Nincs eredm&eacute;nye a list&aacute;nak";
            }else{
                $out.="<br><b>Fedeztet&eacute;s lista ".$ev." &eacute;vben, $szerint</b><br><br><table class='losablon'><tr>";
                
                $out.="<td><b>L&oacute; neve</td><td><b></a>Apja</td><td><b></a>Anyja</td><td><b>Teny&eacute;szt&otilde;</td>";
                if($mk=='Md' || $mk=='Kd'){
                  $out.="<td><b>Fedezve</b></td>";
                }  
                while($egysor = db_fetch_array($lista_res)) {
                    $out.="<tr>";
                    $no=$egysor['no'];
                    $out.="<td><a href='/lovak/sablon/$no'><b>".$egysor['neve']."</b></a> ".$egysor['szine'].$egysor['neme']."</td>";
//                  $out.="<td>".$egysor['szine'].$egysor['neme']."</td>";
                    $out.="<td>".$egysor['apja']." ".$egysor['apja_ev']." ".$egysor['apja_orszag']."</td>";
                    $out.="<td>".$egysor['anyja']." ".$egysor['anyja_ev']." ".$egysor['anyja_orszag']."</td>";
                    $out.="<td>".$egysor['nevel']."</td>";
                    if($mk=='Md' || $mk=='Kd'){
                      $out.="<td>".$egysor['fedez']."</td>";
                    }
//                    $out.="<td>".$egysor['rekord']."</td>";
//                    $out.="<td align='right'>".number_format($egysor['penz'])."</td>";

                }
                $out.="</tr></table>";
            }
            print theme("page", $out);
        }else{
            $out.=drupal_get_form('lista_fedeztetes_form');
            print theme("page", $out);
            //print theme("page", $out);
            return;
        }


}
function lovak_listatranszponder(){

$lista_res=db_query("SELECT no, neve, ev, orszag, apja, anyja, nevel, tulajdonos, szine, neme, transzponder from lovak WHERE transzponder!='' ORDER BY neve");
            if(db_affected_rows()<1){
                $out.="Nincs eredm&eacute;nye a list&aacute;nak";
            }else{
                $out.="<br><b>Transzponder lista</b><br><table class='losablon'><tr>";
                $out.="<br><td><b>L&oacute; neve</b></td><td><b>Ev</b></td><td><b>Orszag</b></td><td><b>Apja</b></td><td><b>Anyja</b></td><td><b>Szine</b></td><td><b>Neme</b></td><td><b>Transzponder</b></td>";
                $out.="</tr>";
                while($egysor = db_fetch_array($lista_res)) {
                    $out.="<tr>";
                    $no=$egysor['no'];
                    $out.="<td><a href='/lovak/sablon/$no'><b>".$egysor['neve']."</b></a></td>";
                    $out.="<td>".$egysor['ev']."</td>";
                    $out.="<td>".$egysor['orszag']."</td>";
                    $out.="<td>".$egysor['apja']."</td>";
                    $out.="<td>".$egysor['anyja']."</td>";
                    $out.="<td>".$egysor['szine']."</td>";
                    $out.="<td>".$egysor['neme']."</td>";
                    $out.="<td>".$egysor['transzponder']."</td>";
                }
                $out.="</tr></table>";
            }
            print theme("page", $out);
}



function lovak_listavari(){
    if(isset($_POST['apja'])){
            $apja=$_POST['apja'];
            
            $apja_sa=explode('--',$apja);
            if(isset($apja_sa['0'])){$apja_nev=$apja_sa['0'];}else{$apja_nev="";}
            if(isset($apja_sa['1'])){$apja_ev=$apja_sa['1'];}else{$apja_ev="";}
            if(isset($apja_sa['2'])){$apja_orszag=$apja_sa['2'];}else{$apja_orszag="";}unset($apja_sa);
                        
            $anyja=$_POST['anyja'];
            $anyja_sa=explode('--',$anyja);
            if(isset($anyja_sa['0'])){$anyja_nev=$anyja_sa['0'];}else{$anyja_nev="";}
            if(isset($anyja_sa['1'])){$anyja_ev=$anyja_sa['1'];}else{$anyja_ev="";}
            if(isset($anyja_sa['2'])){$anyja_orszag=$anyja_sa['2'];}else{$anyja_orszag="";}unset($anyja_sa);


            $apja_nev=preg_replace("/'/","\'",$apja_nev);
            $anyja_nev=preg_replace("/'/","\'",$anyja_nev);
            
            $rekord=$_POST['rekord'];
            $penz=$_POST['penz'];
            $ev=$_POST['ev'];
            if(strstr($ev, '-')){
                if(strlen($ev)==9){$ev1=substr($ev,0,4);$ev2=substr($ev,5,4);}else{$ev=0;}
            };

            //zdebug($ev,$ev1,$ev2);
            //$evjarat_array=array('1982','1983','1984','1985','1986','1987','1988','1989','1990','1991','1992','1993','1994','1995','1996','1997','1998','1999','2000','2001','2002','2003','2004','2005');
            //$ev=$evjarat_array[$ev];  
            $orszag=$_POST['orszag'];
            $nevel=$_POST['nevel'];
            $tulajdonos=$_POST['tulajdonos'];




            //kereso str osszeall
            $keresostr="WHERE lo_vagy_fed='LO' && TRUE ";
            //zdebug($ev);
            if($apja!=""){$keresostr.=" && apja='$apja_nev'";}
            if($anyja!=""){$keresostr.="&& anyja='$anyja_nev' && anyja_ev='$anyja_ev'";}
            if(!empty($rekord)){$keresostr.="&& rekord<'$rekord' && rekord !=''";}
            if(!empty($penz)){$keresostr.="&& penz>'$penz'";}
            if(isset($ev1)){
                $keresostr.="&& ev>='$ev1' && ev<='$ev2'";
            }else{
               if(!empty($ev)){$keresostr.="&& ev='$ev'";}
            }
            if(!empty($orszag)){$keresostr.="&& orszag='$orszag'";}
            if(!empty($nevel)){$keresostr.="&& nevel like '%$nevel%'";}
            if(!empty($tulajdonos)){$keresostr.="&& tulajdonos like '%$tulajdonos%'";}

            //order str osszeall
            $orderbystr="";
            if(!empty($rekord)){
                if(!empty($apja) && empty($anyja)){$orderbystr=" ORDER BY rekord, apja ";}
                if(!empty($anyja) && empty($apja)){$orderbystr=" ORDER BY rekord, anyja ";}
                if(!empty($anyja) && !empty($apja)){$orderbystr=" ORDER BY rekord, apja, anyja";}
                if(empty($anyja) && empty($apja)){$orderbystr=" ORDER BY rekord, apja, anyja";}
            }else{
                if(!empty($apja) && empty($anyja)){$orderbystr=" ORDER BY apja, ev, anyja";}
                if(!empty($anyja) && empty($apja)){$orderbystr=" ORDER BY anyja, ev, apja";}
                if(!empty($anyja) && !empty($apja)){$orderbystr=" ORDER BY apja, anyja, ev";}
                if(!empty($ev)){$orderbystr=" ORDER BY neve";}

            }

            $param="Lista";

            $lista_res=db_query("SELECT neve, ev, orszag, apja, anyja, nevel, belyeg, tulajdonos, rekord, penz, szine, neme, loazon, transzponder from lovak ".$keresostr.$orderbystr);
            if(db_affected_rows()<1){
                $out.="Nincs eredm&eacute;nye a list&aacute;nak";
            }else{
                $out.="<b>".$param."</b><br><table class='varilista'><tr class='varilista'>";
                $out.="<td><b>L&oacute; neve--&Eacute;v--Orsz&aacute;g</b></td><td><b>Apja</b></td><td><b>Anyja</b></td><td><b>B&eacute;lyeg</b></td><td><b>Teny&eacute;szt&otilde;</b></td><td><b>Rekord</b></td><td><b>Nyerem&eacute;ny</b></td><td><b>L&oacute;azonos&iacute;t&oacute;</b></td><td><b>Transzponder</b></td>";
                if(!empty($tulajdonos)){
                    $out.="<td><b>Tulajdonos</td>";
                }
                $out.="</tr>";
                while($egysor = db_fetch_array($lista_res)) {
                    $out.="<tr class='varilista'>";
                    $out.="<td><b>".$egysor['neve']."</b>--".$egysor['ev'].$egysor['szine'].$egysor['neme']."--".$egysor['orszag']."</td>";
//                  $out.="<td>".$egysor['szine'].$egysor['neme']."</td>";
                    $out.="<td>".$egysor['apja']." ".$egysor['apja_ev']." ".$egysor['apja_orszag']."</td>"; 
                    $out.="<td>".$egysor['anyja']." ".$egysor['anyja_ev']." ".$egysor['anyja_orszag']."</td>";  
                    $out.="<td>".$egysor['belyeg']."</td>";
                    $out.="<td>".$egysor['nevel']."</td>";  
                    $out.="<td>".$egysor['rekord']."</td>"; 
                    $out.="<td align='right'>".number_format($egysor['penz'])."</td>";
                    $out.="<td>".$egysor['loazon']."</td>";  
                    $out.="<td>".$egysor['transzponder']."</td>";
                    if(!empty($tulajdonos)){
                        $out.="<td>".$egysor['tulajdonos']."</td>";
                    }
                }
                $out.="</tr></table>";
                
            }
        }else{
            $out.=drupal_get_form('lista_vari_form');
            print theme("page", $out);
            return;
        }


    $changed=time();
    $nidvege=substr(strval($changed),-2);
    $nidbe='9999000'.$nidvege;
    db_query("SELECT * FROM node WHERE nid='$nidbe'");
    if(db_affected_rows()==0){
        db_query("INSERT INTO node (nid, vid) VALUES ('%d', '%d')", $nidbe, $nidbe);
        db_query("INSERT INTO node_revisions (nid, vid) VALUES ('%d','%d')", $nidbe, $nidbe);
    }

    db_query("UPDATE node SET changed='%s', uid = '1', title='%s' where nid='$nidbe'", $changed, 'Lista');
    db_query("UPDATE node_revisions SET body='%s', teaser='%s', uid = '1', timestamp='%s' where nid='$nidbe'", $out, $out, $changed);
    header("location:/node/".$nidbe);
    return;
}


function lovak_lista($listafajta){
    $out="";
    //print "<br>listafajta:".$listafajta;
    
    if($listafajta=="varipub"){
        if(isset($_POST['apja'])){
            $apja=$_POST['apja'];
            
            $apja_sa=explode('--',$apja);
            if(isset($apja_sa['0'])){$apja_nev=$apja_sa['0'];}else{$apja_nev="";}
            if(isset($apja_sa['1'])){$apja_ev=$apja_sa['1'];}else{$apja_ev="";}
            if(isset($apja_sa['2'])){$apja_orszag=$apja_sa['2'];}else{$apja_orszag="";}unset($apja_sa);
                        
            $anyja=$_POST['anyja'];
            $anyja_sa=explode('--',$anyja);
            if(isset($anyja_sa['0'])){$anyja_nev=$anyja_sa['0'];}else{$anyja_nev="";}
            if(isset($anyja_sa['1'])){$anyja_ev=$anyja_sa['1'];}else{$anyja_ev="";}
            if(isset($anyja_sa['2'])){$anyja_orszag=$anyja_sa['2'];}else{$anyja_orszag="";}unset($anyja_sa);
            

            $apja_nev=preg_replace("/'/","\'",$apja_nev);
            $anyja_nev=preg_replace("/'/","\'",$anyja_nev);
            if($apja_nev=="" && $anyja_nev==""){
                print theme("page", "Nincs megadva sem apa, sem anya!");
                return;
            }

            $rekord=$_POST['rekord'];
            $penz=$_POST['penz'];

            $orszag=$_POST['orszag'];
                                    
            //kereso str osszeall
            $keresostr="WHERE TRUE ";
            if($apja!=""){$keresostr.=" && apja='$apja_nev'";}
            if($anyja!=""){$keresostr.="&& anyja='$anyja_nev' && anyja_ev='$anyja_ev'";}
            if(!empty($rekord)){$keresostr.="&& rekord<'$rekord' && rekord !=''";}
            if(!empty($penz)){$keresostr.="&& penz>'$penz'";}
            if(!empty($orszag)){$keresostr.="&& orszag='$orszag'";}

            //order str osszeall
            $orderbystr="";
            if(!empty($rekord)){        
                if(!empty($apja) && empty($anyja)){$orderbystr=" ORDER BY rekord, apja ";}
                if(!empty($anyja) && empty($apja)){$orderbystr=" ORDER BY rekord, anyja ";}
                if(!empty($anyja) && !empty($apja)){$orderbystr=" ORDER BY rekord, apja, anyja";}
                if(empty($anyja) && empty($apja)){$orderbystr=" ORDER BY rekord, apja, anyja";}
            }else{
                if(!empty($apja) && empty($anyja)){$orderbystr=" ORDER BY apja, ev, anyja";}
                if(!empty($anyja) && empty($apja)){$orderbystr=" ORDER BY anyja, ev, apja";}
                if(!empty($anyja) && !empty($apja)){$orderbystr=" ORDER BY apja, anyja, ev";}
                
                
            }

            $param="Lista";
            
            $lista_res=db_query("SELECT no, neve, ev, orszag, apja, anyja, rekord, penz, szine, neme from lovak ".$keresostr.$orderbystr);
            if(db_affected_rows()<1){
                $out.="Nincs eredm&eacute;nye a list&aacute;nak";
            }else{
                $out.="<b>$param</b><br><table class='varilista'><tr>";
                $out.="<td><b>L&oacute; neve</b>--&Eacute;v--Orsz&aacute;g</td><td><b></a>Apja</td><td><b></a>Anyja</td><td><b>Rekord</td><td><b>Nyerem&eacute;ny</td>";
                $out.="</tr>";
                while($egysor = db_fetch_array($lista_res)) {
                    $out.="<tr class='varilista'>";
                    $no=$egysor['no'];
                    
                    
                    
                    
                    
                    
                    //megnezni van-e forma adat a FORMA tablaban ehhez a lohoz
                    $vaneforma=0;
                    $res_lovak=db_query("SELECT neve, ev, orszag, szine, neme FROM lovak WHERE no = '%d'", $no);
                    if(db_affected_rows()>=1){
                      while($egysor1 = db_fetch_array($res_lovak)) {
                        $lonev=$egysor1['neve'];
                        $ev=$egysor1['ev'];
                        $orszag=$egysor1['orszag'];
                        $szine=$egysor1['szine'];
                        $neme=$egysor1['neme'];
  
                      }
                    }
                    // print "<br>ev:".$ev;
                    $iloid=0;
                    $res_lo=db_query("SELECT ILOID FROM LO WHERE SLONEV = '%s'", $lonev);
                    $talalt=db_affected_rows();
                    if($talalt==1){
                      while($egysor2 = db_fetch_array($res_lo)) {
                        $iloid=$egysor2['ILOID'];
                        //print "<br>iloid:".$iloid;
                      }
                    }
                    //FUTASOK KILISTAZASA NL KFT ADATBAZISABOL, kiveve azokat amik le vannak tiltva
                    if($iloid!=0 && $iloid!=2877 && $iloid!=3339){
                      //$res_forma=db_query("SELECT FDIJ FROM FORMA WHERE ILOID = '%d' && IFUTAMID!=0 && DTDATUM>'2000'", $iloid);
                      $res_forma=db_query("SELECT ILOID FROM LO WHERE ILOID = %s", $iloid);
                      if(db_affected_rows()>0){
                        $vaneforma=1;
                      }
                    }
                    //print "<br>f:".$vaneforma;
                    //if($lonev_no==8407){

                    
                    
                    
                    
                    
                    
                    $out.="<td><a href='/lovak/sablon/$no/$vaneforma/$iloid'><b>".$egysor['neve']."</b></a>--".$egysor['ev'].$egysor['szine'].$egysor['neme']."--".$egysor['orszag']."</td>";
//                  $out.="<td>".$egysor['szine'].$egysor['neme']."</td>";  
                    $out.="<td>".$egysor['apja']." ".$egysor['apja_ev']." ".$egysor['apja_orszag']."</td>"; 
                    $out.="<td>".$egysor['anyja']." ".$egysor['anyja_ev']." ".$egysor['anyja_orszag']."</td>";  
                    $out.="<td>".$egysor['rekord']."</td>"; 
                    $out.="<td align='right'>".number_format($egysor['penz'])."</td>";
                    
                }
                $out.="</tr></table>";
                
            }
        }else{
            $out.=drupal_get_form('lista_varipub_form');
            print theme("page", $out);
            return;
        }
            
    }
    if($listafajta=="utlevel"){
      //print "<br>utlevel";
        if(isset($_POST['utlevel'])){
          //print "<br>utlevelISSET";
          // Store new file.
          $new_file = file_save_upload('utlevel', array (
          'file_validate_extensions'    => array ('xml'),
          'custom_validate_size' => array (1024 * 1024 * 30), // You should define validation function for file size, in case file is too big.
          ));   
        }else{
          //print "<br>utlevelNONISSET";
          $out=drupal_render(drupal_get_form('lovak_utlevel_form'));
          return $out;
        } 
    }  
    if($listafajta=="csiko"){
      //print "<br>csikó";
      //$xml = simplexml_load_file('files/HUN.xml');
      //print "<br>xml:";
      //print_r($xml);
        if(isset($_POST['ev'])){
            $ev=$_POST['ev'];
            $evjarat_array=array('2014','2013','2012','2011','2010','2009','2008','2007','2006','2005','2004','2003','2002','2001','2000','1999','1998','1997','1996','1995','1994','1993','1992','1991','1990','1989','1988','1987','1986','1985','1984','1983','1982','1981','1980','1979','1978','1977','1976','1975','1974','1973','1972','1971','1970','1969','1968','1967','1966','1965','1964','1963','1962','1961','1960');
            $ev=$evjarat_array[$ev];    
            
            $res_lovak=db_query("SELECT neve, ev, orszag, szine, neme FROM {lovak} WHERE no = :no", array(":no" => $no));
            print "<br>".count($res_lovak);
            if(count($res_lovak)>=1){
              foreach ($res_lovak as $record2) {  
                $lonev=$record2->neve;
                $ev=$record2->ev;
                $orszag=$record2->orszag;
                $szine=$record2->szine;
                $neme=$record2->neme;
              }
            }
                        
            print_r($record2);
           //$lista_res=db_query("SELECT no, neve, ev, orszag, apja, anyja, nevel, tulajdonos, rekord, penz, szine, neme from {lovak} WHERE ev = :ev AND orszag = :orszag AND lo_vagy_fed = :lo_vagy_fed", array(":ev" => $ev, ":orszag" = $hu, ":lo_vagy_fed" => $lo));
           $lista_res=db_query("SELECT no, neve, ev, orszag, apja, apja_orszag, anyja, anyja_orszag, nevel, tulajdonos, rekord, penz, szine, neme from {lovak} WHERE ev = :ev AND orszag = :orszag AND lo_vagy_fed = :lo_vagy_fed", array(":ev" => $ev, ":orszag" => 'HU', ":lo_vagy_fed" => 'LO'));
           if(count($lista_res)<1){
                $out.="Nincs eredm&eacute;nye a list&aacute;nak";
            }else{
                $out.="<b>Csik&oacute; lista</b><br><table class='losablon'><tr>";
                $out.="<td><b>L&oacute; neve</td><td><b></a>Apja</td><td><b></a>Anyja</td><td><b>Teny&eacute;szt&otilde;</td><td><b>Rekord</td><td><b>Nyerem&eacute;ny</td>";
                $out.="</tr>";
                //while($egysor = db_fetch_array($lista_res)) {
                foreach($lista_res as $egysor){
                    $out.="<tr>";
                    $no=$egysor->no;
                                       
                    //megnezni van-e forma adat a FORMA tablaban ehhez a lohoz
                    $vaneforma=0;
                    $res_lovak=db_query("SELECT neve, ev, orszag, szine, neme FROM {lovak} WHERE no = :no", array(":no" => $no));
                    if(count($res_lovak)>=1){
                      //while($egysor1 = db_fetch_array($res_lovak)) {
                      foreach($res_lovak as $egysor1){
                        $lonev=$egysor1->neve;
                        $ev=$egysor1->ev;
                        $orszag=$egysor1->orszag;
                        $szine=$egysor1->szine;
                        $neme=$egysor1->neme;
  
                      }
                    }
                    // print "<br>ev:".$ev;
                    $iloid=0;
                    $res_lo=db_query("SELECT ILOID FROM {LO} WHERE SLONEV = :SLONEV", array(":SLONEV" => $lonev));
                    $talalt=count($res_lo);
                    if($talalt==1){
                      //while($egysor2 = db_fetch_array($res_lo)) {
                      foreach($res_lo as $egysor2)  {
                        $iloid=$egysor2->ILOID;
                        //print "<br>iloid:".$iloid;
                      }
                    }
                    //FUTASOK KILISTAZASA NL KFT ADATBAZISABOL, kiveve azokat amik le vannak tiltva
                    if($iloid!=0 && $iloid!=2877 && $iloid!=3339){
                      //$res_forma=db_query("SELECT FDIJ FROM FORMA WHERE ILOID = '%d' && IFUTAMID!=0 && DTDATUM>'2000'", $iloid);
                      $res_forma=db_query("SELECT ILOID FROM {LO} WHERE ILOID = :ILOID", array(":ILOID" => $iloid));
                      if(count($res_forma)>0){
                        $vaneforma=1;
                      }
                    }
                      
                    $out.="<td><a href='/lovak/sablon/$no/$vaneforma/$iloid'><b>".$egysor->neve."</b></a> ".$egysor->szine.$egysor->neme."</td>";
//                  $out.="<td>".$egysor['szine'].$egysor['neme']."</td>";
                    $out.="<td>".$egysor->apja." ".$egysor->apja_ev." ".$egysor->apja_orszag."</td>";
                    $out.="<td>".$egysor->anyja." ".$egysor->anyja_ev." ".$egysor->anyja_orszag."</td>";
                    $out.="<td>".$egysor->nevel."</td>";
                    $out.="<td>".$egysor->rekord."</td>";
                    $out.="<td align='right'>".number_format($egysor->penz)."</td>";

                }
                $out.="</tr></table>";

            }
          
        }else{
          //print "<br>nonisset";
            //$out.=drupal_get_form('lista_csiko_form');
            $out=drupal_render(drupal_get_form('lista_csiko_form'));
            //print theme("page", $out);
            return $out;
        }

    }

    if($listafajta=="fedezo"){
            $lista_res=db_query("SELECT no, neve, ev, szine, neme, apja, anyja FROM lovak WHERE fedezomen='IGEN' && lo_vagy_fed='LO' ORDER BY neve");
            if(db_affected_rows()<1){
                $out.="Nincs eredm&eacute;nye a list&aacute;nak";
            }else{
                $out.="<b>Fedez&otilde;m&eacute;nek list&aacute;ja</b><br><table class='losablon'><tr>";
                $out.="<td><b>L&oacute; neve</td><td><b>&Eacute;vj&aacute;rat</td><td><b>Sz&iacute;ne</td><td><b>Neme</td><td><b>Apja</td><td><b>Anyja</td>";
                $out.="</tr>";
                while($egysor = db_fetch_array($lista_res)) {
                    $out.="<tr>";
                    $no=$egysor['no'];
                    $out.="<td><a href='/lovak/sablon/$no'><b>".$egysor['neve']."</b></a></td>";
                    $out.="<td>".$egysor['ev']."</td>";
                    $out.="<td>".$egysor['szine']."</td>";
                    $out.="<td>".$egysor['neme']."</td>";
                    $out.="<td>".$egysor['apja']."</td>";
                    $out.="<td>".$egysor['anyja']."</td>";
                }
                $out.="</tr></table>";
                
            }
    }
    
    $changed=time();
    $nidvege=substr(strval($changed),-2);
    $nidbe='9999000'.$nidvege;
    db_query("SELECT * FROM node WHERE nid='$nidbe'");
    if(db_affected_rows()==0){
        db_query("INSERT INTO node (nid, vid) VALUES ('%d', '%d')", $nidbe, $nidbe);
        db_query("INSERT INTO node_revisions (nid, vid) VALUES ('%d','%d')", $nidbe, $nidbe);
    }

    db_query("UPDATE node SET changed='%s', uid = '1', title='%s' where nid='$nidbe'", $changed, 'Lista');
    db_query("UPDATE node_revisions SET body='%s', teaser='%s', uid = '1', timestamp='%s' where nid='$nidbe'", $out, $out, $changed);
    header("location:/node/".$nidbe);
    
    //print theme("page", $out);    
    
    
    //db_query("SELECT * from lovak WHERE neve='%s' && ev='%d' && (orszag='%s' || orszag='')", $lonev,$ev,$orszag);
    //if(db_affected_rows()<1){$err.="Nincs eredm&eacute;nye a list&aacute;nak".$listafajta;}
            

return;
}

function lovak_mod($lonev="", $ev=""){

    $ret="";
    
    $rekord="";
    $penz="";
    $ellet="";
    $szine="";
    $neme="";
    $belyeg="";
    $tulajdonos="";
    $nevel="";
    $orszag="";
    $apja="";
    $apja_ev="";
    $apja_2="";
    $apja_2_ev="";
    $anyja="";
    $anyja_ev="";
    $imp_orsz="";
    $imp_kelt="";
    $exp_orsz="";
    $exp_kelt="";
    $kimult_kelt="";
    $kiherelve_kelt="";
    $elozo="";
    $fedezomen="";
    $aktiv="";
        
    
    
    //volt már form, akkor ell.
    if(isset($_POST['edit']['stadium']) && $_POST['edit']['stadium']=='elso_form'){
        //print_r($_POST);
        $lonev=$_POST['edit']['neve'];
        $ev=$_POST['edit']['ev'];
        $apja_ev=$_POST['edit']['apja_ev'];
        $apja_2_ev=$_POST['edit']['apja_2_ev'];
        $anyja_ev=$_POST['edit']['anyja_ev'];
        $lonev_elozo=$_POST['edit']['lonev_elozo'];
        $lonev_elozo=preg_replace("/'/","\'",$lonev_elozo);
        
        $torles=$_POST['edit']['torles'];
        //print "<br>torles:".$torles;
        
        $ev_elozo=$_POST['edit']['ev_elozo'];
        $rekord=$_POST['edit']['rek'];
        $penz=$_POST['edit']['penz'];
        //print "penz:".$penz;

        $ellet=$_POST['edit']['ellet'];
        $szine=$_POST['edit']['szine'];
        
        
        if($szine=="0"){$szine=" ";}
        if($szine=="1"){$szine="f";}
        if($szine=="2"){$szine="f/sz";}
        if($szine=="3"){$szine="p";}
        if($szine=="4"){$szine="p/stp";}
        if($szine=="5"){$szine="p/vlp";}
        if($szine=="6"){$szine="s";}
        if($szine=="7"){$szine="stp";}
        if($szine=="8"){$szine="stp/f";}
        if($szine=="9"){$szine="stp/sz";}
        if($szine=="10"){$szine="sz";}
        if($szine=="11"){$szine="sz/stp";}
        if($szine=="12"){$szine="tarka";}
        if($szine=="13"){$szine="vlp";}


        //print "<br>szine:".$szine;
        //$szine=convert_key_to_value("lovak", "szine", $szine);
        $neme=convert_key_to_value("lovak", "neme", $_POST['edit']['neme']);
        $belyeg=$_POST['edit']['belyeg'];
        $nevel=$_POST['edit']['nevel'];
        $tulajdonos=$_POST['edit']['tulajdonos'];
        if($_POST['edit']['tulajdonos_esetleg']==""){$tulajdonos=convert_key_to_value("lovak", "tulajdonos", $tulajdonos);}else{$tulajdonos=$_POST['edit']['tulajdonos_esetleg'];}
        $tulajdonos=preg_replace("/'/","\'",$tulajdonos);
        if($_POST['edit']['nevel_esetleg']==""){$nevel=convert_key_to_value("lovak", "nevel", $nevel);}else{$nevel=$_POST['edit']['nevel_esetleg'];}
        $nevel=preg_replace("/'/","\'",$nevel);
        $orszag=$_POST['edit']['orszag'];
        if($_POST['edit']['orszag_esetleg']==""){$orszag=convert_key_to_value("lovak", "orszag", $orszag);}else{$orszag=$_POST['edit']['orszag_esetleg'];}

        $apja=$_POST['edit']['apja'];
        if($_POST['edit']['apja_esetleg']==""){$apja=convert_key_to_value("lovak", "apja", $apja);}else{$apja=$_POST['edit']['apja_esetleg'];}
        $apja=preg_replace("/'/","\'",$apja);

        $apja_2=$_POST['edit']['apja_2'];
        if($_POST['edit']['apja_2_esetleg']==""){$apja_2=convert_key_to_value("lovak", "apja_2", $apja_2);}else{$apja_2=$_POST['edit']['apja_2_esetleg'];}
        $apja_2=preg_replace("/'/","\'",$apja_2);


        $anyja=$_POST['edit']['anyja'];
        if($_POST['edit']['anyja_esetleg']==""){$anyja=convert_key_to_value("lovak", "anyja", $anyja);}else{$anyja=$_POST['edit']['anyja_esetleg'];}
//      print "<br>ANYJA:".$anyja;
        $anyja=preg_replace("/'/","\'",$anyja);
        $imp_orsz=$_POST['edit']['imp_orsz'];
        $exp_orsz=$_POST['edit']['exp_orsz'];
        if($_POST['edit']['imp_orsz_esetleg']==""){$imp_orsz=convert_key_to_value("lovak", "imp_orsz", $imp_orsz);}else{$imp_orsz=$_POST['edit']['imp_orsz_esetleg'];}
        if($_POST['edit']['exp_orsz_esetleg']==""){$exp_orsz=convert_key_to_value("lovak", "exp_orsz", $exp_orsz);}else{$exp_orsz=$_POST['edit']['exp_orsz_esetleg'];}
        $imp_kelt=$_POST['edit']['imp_kelt'];
        $exp_kelt=$_POST['edit']['exp_kelt'];
        $kimult_kelt=$_POST['edit']['kimult_kelt'];
        $kiherelve_kelt=$_POST['edit']['kiherelve_kelt'];
        //print "imp_kelt:".$imp_kelt;
        $elozo=$_POST['edit']['elozo'];
        //print "elozo:".$elozo;
        if(isset($_POST['edit']['fedezomen'])){
            $fedezomen=convert_key_to_value("lovak", "fedezomen", $_POST['edit']['fedezomen']);
        }else{
            $fedezomen="NEM";
        }
        if(isset($_POST['edit']['aktiv'])){
            $aktiv=convert_key_to_value("lovak", "aktiv", $_POST['edit']['aktiv']);
        }else{
            $aktiv="NEM";
        }
        
        
        
        $no=$_POST['edit']['no'];
        
        //VALAMILYEN ELLENÕRZÉS KELL ITT IS     
        $error="";
        //Ha volt LONÉV változtatás
        $lokernev=preg_replace("/'/","\'",$lonev);
        if($lonev_elozo != $lokernev){
            $lokernev=preg_replace("/'/","\'",$lonev_elozo);
            $lo_res = db_query("SELECT * FROM lovak WHERE (apja = '$lokernev' || anyja='$lokernev') && lo_vagy_fed='LO'");
            $talalt=db_affected_rows();
            if($talalt>0){print "<br> FIGYELEM!!! ".$lonev_elozo."-szerepel ANYJA v. APA -kent az adadbazisban ".$talalt." esetben mas lonal!!!!";print "<br> Emiatt nem lehet modositani, mert az adatbazis konzisztencia serul!!!";$error="Lonev valtozas tiltas";
                return;
            }    
        }
        
        
//      print "<br>Anyja:".$anyja;      
        $lokernev=preg_replace("/'/","\'",$lonev);
        $nevkernev=preg_replace("/'/","\'",$nevel);
        $tulajdonoskernev=preg_replace("/'/","\'",$tulajdonos);
                
//print "<br>neme:".$neme;

        //db_query('UPDATE lovak SET neve="$lonev", ev="$ev", rekord="$rekord", rekord_ok="$rekord", penz="$penz", ellet="$ellet", szine="$szine", neme="$neme", belyeg="$belyeg", tulajdonos="$tulajdonos", nevel="$nevel", orszag="$orszag", apja="$apja", anyja="$anyja", imp_orsz="$imp_orsz", imp_kelt="$imp_kelt", elozo="$elozo" WHERE no="$no"');
        
        if($torles==1){
            db_query("DELETE FROM lovak WHERE no='$no'");
            if(db_affected_rows()){
            print "<br> ".$lonev. " TOROLVE...";
            }else{
            print "<br> ".$lonev. " TORLESE NEM SIKERULT !!!!";
            }
            print "<br><br><a href='/?q=lovak'>". drupal_convert_to_utf8("UGRÁS A LOVAKHOZ...", "iso-8859-2") ."</a>";

            return;    
        }
        
        //print "<br>no:".$no;      
        //print "<br>apja:".$apja;      
        //print "<br>apja_ev:".$apja_ev;        
        //print "<br>apja_2:".$apja_2;      
        //print "<br>apja_2_ev:".$apja_2_ev;        
        //print "<br>fed:".$fedezomen;
        

        
        db_query("UPDATE lovak SET neve='$lokernev', ev='$ev', rekord='$rekord', rekord_ok='$rekord', penz='$penz', ellet='$ellet', szine='$szine', neme='$neme', belyeg='$belyeg', tulajdonos='$tulajdonoskernev', nevel='$nevkernev', orszag='$orszag', apja='$apja', apja_ev='$apja_ev', apja_2='$apja_2', apja_2_ev='$apja_2_ev', anyja='$anyja', anyja_ev='$anyja_ev', imp_orsz='$imp_orsz', imp_kelt='$imp_kelt', exp_orsz='$exp_orsz', exp_kelt='$exp_kelt', kimult='$kimult_kelt', herel='$kiherelve_kelt', elozo='$elozo', fedezomen='$fedezomen', aktiv='$aktiv' WHERE no='$no'");
        $talalt=db_affected_rows();
        if($talalt==1){print "<br> SIKERESEN MODOSITVA...";
            print "no:".$no;
            print " lonev:".$lokernev;
        }   
        if($talalt==0){print "<br> NINCS VALTOZAS !!!!!, a MODOSITAS NEM SIKERULT!!!!";}    
        if($talalt>1){print "<br> TOBB ILYEN NEVU VAN, SZAMSZERINT ".$talalt." db. !!!!!, a MODOSITAS VEGREHAJTVA MINDENGYIKNEL!!!!";}  
        
        print "<br><br><a href='/?q=lovak&&lovak_mod'>". drupal_convert_to_utf8("UGRÁS A MÓDOSÍTÁSHOZ MÁSIK LÓ ADATAINAK BEÍRÁSA VÉGETT...", "iso-8859-2") ."</a>";
        print "<br><br><a href='/?q=lovak&&lovak_new'>". drupal_convert_to_utf8("KÖVETKEZÕ ÚJ LÓ FELVITELE", "iso-8859-2") ."</a>"; 

        return;

    }

    
    
    //Ha nincs meeg kiválasztva ló akkor SELECT
//  if($lonev==""){
    if($lonev=="" || $ev==""){
        $lonev_array=loker("neve", "modositando lo neve", "page");
        $lonev=$lonev_array["neve"];
        $ev=$lonev_array["ev"];
        //return;
    }
    
    //kigyüjteni a lo alapadatait
    $lokernev=preg_replace("/'/","\'",$lonev);
    $lo_res = db_query("SELECT * FROM lovak WHERE binary neve = '$lokernev' && ev='$ev' && lo_vagy_fed='LO'");
    if(db_affected_rows()>1){print "<br> ERROR: ".$lonev."-".$ev."-bol duplikalva van!!!!";return;}
    if(db_affected_rows()==1){while($egysor = db_fetch_array($lo_res)){
    $lo_no=$egysor["no"];$lo_rek=$egysor["REKORD"];$lo_penz=$egysor["PENZ"];$lo_ellet=$egysor["ELLET"];$lo_szine=$egysor["SZINE"];$lo_neme=$egysor["NEME"];$lo_belyeg=$egysor["BELYEG"];$lo_tulajdonos=$egysor["TULAJDONOS"];$lo_nevel=$egysor["NEVEL"];$lo_orszag=$egysor["ORSZAG"];$lo_apja=$egysor["APJA"];$lo_apja_ev=$egysor["APJA_EV"];$lo_apja_2=$egysor["APJA_2"];$lo_apja_2_ev=$egysor["APJA_2_EV"];$lo_anyja=$egysor["ANYJA"];$lo_anyja_ev=$egysor["ANYJA_EV"];$lo_imp_orsz=$egysor["IMP_ORSZ"];$lo_imp_kelt=$egysor["IMP_KELT"];$lo_exp_orsz=$egysor["EXP_ORSZ"];$lo_exp_kelt=$egysor["EXP_KELT"];$lo_kimult_kelt=$egysor["KIMULT"];$lo_kiherelve_kelt=$egysor["HEREL"];$lo_elozo=$egysor["ELOZO"];$fedezomen=$egysor["FEDEZOMEN"];$aktiv=$egysor["AKTIV"];}}
    
//  print_r($_POST);    
    //lonev
        //form összeállítás
////            $form_text_lonev = "<br><br>".form_textfield("Neve", "neve", $lonev, 20, 30);
    

    //fedezomen
    //print "<br>loneme:".$lo_neme;
    if ($lo_neme=="m"){    
        //$fedezomen_res = db_query("SELECT fedezomen FROM lovak GROUP BY fedezomen");
        //while($egysor = db_fetch_array($fedezomen_res)) {$fedezomen_array[] = $egysor["fedezomen"];}
        $fedezomen_array=array("1" => "IGEN", "2" => "NEM");
        $aktiv_array=array("1" => "IGEN", "2" => "NEM");
        //print_r($fedezomen_array);
        //print "<br>Fed:".$fedezomen;
        //meghatározni az array-ben a poziciót, a SELECT -hez

        //$fedezomen_poz=array_search($fedezomen,$fedezomen_array);
        
        if($fedezomen=="IGEN"){
            $fedezomen_poz="1";
        }else{
            $fedezomen_poz="2";
        }
        if($aktiv=="IGEN"){
            $aktiv_poz="1";
        }else{
            $aktiv_poz="2";
        }

        //print "<br>FEDEZOMEN:".$fedezomen;
        //print "<br>FEDEZOMENPOZ:".$fedezomen_poz;
        //form összeállítás
////            $form_sel_fedezomen = "<br><br>".form_select(drupal_convert_to_utf8("Aktuális fedezomenlistára kerüljön?", "iso-8859-2"), "fedezomen", $fedezomen_poz, $fedezomen_array, "", "size=1");
    }
    
    //torles
////            $form_delete = form_checkbox(drupal_convert_to_utf8("LÓ TÖRLÉSE", "iso-8859-2"), "torles")."<br>";
    
    
    //ev
        //form összeállítás
////            $form_text_ev = "<br><br>".form_textfield(drupal_convert_to_utf8("Évjárat", "iso-8859-2"), "ev", $ev, 2, 4, "");

    //szine
        //feltölteni $szine_array -t a SELECT -hez
        //$szine_res = db_query("SELECT szine FROM lovak GROUP BY szine");
        //while($egysor = db_fetch_array($szine_res)) {$szine_array[] = $egysor["szine"];}
        $szine_array=array("0" => " ", "1" => "f", "2" => "f/sz", "3" => "p", "4" => "p/stp", "5" => "p/vlp", "6" => "s", "7" => "stp", "8" => "stp/f", "9" => "stp/sz", "10" => "sz", "11" => "sz/stp", "12" => "tarka", "13" => "vlp");

        $szine=$lo_szine;
        if($szine==" "){$szine_poz="0";}
        if($szine=="f"){$szine_poz="1";}
        if($szine=="f/sz"){$szine_poz="2";}
        if($szine=="p"){$szine_poz="3";}
        if($szine=="p/stp"){$szine_poz="4";}
        if($szine=="p/vlp"){$szine_poz="5";}
        if($szine=="s"){$szine_poz="6";}
        if($szine=="stp"){$szine_poz="7";}
        if($szine=="stp/f"){$szine_poz="8";}
        if($szine=="stp/sz"){$szine_poz="9";}
        if($szine=="sz"){$szine_poz="10";}
        if($szine=="sz/stp"){$szine_poz="11";}
        if($szine=="tarka"){$szine_poz="12";}
        if($szine=="vlp"){$szine_poz="13";}
        //print "<br>SZIEN:".$szine;
        //print "<br>POZ:".$szine_poz;
        //meghatározni az array-ben a poziciót, a SELECT -hez
        //$szine_poz=array_search($lo_szine,$szine_array);

        //form összeállítás
////            $form_sel_szine_array=$szine_array;
////            $form_hidden_stadium = form_hidden("stadium", "elso_form"); 
////            $form_hidden_fv .= form_hidden("fv", "mod");    
////            $form_hidden_lonev .= form_hidden("lonev_elozo", $lonev);   
////            $form_hidden_ev .= form_hidden("ev_elozo", $ev);    
////            $form_hidden_no .= form_hidden("no", $lo_no);   
////            $form_sel_szine = "<br><br>".form_select(drupal_convert_to_utf8("Színe", "iso-8859-2"), "szine", $szine_poz, $szine_array, "", "size=1");
        //$form_text_szine .= drupal_convert_to_utf8("...vagy esetleg:", "iso-8859-2").form_textfield(drupal_convert_to_utf8("", "iso-8859-2"), "szine_esetleg", "", 5, 5);

    //neme
        $neme_res = db_query("SELECT neme FROM lovak WHERE lo_vagy_fed='LO' GROUP BY neme");
        while($egysor = db_fetch_array($neme_res)) {$neme_array[] = $egysor["neme"];}
        //meghatározni az array-ben a poziciót, a SELECT -hez
        $neme_poz=array_search($lo_neme,$neme_array);
        
//      print "<br>nemepoz:".$neme_poz;
        //form összeállítás
////            $form_sel_neme = "<br><br>".form_select(drupal_convert_to_utf8("Neme", "iso-8859-2"), "neme", $neme_poz, $neme_array, "", "size=1");
            
    //ellet


        //form összeállítás
////            $form_text_ellet = "<br><br>".form_textfield(drupal_convert_to_utf8("Született (pl: 02.19)", "iso-8859-2"), "ellet", $lo_ellet, 1, 5);
    
    //rek
        //form összeállítás
////            $form_text_rek = "<br><br>".form_textfield("Rek (pl:  1.20,0)", "rek", $lo_rek, 1, 6);
        
    
    //pénz
        //form összeállítás
////            $form_text_penz = "<br><br>".form_textfield(drupal_convert_to_utf8("Pénz", "iso-8859-2"), "penz", $lo_penz, 6, 11, "Ft.-");
        
    //bélyeg
        //form összeállítás
////            $form_text_belyeg = "<br><br>".form_textfield(drupal_convert_to_utf8("Bélyeg", "iso-8859-2"), "belyeg", $lo_belyeg, 1, 5);
        
    //tulajdonos
        //feltölteni $nevel_array -t a SELECT -hez
        $tulajdonos_res = db_query("SELECT tulajdonos FROM lovak where lo_vagy_fed='LO' GROUP BY tulajdonos");
        while($egysor = db_fetch_array($tulajdonos_res)) {$tulajdonos_array[] = $egysor["tulajdonos"];}
        $tulajdonos_array[]="";
        //meghatározni az array-ben a poziciót, a SELECT -hez
        $tulajdonos_poz=array_search($lo_tulajdonos,$tulajdonos_array);

    //nevel
        //feltölteni $nevel_array -t a SELECT -hez
        $nevel_res = db_query("SELECT nevel FROM lovak where lo_vagy_fed='LO'GROUP BY nevel");
        while($egysor = db_fetch_array($nevel_res)) {$nevel_array[] = $egysor["nevel"];}
        $nevel_array[]="";
        //meghatározni az array-ben a poziciót, a SELECT -hez
        $nevel_poz=array_search($lo_nevel,$nevel_array);

        //form összeállítás
////            $form_sel_nevel = "<br><br>".form_select(drupal_convert_to_utf8("Nevel", "iso-8859-2"), "nevel", $nevel_poz, $nevel_array, "", "size=1");
////            $form_text_nevel .= drupal_convert_to_utf8("&nbsp; &nbsp; &nbsp; &nbsp;  &nbsp; ...vagy esetleg:", "iso-8859-2").form_textfield(drupal_convert_to_utf8("", "iso-8859-2"), "nevel_esetleg", "", 50, 60);

    //orszag
        //feltölteni $orszag_array -t a SELECT -hez
        $orszag_res = db_query("SELECT orszag FROM lovak where lo_vagy_fed='LO'GROUP BY orszag");
        while($egysor = db_fetch_array($orszag_res)) {$orszag_array[] = $egysor["orszag"];}
        $orszag_array[]="";
        
        //meghatározni az array-ben a poziciót, a SELECT -hez
        $orszag_poz=array_search($lo_orszag,$orszag_array);
        
        //form összeállítás
////            $form_sel_orszag_array=$orszag_array;
////            $form_sel_orszag = "<br><br>".form_select(drupal_convert_to_utf8("ország", "iso-8859-2"), "orszag", $orszag_poz, $orszag_array, "", "size=1");
////            $form_text_orszag .= drupal_convert_to_utf8("...vagy esetleg:", "iso-8859-2").form_textfield(drupal_convert_to_utf8("", "iso-8859-2"), "orszag_esetleg", "", 6, 5);
        
    //apja
        //feltölteni $apja_array -t a SELECT -hez
        $apja_res = db_query("SELECT apja FROM lovak where lo_vagy_fed='LO' GROUP BY apja");
        while($egysor = db_fetch_array($apja_res)) {$apja_array[] = $egysor["apja"];}
        $apja_array[]="";
        //meghatározni az array-ben a poziciót, a SELECT -hez
        $apja_poz=array_search($lo_apja,$apja_array);
        //form összeállítás
////            $form_sel_apja_array=$apja_array;
////            $form_sel_apja = "<br><br>".form_select(drupal_convert_to_utf8("Apja", "iso-8859-2"), "apja", $apja_poz, $apja_array, "", "size=1");
////            $form_text_apja .= drupal_convert_to_utf8("...vagy esetleg:", "iso-8859-2").form_textfield(drupal_convert_to_utf8("", "iso-8859-2"), "apja_esetleg", "", 20, 30);



//apja_ev
        //form összeállítás
////            $form_text_apja_ev = "<br><br>".form_textfield(drupal_convert_to_utf8("Apja evjárat", "iso-8859-2"), "apja_ev", $lo_apja_ev, 2, 4, "");

    //apja_2
        //feltölteni $apja_array -t a SELECT -hez
        $apja_2_res = db_query("SELECT apja FROM lovak where lo_vagy_fed='LO' GROUP BY apja");
        while($egysor = db_fetch_array($apja_2_res)) {$apja_2_array[] = $egysor["apja"];}
        $apja_2_array[]="";
        //meghatározni az array-ben a poziciót, a SELECT -hez
        $apja_2_poz=array_search($lo_apja_2,$apja_2_array);
        //form összeállítás
////            $form_sel_apja_2_array=$apja_2_array;
////            $form_sel_apja_2 = "<br><br>".form_select(drupal_convert_to_utf8("Apja_2", "iso-8859-2"), "apja_2", $apja_2_poz, $apja_2_array, "", "size=1");
////            $form_text_apja_2 .= drupal_convert_to_utf8("...vagy esetleg:", "iso-8859-2").form_textfield(drupal_convert_to_utf8("", "iso-8859-2"), "apja_2_esetleg", "", 20, 30);



    //apja_2_ev
        //form összeállítás
////            $form_text_apja_2_ev = "<br><br>".form_textfield(drupal_convert_to_utf8("Apja_2 evjárat", "iso-8859-2"), "apja_2_ev", $lo_apja_2_ev, 2, 4, "");



    //anyja
        //feltölteni $anyja_array -t a SELECT -hez
        $anyja_res = db_query("SELECT anyja FROM lovak where lo_vagy_fed='LO' GROUP BY anyja");
        while($egysor = db_fetch_array($anyja_res)) {$anyja_array[] = $egysor["anyja"];}
        $anyja_array[]="";
        //meghatározni az array-ben a poziciót, a SELECT -hez
        $anyja_poz=array_search($lo_anyja,$anyja_array);
        //form összeállítás
////            $form_sel_anyja_array=$anyja_array;
////            $form_sel_anyja = "<br><br>".form_select(drupal_convert_to_utf8("Anyja", "iso-8859-2"), "anyja", $anyja_poz, $anyja_array, "", "size=1");
////            $form_text_anyja .= drupal_convert_to_utf8("...vagy esetleg:", "iso-8859-2").form_textfield(drupal_convert_to_utf8("", "iso-8859-2"), "anyja_esetleg", "", 20, 30);
        

//anyja_ev
        //form összeállítás
////            $form_text_anyja_ev = "<br><br>".form_textfield(drupal_convert_to_utf8("Anyja evjárat", "iso-8859-2"), "anyja_ev", $lo_anyja_ev, 2, 4, "");


    //imp_orszag
        //feltölteni $imp_o_array -t a SELECT -hez
        $imp_orsz_res = db_query("SELECT imp_orsz FROM lovak where lo_vagy_fed='LO' GROUP BY imp_orsz");
        while($egysor = db_fetch_array($imp_orsz_res)) {$imp_orsz_array[] = $egysor["imp_orsz"];}
        $imp_orsz_array[]="";
        //meghatározni az array-ben a poziciót, a SELECT -hez
        $imp_orsz_poz=array_search($lo_imp_orsz,$imp_orsz_array);
        
        $exp_orsz_res = db_query("SELECT exp_orsz FROM lovak where lo_vagy_fed='LO' GROUP BY exp_orsz");
        while($egysor = db_fetch_array($exp_orsz_res)) {$exp_orsz_array[] = $egysor["exp_orsz"];}
        $exp_orsz_array[]="";
        //meghatározni az array-ben a poziciót, a SELECT -hez
        $exp_orsz_poz=array_search($lo_exp_orsz,$exp_orsz_array);
        
        
        
        
        
        
        //form összeállítás
////            $form_sel_imp_orsz_array=$imp_orsz_array;
////            $form_sel_imp_orsz = "<br><br>".form_select(drupal_convert_to_utf8("Imp.orsz", "iso-8859-2"), "imp_orsz", $imp_orsz_poz, $imp_orsz_array, "", "size=1");
////            $form_text_imp_orsz .= drupal_convert_to_utf8("...vagy esetleg:", "iso-8859-2").form_textfield(drupal_convert_to_utf8("", "iso-8859-2"), "imp_orsz_esetleg", "", 6, 5);

    
    //imp_kelt
        //form összeállítás
////            $form_text_imp_kelt = "<br><br>".form_textfield("Imp.kelt (pl: 2001.01.01)", "imp_kelt", $lo_imp_kelt, 6, 10);
        
    //regi_neve
        //form összeállítás
////            $form_text_elozo = "<br><br>".form_textfield(drupal_convert_to_utf8("Elõzõ neve", "iso-8859-2"), "elozo", $lo_elozo, 25, 30);
    
    
    //submit, group
////            $form_submit = "<br><br>".form_submit(drupal_convert_to_utf8("Beküldés", "iso-8859-2"));
////            $group = '<div class="container-inline">' . $form_text_lonev . " &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;" . $form_delete . $form_sel_fedezomen . $form_text_ev . $form_sel_szine . $form_sel_neme . $form_sel_apja . $form_text_apja . $form_text_apja_ev . $form_sel_apja_2 . $form_text_apja_2 . $form_text_apja_2_ev . $form_sel_anyja . $form_text_anyja . $form_text_anyja_ev . $form_hidden_stadium . $form_hidden_lonev . $form_hidden_ev . $form_hidden_no . $form_text_ellet . $form_text_rek . $form_text_penz . $form_text_belyeg . $form_sel_nevel . $form_text_nevel . $form_sel_orszag . $form_text_orszag . $form_sel_imp_orsz . $form_text_imp_orsz . $form_text_imp_kelt . $form_text_elozo . $form_submit .'<div>';
////            $form = form(form_group($lonev." /".$ev."/ ".drupal_convert_to_utf8("adatainak módosítása", "iso-8859-2"), $group));
        if ($lonev!=""){
        print theme("page", $form);
        }
return;
}


function ivadekai($mod="loker", $ordered="-ev", $lo_no=0){
//param $szulo= anyja v apa;

if($mod==""){$mod="loker";}
if($ordered==""){$ordered="-ev";}
if($lo_no==""){$lo_no="0";}


if($mod=="loker"){$t=loker("neve","neve");}

if($mod=="lo_no"){
    $res=db_query("SELECT no, neve, ev, neme, apja, anyja, rekord, penz FROM lovak
    WHERE no = '$lo_no' && lo_vagy_fed='LO'");
    $t=db_fetch_array($res);
}


if($t["neve"]!=""){ 
    $szulo_neve=$t["neve"];
    $szulo_ev=$t["ev"];
    $lo_no=$t["no"];
    $lokernev=preg_replace("/'/","\'",$szulo_neve);
    if($ordered=='rekord'){
        $ivadekai_res = db_query("SELECT neve, ev, szine, neme, apja, anyja, rekord, penz FROM lovak
    WHERE ((apja = '$lokernev' && apja_ev = '$szulo_ev') || (anyja = '$lokernev' && anyja_ev = '$szulo_ev')) && (rekord != 0) && lo_vagy_fed='LO' ORDER BY $ordered");
    }else{
        $ivadekai_res = db_query("SELECT neve, ev, szine, neme, apja, anyja, rekord, penz FROM lovak
    WHERE (apja = '$lokernev' && apja_ev = '$szulo_ev') || (anyja = '$lokernev' && anyja_ev = '$szulo_ev') && lo_vagy_fed='LO' ORDER BY $ordered");
    }
    $ii=0;
    $output="<b>".$szulo_neve.drupal_convert_to_utf8(" <i><font color='#D1B61B'>ivadékai</font></i><br>", "iso-8859-2")."</b>";
    $output.="<table class='losablon' width='550'>";
    $output.="<tr>";$output.="<td>no</td>";$output.="<td>";$output.="<a href='?q=lovak&&ivadekai&&ordered=neve&&lo_no=$lo_no&&mod=lo_no'>neve</a>";
$output.="</td>";$output.="<td>";$output.="<a href='?q=lovak&&ivadekai&&ordered=-ev&&lo_no=$lo_no&&mod=lo_no'>ev</a>";
$output.="</td>";$output.="<td>";$output.="<a href='?q=lovak&&ivadekai&&ordered=apja&&lo_no=$lo_no&&mod=lo_no'>apja</a>";
$output.="</td>";$output.="<td>";$output.="<a href='?q=lovak&&ivadekai&&ordered=anyja&&lo_no=$lo_no&&mod=lo_no'>anyja</a>";
$output.="</td>";$output.="<td>";$output.="<a href='?q=lovak&&ivadekai&&ordered=rekord&&lo_no=$lo_no&&mod=lo_no'>rekord</a>";
$output.="</td>";$output.="<td>";$output.="<a href='?q=lovak&&ivadekai&&ordered=-penz&&lo_no=$lo_no&&mod=lo_no'>penz</a>";
$output.="</td>";
    $sorszam=0;
    while($egysor = db_fetch_array($ivadekai_res)) {
        $sorszam++;
    $output.="<tr>";$output.="<td>$sorszam</td>";$output.="<td>";$output.=$egysor["neve"];
$output.="</td>";$output.="<td>";$output.=$egysor["ev"]." ";$output.=$egysor["szine"];
$output.=$egysor["neme"];
$output.="</td>";$output.="<td>";$output.=$egysor["apja"];
$output.="</td>";$output.="<td>";$output.=$egysor["anyja"];
$output.="</td>";$output.="<td>";$output.=$rek=$egysor["rekord"];
$output.="</td>";$output.="<td>";$output.=$penz=$egysor["penz"]."Ft.";
$output.="</td>";
        $output.="</tr>";
    $ii++;
    }
    $output.="</table>";
    print theme("page", $output);
}
return;
}
function lovak_autocompleteQQ($text) {
  $results = array();
  $query = db_select('colors', 'c');
  $query->condition('c.color', '%' . db_like($text) . '%', 'LIKE')->fields('c', array('color'))->orderBy('color', 'ASC');
  $colors = $query->execute();
  foreach ($colors as $row) {
    $results[$row->color] = check_plain($row->color);
  }
  drupal_json_output($results);
}

function lokerv_form($form, &$form_state) {
    $form['lonev'] = array('#type' => 'textfield', '#title' => drupal_convert_to_utf8('lonev', 'iso-8859-2'),'#default_value' => '', '#maxlength' => 35, '#size' => 22,
                           '#autocomplete_path' => 'lovak/autocompleteNEW','#required' => TRUE);
    $form['submit'] = array('#type' => 'submit','#value' => drupal_convert_to_utf8('k e r e s é s', 'iso-8859-2'));
    return $form;
}
function lovak_utlevel_form($form, &$form_state){
  $form['utlevel'] = array (
      '#title'         => t('file'),
      '#type'          => 'file',
    );
   $form['submit'] = array('#type' => 'submit','#value' => 'upload');
   return $form;
}

function lovak_utlevel_upload_form($form, &$form_state) {
  $form = array();
 
  $form['utlevel_file'] = array(
    '#type' => 'file',
    '#title' => t('Choose a file'),
  );
 
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Upload as utlevel file'),
  );
 
  return $form;
}
function lovak_utlevel_upload_form_submit() {
  $file = file_save_upload('utlevel_file', array('file_validate_extensions'=> array ('xml pdf doc docx rtf txt xls xlsx csv bmp jpg jpeg png gif tiff')),'public://utlevel/');
  // $file = file_save_upload('utlevel_file', array(),'public://files/');
  if ($file) {
   // mail('zoli@uzsoki.hu','HUN',$file->uri);
    //drupal_set_message(t('Thank you for uploading utlevel file. You can download it from @url'), array('@url' => file_create_url($file->uri)));
    
    lovak_utlevel_nyomtat($file->uri);
  }
}

function lovak_utlevel_file_download($uri) {
  // Get the file record based on the URI. If not in the database just return.
  $files = file_load_multiple(array(), array('uri' => $uri));
  if (count($files)) {
    foreach ($files as $item) {
      // Since some database servers sometimes use a case-insensitive comparison
      // by default, double check that the filename is an exact match.
      if ($item->uri === $uri) {
        $file = $item;
        break;
      }
    }
  }
  global $user;
 // if (($file->uid == $user->uid && user_access('download own utlevel files'))
 //   || user_access('download all utlevel files')) {
 //   // Access is granted.
    $headers = file_get_content_headers($file);
    return $headers;
  //}
}


function lovak_utlevel_nyomtat($uri){



//$xml = simplexml_load_file($uri);
if (file_exists($uri)) {
  //mail('zoli@uzsoki.hu','HUN',$uri);
  $xml = simplexml_load_file($uri);
  //$xmlstr=serialize($xml);
  //print_r($xml);
} else {
  exit('Failed to open test.xml.');
}

//mail('zoli@uzsoki.hu','HUN',$xmlstr);

//ez itt már egy jó xml array, lehet feldolgozni

foreach ($xml as $item) {
$lo_azon=$item->lo_azon;
//    print "<br><br>";
//    print_r($item);       
}
//exit;
//print "<br>Lo_azon:".$lo_azon;
require_once('/home/tippmixc/public_html/ugeto7/sites/all/modules/tcpdf/config/lang/eng.php');
require_once('/home/tippmixc/public_html/ugeto7/sites/all/modules/tcpdf/tcpdf.php');
$pdf = new TCPDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);

// set document information
$pdf->SetCreator(PDF_CREATOR);
$pdf->SetAuthor('Ugeto Tenyesztok Országos Egyesulete');
$pdf->SetTitle('Loutlevel');
$pdf->SetSubject($lonev);
$pdf->SetKeywords('TCPDF, PDF, example, test, guide');

// set default header data
$pdf->SetHeaderData('', 0, '', '', array(0,0,0), array(0,0,0));
$pdf->setFooterData(array(0,0,0), array(0,0,0));

// set header and footer fonts
$pdf->setHeaderFont(Array(PDF_FONT_NAME_MAIN, '', PDF_FONT_SIZE_MAIN));
$pdf->setFooterFont(Array(PDF_FONT_NAME_DATA, '', PDF_FONT_SIZE_DATA));
$pdf->setPrintHeader(false);
$pdf->setPrintFooter(false);

// set default monospaced font
$pdf->SetDefaultMonospacedFont(PDF_FONT_MONOSPACED);

// set margins
$pdf->SetMargins(PDF_MARGIN_LEFT, PDF_MARGIN_TOP, PDF_MARGIN_RIGHT);
$pdf->SetHeaderMargin(PDF_MARGIN_HEADER);
$pdf->SetFooterMargin(PDF_MARGIN_FOOTER);
// set auto page breaks
$pdf->SetAutoPageBreak(TRUE, PDF_MARGIN_BOTTOM);

// set image scale factor
$pdf->setImageScale(PDF_IMAGE_SCALE_RATIO);

// set some language-dependent strings (optional)
if (@file_exists(dirname(__FILE__).'/lang/eng.php')) {

    require_once(dirname(__FILE__).'/lang/eng.php');
    $pdf->setLanguageArray($l);
}

// ---------------------------------------------------------

// set default font subsetting mode
$pdf->setFontSubsetting(true);



// Set font
$font='freeserif';
$fontsize=14;
// dejavusans is a UTF-8 Unicode font, if you only need to
// print standard ASCII chars, you can use core fonts like
// helvetica or times to reduce file size.
$pdf->SetFont($font, '', 14, '', true);

// Add a page
// This method has several options, check the source code documentation for more information.
$pdf->AddPage();

// set text shadow effect
$pdf->setTextShadow(array('enabled'=>true, 'depth_w'=>0.2, 'depth_h'=>0.2, 'color'=>array(196,196,196), 'opacity'=>1, 'blend_mode'=>'Normal'));

$pdf->SetFont('dejavusans', '', $fontsize, '', true);
$pdf->Cell(50, 0, $lo_azon, 0, 0, 'R', 0);
$pdf->SetFont('dejavusans', 'B', $fontsize, '', true);
$pdf->Cell(20, 0, $lo_azon, 0, 0, 'L', 0);



$pdf->Output('utlevel.pdf', 'I'); 

//============================================================+
// END OF FILE
//============================================================+





exit;
}





function lovak_autocomplete($string = '') {
//$string=substr($string,1);
//print "<br>MOD:".$mod;
//print "<br>vid:".$vid;
$regexp = '%(?:^|,\ *)("(?>[^"]*)(?>""[^"]* )*"|(?: [^",]*))%x';
//<?php

//print "<br>autoc";
$vid='a'; 
  preg_match_all($regexp, $string, $matches);
  $array = $matches[1];

  // Fetch last tag
  $string = trim(array_pop($array));


  $matches = array();
  if ($string) {
     // Csak HU APAMÉN
     if($vid=='m'){
        $result = db_query_range("SELECT no, apja, apja_ev, apja_orszag FROM {lovak} WHERE LOWER(apja) LIKE LOWER('%s%%') && orszag = 'HU' && lo_vagy_fed='LO' GROUP BY apja ORDER BY apja", $string, 0, 30);
        while ($user = db_fetch_object($result)) {
            $matches[$user->apja.'--'.$user->apja_ev.'--'.$user->apja_orszag] = check_plain($user->apja.'--'.$user->apja_ev.'--'.$user->apja_orszag);
        }

    }
    // Csak APAMÉN
    if($vid=='x'){
        $result = db_query_range("SELECT no, apja, apja_ev, apja_orszag FROM {lovak} WHERE LOWER(apja) LIKE LOWER('%s%%') && lo_vagy_fed='LO' GROUP BY apja ORDER BY apja", $string, 0, 30);
        while ($user = db_fetch_object($result)) {
            $matches[$user->apja.'--'.$user->apja_ev.'--'.$user->apja_orszag] = check_plain($user->apja.'--'.$user->apja_ev.'--'.$user->apja_orszag);
        }

    }
     // Csak HU ANYAKANCA
     if($vid=='y'){
        $result = db_query_range("SELECT no, anyja, anyja_ev, anyja_orszag FROM {lovak} WHERE LOWER(anyja) LIKE LOWER('%s%%') && orszag = 'HU' && lo_vagy_fed='LO' GROUP BY anyja ORDER BY anyja", $string, 0, 30);
        while ($user = db_fetch_object($result)) {
            $matches[$user->anyja.'--'.$user->anyja_ev.'--'.$user->anyja_orszag] = check_plain($user->anyja.'--'.$user->anyja_ev.'--'.$user->anyja_orszag);
        }

    }
    // Csak ANYAKANCA
     if($vid=='z'){
        $result = db_query_range("SELECT no, anyja, anyja_ev, anyja_orszag FROM {lovak} WHERE LOWER(anyja) LIKE LOWER('%s%%') && lo_vagy_fed='LO' GROUP BY anyja ORDER BY anyja", $string, 0, 30);
        while ($user = db_fetch_object($result)) {
            $matches[$user->anyja.'--'.$user->anyja_ev.'--'.$user->anyja_orszag] = check_plain($user->anyja.'--'.$user->anyja_ev.'--'.$user->anyja_orszag);
        }

    }
    // Csak simán LÓ, akár KANCA akár MÉN
    if($vid=='a'){
      //print "<br>a";
        //$result = db_query_range("SELECT no, neve, ev, orszag FROM {lovak} WHERE LOWER(neve) LIKE LOWER('%s%%') && lo_vagy_fed='LO' ORDER BY neve", $string, 0, 30);
        $query = db_select('lovak', 'l');
        $query
        ->condition('l.neve', db_like($string) . '%', 'LIKE')
        ->condition('l.lo_vagy_fed', 'LO', '=')
        ->fields('l', array('no','neve','ev','orszag','lo_vagy_fed'))
        ->orderBy('neve', 'ASC');
        $result = $query->execute();

        foreach ($result as $row) {
          //$matches[$row->color] = check_plain($row->color);
          $matches[$row->neve.'--'.$row->ev.'--'.$row->orszag] = check_plain($row->neve.'--'.$row->ev.'--'.$row->orszag);
        }
    }
    // Csak KANCA
    if($vid=='n'){
        $result = db_query_range("SELECT no, neve, ev, orszag FROM {lovak} WHERE neme = 'k' && LOWER(neve) LIKE LOWER('%s%%') && lo_vagy_fed='LO' ORDER BY neve", $string, 0, 30);
        while ($user = db_fetch_object($result)) {
            $matches[$user->neve.'--'.$user->ev.'--'.$user->orszag] = check_plain($user->neve.'--'.$user->ev.'--'.$user->orszag);
        }
    }
    // Csak NEM KANCA
    if($vid=='p'){
        $result = db_query_range("SELECT no, neve, ev, orszag FROM {lovak} WHERE neme != 'k' && LOWER(neve) LIKE LOWER('%s%%') && lo_vagy_fed='LO' ORDER BY neve", $string, 0, 30);
        while ($user = db_fetch_object($result)) {
            $matches[$user->neve.'--'.$user->ev.'--'.$user->orszag] = check_plain($user->neve.'--'.$user->ev.'--'.$user->orszag);
        }
    }
    // FEDEZTETES és LÓ //adminnak ez kell
    if($vid=='f'){
        $result = db_query_range("SELECT no, neve, ev, orszag FROM {lovak} WHERE LOWER(neve) LIKE LOWER('%s%%') ORDER BY neve", $string, 0, 30);
        while ($user = db_fetch_object($result)) {
            $matches[$user->neve.'--'.$user->ev.'--'.$user->orszag] = check_plain($user->neve.'--'.$user->ev.'--'.$user->orszag);
        }
    }
    if($vid=='t'){
        $result = db_query_range("SELECT tulajdonos FROM {tulajdonos} WHERE LOWER(tulajdonos) LIKE LOWER('%s%%') && lo_vagy_fed='LO' ORDER BY tulajdonos", $string, 0, 30);
        while ($user = db_fetch_object($result)) {
            $matches[$user->tulajdonos] = check_plain($user->tulajdonos);
        }
    }

  }
  drupal_json_output($matches);
  //exit();
}



function lovak_new_form() {
global $no;
    $szine_array=array('', 'f', 'f/sz', 'p', 'p/stp', 'p/vlp', 's', 'stp', 'stp/f', 'stp/sz', 'sz', 'sz/stp','tarka', 'vlp');
    $neme_array=array('', 'm', 'k', 'h');
    $lo_vagy_fed_array=array('LO', 'FEDEZTETES', 'SIKERTELEN FEDEZTETES', 'JELENTES NEM ERKEZETT', 'VETELT', 'HOLT ELLES', 'ELETKEPTELEN', 'IKREKET VETELT', 'XX OTA JELENTES NEM ERKEZETT');
            
    $fedezomen_array=array('NEM', 'IGEN');
    $aktiv_array=array('NEM', 'IGEN');
    $torles_array=array('-', '!!! TORLES !!!', '!!! utolso TULAJ TORLES !!!');
    $torles="-";
    if($no>0){
    //print "<br>no:".$no;
        $res=db_query("SELECT * FROM lovak WHERE no='$no'");
        while($egysor = db_fetch_array($res)) {
            $lonev=$egysor["neve"]."--".$egysor["ev"]."--".$egysor["orszag"];
            $szine=$egysor["szine"];
            $szine=array_search($szine, $szine_array);
            $neme=$egysor["neme"];
            $neme=array_search($neme, $neme_array);
            $lonev_anyja=$egysor["anyja"]."--".$egysor["anyja_ev"]."--".$egysor["anyja_orszag"];
            $lonev_apja=$egysor["apja"]."--".$egysor["apja_ev"]."--".$egysor["apja_orszag"];
            $rekord=$egysor["rekord"];
            $penz=$egysor["penz"];
            $fedez=$egysor["fedez"];
            $ellet=$egysor["ellet"];
            $belyeg=$egysor["belyeg"];
            //$tulajdonos=$egysor["tulajdonos"];
            //$tuldat=date("Y-m-d");
            $nevel=$egysor["nevel"];
            $imp_orsz=$egysor["imp_orsz"];
            $imp_kelt=$egysor["imp_kelt"];
            $exp_orsz=$egysor["exp_orsz"];
            $exp_kelt=$egysor["exp_kelt"];
            $kimult_kelt=$egysor["kimult"];
            $kiherelve_kelt=$egysor["herel"];
            $elozo=$egysor["elozo"];
            $fedezomen=$egysor["fedezomen"];
            $aktiv=$egysor["aktiv"];
            $lo_vagy_fed=$egysor["lo_vagy_fed"];
            $fedezomen=array_search($fedezomen, $fedezomen_array);
            $aktiv=array_search($aktiv, $aktiv_array);
            $lo_vagy_fed=array_search($lo_vagy_fed, $lo_vagy_fed_array);
            $egybevetes=$egysor["egybevetes"];
            $loazon=$egysor["loazon"];
            $transzponder=$egysor["transzponder"];
            $ueln=$egysor["ueln"];
            //$utlevel=$egysor["utlevel"];
            $megjegyzes=$egysor["megjegyzes"];
            $szures=$egysor["szures"];
            
            //print "<br>szine:".$szine;
            //print "<br>neme:".$neme;
            //print "<br>fedezomen:".$fedezomen;
        }
        //utolsó tulajdonos kikeresése
        $restulaj=db_query("SELECT * FROM tulajdonos WHERE no='$no' ORDER BY datum DESC LIMIT 1");
            while($egysor = db_fetch_array($restulaj)) {
                $tuldat=$egysor["datum"];
                $tulajdonos=$egysor["tulajdonos"];
            }
            if($tuldat == ''){
                //$tuldat=date("Y-m-d");
            }

        //összes eddigi tulajdonos kikeresése
        $restulaj=db_query("SELECT * FROM tulajdonos WHERE no='$no' ORDER BY datum DESC");
            if(db_affected_rows()){
                $tulajdonos_osszes='<br><b>Eddigi tulajdonosok:</b><br>';
            }
            while($egysor = db_fetch_array($restulaj)) {
                $tulajdonos_osszes.=$egysor["datum"];
                $tulajdonos_osszes.="-";
                $tulajdonos_osszes.=$egysor["tulajdonos"];
                $tulajdonos_osszes.="<br>";
            }
    }else{
        $lonev="";
        $szine="p";
        $neme="k";
        $lonev_anyja="";
        $lonev_apja="";
        $rekord="";
        $penz="";
        $fedez="";
        $ellet="";
        $belyeg="";
        $tulajdonos="";
        $tulajdonos_osszes="";
        //$tuldat=date("Y-m-d");
        $tuldat="";
        $nevel="";
        $imp_orsz="";
        $imp_kelt="";
        $exp_orsz="";
        $exp_kelt="";
        $kimult_kelt="";
        $kiherelve_kelt="";
        $elozo="";
        $fedezomen="NEM";
        $aktiv="NEM";
        $lo_vagy_fed="LO";
        $egybevetes="";
        $loazon="";
        $transzponder="";
        $ueln="";
        //$utlevel="";
        $megjegyzes="";
        $szures="";
    }

    $form['lo_vagy_fed'] = array('#type' => 'select','#title' =>'LO vagy FEDEZTETES vagy SIKERTELEN FEDEZTETES STB...','#default_value' => $lo_vagy_fed,'#options' => $lo_vagy_fed_array);
    if($no>0){ //tehát modositas
        $form['lonev'] = array('#type' => 'textfield','#title' => 'L &Oacute; N &Eacute; V:<br>L&oacute;n&eacute;v--sz&uuml;l&eacute;v--ORSZ&Aacute;G','#default_value' => $lonev,'#maxlength' => 35,'#size' => 35,'#required' => TRUE);
    }else{     //tehat uj
        $form['lonev'] = array('#type' => 'textfield','#title' => 'L &Oacute; N &Eacute; V:<br>L&oacute;n&eacute;v--sz&uuml;l&eacute;v--ORSZ&Aacute;G','#default_value' => $lonev,'#maxlength' => 35,'#size' => 35,'#required' => TRUE);
    }
    $form['szine'] = array('#type' => 'select','#title' =>'S Z &Iacute; N E','#default_value' => $szine,'#options' => $szine_array);
    $form['neme'] = array('#type' => 'select','#title' =>'N E M E','#default_value' => $neme,'#options' => $neme_array);
    $form['lonev_apja'] = array('#type' => 'textfield','#title' => 'A P J A :<br>L&oacute;n&eacute;v--sz&uuml;l&eacute;v--ORSZ&Aacute;G','#default_value' => $lonev_apja, '#maxlength' => 35, '#autocomplete_path' => 'lovak/autocomplete/p');
    $form['lonev_anyja'] = array('#type' => 'textfield','#title' => 'A N Y J A :<br>L&oacute;n&eacute;v--sz&uuml;l&eacute;v--ORSZ&Aacute;G','#default_value' => $lonev_anyja, '#maxlength' => 35, '#autocomplete_path' => 'lovak/autocomplete/n');
    $form['rekord'] = array('#type' => 'textfield','#title' => 'R E K O R D :<br>1.11,1','#default_value' => $rekord,'#maxlength' => 6,'#size' => 4);
    $form['penz'] = array('#type' => 'textfield','#title' => 'P &Eacute; N Z :<br>12345678','#default_value' => $penz,'#maxlength' => 11,'#size' => 8);
    $form['aktiv'] = array('#type' => 'select','#title' =>'A K T I V :','#default_value' => $aktiv,'#options' => $aktiv_array);
    $form['fedez'] = array('#type' => 'textfield','#title' => 'F E D E Z V E:<br>04.11','#default_value' => $fedez,'#maxlength' => 7,'#size' => 6);
    $form['ellet'] = array('#type' => 'textfield','#title' => 'S Z &Uuml; L E T E T T :<br>02.13','#default_value' => $ellet,'#maxlength' => 5,'#size' => 4);
    $form['belyeg'] = array('#type' => 'textfield','#title' => 'B &Eacute; L Y E G','#default_value' => $belyeg,'#maxlength' => 20,'#size' => 10);
    $form['tulajdonos'] = array('#type' => 'textfield','#title' => drupal_convert_to_utf8('T U L A J D O N O S', 'iso-8859-2'),'#default_value' => $tulajdonos,'#maxlength' => 60,'#size' => 30, '#autocomplete_path' => 'lovak/autocomplete/t', '#description' => $tulajdonos_osszes);
//  $form['tulajdonos_osszes'] = array('#type' => 'textfield','#title' => drupal_convert_to_utf8('összes eddigi tulajdonos', 'iso-8859-2'),'#default_value' => $tulajdonos_osszes,'#maxlength' => 300,'#size' => 300);
    $form['tuldat'] = array('#type' => 'textfield','#title' => 'T U L. V &Aacute; L T. D &Aacute; T U M A: <br>eeee-hh-nn','#default_value' => $tuldat,'#maxlength' => 10,'#size' => 10);
    $form['nevel'] = array('#type' => 'textfield','#title' => drupal_convert_to_utf8('T E N Y &Eacute; S Z T &Otilde;', 'iso-8859-2'),'#default_value' => $nevel,'#maxlength' => 60,'#size' => 30);
    $form['imp_orsz'] = array('#type' => 'textfield','#title' => 'I M P. O R S Z &Aacute; G :<br>SE','#default_value' => $imp_orsz,'#maxlength' => 3,'#size' => 2);
    $form['imp_kelt'] = array('#type' => 'textfield','#title' => 'I M P. K E L T :<br>1999.11','#default_value' => $imp_kelt,'#maxlength' => 10,'#size' => 8);
    $form['exp_orsz'] = array('#type' => 'textfield','#title' => 'E X P. O R S Z &Aacute; G :<br>SE','#default_value' => $exp_orsz,'#maxlength' => 3,'#size' => 2);
    $form['exp_kelt'] = array('#type' => 'textfield','#title' => 'E X P. K E L T :<br>1999.11','#default_value' => $exp_kelt,'#maxlength' => 10,'#size' => 8);
    $form['kimult_kelt'] = array('#type' => 'textfield','#title' => 'K I M U L T  K E L T :<br>1999.11','#default_value' => $kimult_kelt,'#maxlength' => 10,'#size' => 8);
    $form['kiherelve_kelt'] = array('#type' => 'textfield','#title' => 'K I H E R E L V E  K E L T :<br>1999.11','#default_value' => $kiherelve_kelt,'#maxlength' => 10,'#size' => 8);
    $form['elozo'] = array('#type' => 'textfield','#title' => 'E L &Otilde; Z &Otilde;','#default_value' => $elozo,'#maxlength' => 25,'#size' => 20);
    $form['fedezomen'] = array('#type' => 'select','#title' =>'F E D E Z &Otilde; M &Eacute; N','#default_value' => $fedezomen,'#options' => $fedezomen_array);
    $form['loazon'] = array('#type' => 'textfield','#title' => 'L O   A Z O N O S I T O','#default_value' => $loazon,'#maxlength' => 15,'#size' => 15);
    $form['transzponder'] = array('#type' => 'textfield','#title' => 'T R A N S P O N D E R','#default_value' => $transzponder,'#maxlength' => 15,'#size' => 15);
    $form['ueln'] = array('#type' => 'textfield','#title' => 'U E L N','#default_value' => $ueln,'#maxlength' => 15,'#size' => 15);
    //$form['utlevel'] = array('#type' => 'textfield','#title' => 'U T L E V E L','#default_value' => $utlevel,'#maxlength' => 15,'#size' => 15);
    $form['megjegyzes'] = array('#type' => 'textfield','#title' => 'M E G J E G Y Z E S','#default_value' => $megjegyzes,'#maxlength' => 100,'#size' => 25);
    $form['szures'] = array('#type' => 'textfield','#title' => 'S Z U R E S','#default_value' => $szures,'#maxlength' => 10,'#size' => 10);
    
    
    
    
    $form['egybevetes'] = array('#type' => 'textfield','#title' => 'Egybevet&eacute;s (az &eacute;rkez&otilde; adatokn&aacute;l ezen l&oacute;nak a hib&aacute;s form&aacute;tum&aacute;t lehet itt megadni):<br>lonev','#default_value' => $egybevetes,'#maxlength' => 100,'#size' => 100);

    $form['torles'] = array('#type' => 'select','#title' =>'l&oacute; t&ouml;rl&eacute;se','#default_value' => $torles,'#options' => $torles_array);

    //$form['stadium'] = array('#type' => 'hidden','#value' => 'TEXT_VAL');
    $form['submit'] = array('#type' => 'submit','#value' => drupal_convert_to_utf8('f e l v i t e l', 'iso-8859-2'));

    return $form;
}

function lokerfed_form() {
    //$form['stadium'] = array('#type' => 'hidden','#value' => 'TEXT_VAL');
    $form['lonev'] = array('#type' => 'textfield', '#title' => drupal_convert_to_utf8('', 'iso-8859-2'),'#default_value' => '', '#maxlength' => 35, '#size' => 32,'#autocomplete_path' => 'lovak/autocomplete/f','#required' => TRUE);
    $form['submit'] = array('#type' => 'submit','#value' => drupal_convert_to_utf8('k e r e s é s', 'iso-8859-2'));
    return $form;
}

function lista_vari_form() {
//  $evjarat_array=array('1982','1983','1984','1985','1986','1987','1988','1989','1990','1991','1992','1993','1994','1995','1996','1997','1998','1999','2000','2001','2002','2003','2004','2005');
    //$form['stadium'] = array('#type' => 'hidden','#value' => 'TEXT_VAL');
    $form['apja'] = array('#type' => 'textfield','#title' => drupal_convert_to_utf8('Apja', 'iso-8859-2'),'#default_value' => '', '#maxlength' => 35, '#autocomplete_path' => 'lovak/autocomplete/a','#required' => FALSE);
    $form['anyja'] = array('#type' => 'textfield','#title' => drupal_convert_to_utf8('Anyja', 'iso-8859-2'),'#default_value' => '', '#maxlength' => 35, '#autocomplete_path' => 'lovak/autocomplete/n','#required' => FALSE);
//  $form['ev'] = array('#type' => 'select','#title' =>'&Eacute;vj&aacute;rat','#default_value' => $ev,'#options' => $evjarat_array);
    $form['ev'] = array('#type' => 'textfield','#title' => drupal_convert_to_utf8('Evj&aacute;rat (pl.1998 vagy 1997-2002)', 'iso-8859-2'),'#default_value' => '', '#maxlength' => 9, '#size' => 9, '#required' => FALSE);
    $form['orszag'] = array('#type' => 'textfield','#title' => drupal_convert_to_utf8('Orsz&aacute;g (&uuml;resre &aacute;ll&iacute;tva nincs sz&ucirc;r&eacute;s)', 'iso-8859-2'),'#default_value' => 'HU', '#maxlength' => 2, '#size' => 3, '#required' => FALSE);
    $form['rekord'] = array('#type' => 'textfield','#title' => drupal_convert_to_utf8('Rekord "alatt" (&uuml;resre &aacute;ll&iacute;tva nincs sz&ucirc;r&eacute;s)', 'iso-8859-2'),'#default_value' => '1.20,0', '#maxlength' => 35, '#required' => FALSE);
    $form['penz'] = array('#type' => 'textfield','#title' => drupal_convert_to_utf8('Nyerem&eacute;ny "felett" (&uuml;resre &aacute;ll&iacute;tva nincs sz&ucirc;r&eacute;s)', 'iso-8859-2'),'#default_value' => '1000000', '#maxlength' => 35, '#required' => FALSE);
    $form['nevel'] = array('#type' => 'textfield','#title' => drupal_convert_to_utf8('Teny&eacute;szt&otilde; (el&eacute;g csak sz&oacute;t&ouml;red&eacute;ket be&iacute;rni)', 'iso-8859-2'),'#default_value' => '', '#maxlength' => 35, '#required' => FALSE);
    $form['tulajdonos'] = array('#type' => 'textfield','#title' => drupal_convert_to_utf8('Tulajdonos (el&eacute;g csak sz&oacute;t&ouml;red&eacute;ket be&iacute;rni)', 'iso-8859-2'),'#default_value' => '', '#maxlength' => 35, '#required' => FALSE);
    $form['submit'] = array('#type' => 'submit','#value' => drupal_convert_to_utf8('M e h e t', 'iso-8859-2'));
    return $form;
}
function lista_ujlovak_form() {
    $year=date("Y");
    $month=date("m");                                                      
    $def=$year.'-'.$month;
    $form['evho'] = array('#type' => 'textfield','#title' => drupal_convert_to_utf8('&Eacute;v-h&oacute;', 'iso-8859-2'),'#default_value' => $def, '#maxlength' => 7, '#size' => 5, '#required' => FALSE);
//  $form['rekord'] = array('#type' => 'textfield','#title' => drupal_convert_to_utf8('Rekord "alatt"', 'iso-8859-2'),'#default_value' => '1.20,0', '#maxlength' => 35, '#required' => FALSE);
    //$form['orszag'] = array('#type' => 'textfield','#title' => drupal_convert_to_utf8('Orsz&aacute;g (&uuml;resre &aacute;ll&iacute;tva nincs sz&ucirc;r&eacute;s)', 'iso-8859-2'),'#default_value' => 'HU', '#maxlength' => 2, '#size' => 3, '#required' => FALSE);
//  $form['rendezes'] = array('#type' => 'select','#title' =>'Sorbarendez&eacute;s szempontja','#default_value' => 'rekord','#options' => array('rekord','nev','apa'));
    $form['submit'] = array('#type' => 'submit','#value' => drupal_convert_to_utf8('M e h e t', 'iso-8859-2'));
    return $form;
}

function lista_modlovak_form() {
    $year=date("Y");
    $month=date("m");                                                      
    $def=$year.'-'.$month;
    $form['evho'] = array('#type' => 'textfield','#title' => drupal_convert_to_utf8('&Eacute;v-h&oacute;', 'iso-8859-2'),'#default_value' => $def, '#maxlength' => 7, '#size' => 5, '#required' => FALSE);
//  $form['rekord'] = array('#type' => 'textfield','#title' => drupal_convert_to_utf8('Rekord "alatt"', 'iso-8859-2'),'#default_value' => '1.20,0', '#maxlength' => 35, '#required' => FALSE);
    //$form['orszag'] = array('#type' => 'textfield','#title' => drupal_convert_to_utf8('Orsz&aacute;g (&uuml;resre &aacute;ll&iacute;tva nincs sz&ucirc;r&eacute;s)', 'iso-8859-2'),'#default_value' => 'HU', '#maxlength' => 2, '#size' => 3, '#required' => FALSE);
//  $form['rendezes'] = array('#type' => 'select','#title' =>'Sorbarendez&eacute;s szempontja','#default_value' => 'rekord','#options' => array('rekord','nev','apa'));
    $form['submit'] = array('#type' => 'submit','#value' => drupal_convert_to_utf8('M e h e t', 'iso-8859-2'));
    return $form;
}

function lista_modtullovak_form() {
    $year=date("Y");
    $month=date("m");                                                      
    $def=$year.'-'.$month;
    $form['evho'] = array('#type' => 'textfield','#title' => drupal_convert_to_utf8('&Eacute;v-h&oacute;', 'iso-8859-2'),'#default_value' => $def, '#maxlength' => 7, '#size' => 5, '#required' => FALSE);
//  $form['rekord'] = array('#type' => 'textfield','#title' => drupal_convert_to_utf8('Rekord "alatt"', 'iso-8859-2'),'#default_value' => '1.20,0', '#maxlength' => 35, '#required' => FALSE);
    //$form['orszag'] = array('#type' => 'textfield','#title' => drupal_convert_to_utf8('Orsz&aacute;g (&uuml;resre &aacute;ll&iacute;tva nincs sz&ucirc;r&eacute;s)', 'iso-8859-2'),'#default_value' => 'HU', '#maxlength' => 2, '#size' => 3, '#required' => FALSE);
//  $form['rendezes'] = array('#type' => 'select','#title' =>'Sorbarendez&eacute;s szempontja','#default_value' => 'rekord','#options' => array('rekord','nev','apa'));
    $form['submit'] = array('#type' => 'submit','#value' => drupal_convert_to_utf8('M e h e t', 'iso-8859-2'));
    return $form;
}

function lista_variforma_form() {
    $form['evad'] = array('#type' => 'textfield','#title' => drupal_convert_to_utf8('&Eacute;vad', 'iso-8859-2'),'#default_value' => '2007', '#maxlength' => 4, '#size' => 5, '#required' => FALSE);
    //$form['penz'] = array('#type' => 'textfield','#title' => drupal_convert_to_utf8('Nyerem&eacute;ny "felett" (&uuml;resre &aacute;ll&iacute;tva nincs sz&ucirc;r&eacute;s)', 'iso-8859-2'),'#default_value' => '1000000', '#maxlength' => 35, '#required' => FALSE);
    $form['rekord'] = array('#type' => 'textfield','#title' => drupal_convert_to_utf8('Rekord "alatt"', 'iso-8859-2'),'#default_value' => '1.20,0', '#maxlength' => 35, '#required' => FALSE);
    //$form['orszag'] = array('#type' => 'textfield','#title' => drupal_convert_to_utf8('Orsz&aacute;g (&uuml;resre &aacute;ll&iacute;tva nincs sz&ucirc;r&eacute;s)', 'iso-8859-2'),'#default_value' => 'HU', '#maxlength' => 2, '#size' => 3, '#required' => FALSE);
    $form['rendezes'] = array('#type' => 'select','#title' =>'Sorbarendez&eacute;s szempontja','#default_value' => 'rekord','#options' => array('rekord','nev','apa','orszag'));
    $form['submit'] = array('#type' => 'submit','#value' => drupal_convert_to_utf8('M e h e t', 'iso-8859-2'));
    return $form;
}

function menstat_form_apara() {
    $form['apja'] = array('#type' => 'textfield','#title' => drupal_convert_to_utf8('Apam&eacute;n meghat&aacute;roz&aacute;sa', 'iso-8859-2'),'#default_value' => '', '#maxlength' => 35, '#autocomplete_path' => 'lovak/autocomplete/m','#required' => FALSE);
    //$form['evad'] = array('#type' => 'textfield','#title' => drupal_convert_to_utf8('&Eacute;vad', 'iso-8859-2'),'#default_value' => '2007', '#maxlength' => 4, '#size' => 5, '#required' => FALSE);
    $form['rekord'] = array('#type' => 'textfield','#title' => drupal_convert_to_utf8('Id&otilde;teljes&iacute;tm&eacute;ny - "alatt" pl. 1.20,0', 'iso-8859-2'),'#default_value' => '1.20,0', '#maxlength' => 35, '#required' => FALSE);
    $form['submit'] = array('#type' => 'submit','#value' => drupal_convert_to_utf8('M e h e t', 'iso-8859-2'));
    return $form;
}
function menstat_form_evjaratra() {
    //$form['apja'] = array('#type' => 'textfield','#title' => drupal_convert_to_utf8('Apam&eacute;n meghat&aacute;roz&aacute;sa', 'iso-8859-2'),'#default_value' => '', '#maxlength' => 35, '#autocomplete_path' => 'lovak/autocomplete/m','#required' => FALSE);
    $form['evad'] = array('#type' => 'textfield','#title' => drupal_convert_to_utf8('&Eacute;vad', 'iso-8859-2'),'#default_value' => '2007', '#maxlength' => 4, '#size' => 5, '#required' => FALSE);
    $form['rekord'] = array('#type' => 'textfield','#title' => drupal_convert_to_utf8('Id&otilde;teljes&iacute;tm&eacute;ny - "alatt" pl. 1.20,0', 'iso-8859-2'),'#default_value' => '1.20,0', '#maxlength' => 35, '#required' => FALSE);
    $form['submit'] = array('#type' => 'submit','#value' => drupal_convert_to_utf8('M e h e t', 'iso-8859-2'));
    return $form;
}


function lista_varipub_form() {
    $evjarat_array=array('1982','1983','1984','1985','1986','1987','1988','1989','1990','1991','1992','1993','1994','1995','1996','1997','1998','1999','2000','2001','2002','2003','2004','2005');
    //$form['stadium'] = array('#type' => 'hidden','#value' => 'TEXT_VAL');
    $form['apja'] = array('#type' => 'textfield','#title' => drupal_convert_to_utf8('APJA (vagy apát, vagy anyát választani kell!)', 'iso-8859-2'),'#default_value' => drupal_convert_to_utf8('', 'iso-8859-2'), '#maxlength' => 35, '#autocomplete_path' => 'lovak/autocomplete/x','#required' => TRUE);
    $form['anyja'] = array('#type' => 'textfield','#title' => drupal_convert_to_utf8('ANYJA (vagy apát, vagy anyát választani kell!)', 'iso-8859-2'),'#default_value' => '', '#maxlength' => 35, '#autocomplete_path' => 'lovak/autocomplete/z','#required' => FALSE);
    $form['orszag'] = array('#type' => 'textfield','#title' => drupal_convert_to_utf8('ORSZÁG (&uuml;resre &aacute;ll&iacute;tva nincs sz&ucirc;r&eacute;s)', 'iso-8859-2'),'#default_value' => 'HU', '#maxlength' => 2, '#size' => 3, '#required' => FALSE);
    //$form['rekord'] = array('#type' => 'textfield','#title' => drupal_convert_to_utf8('Rekord "alatt" (&uuml;resre &aacute;ll&iacute;tva nincs sz&ucirc;r&eacute;s)', 'iso-8859-2'),'#default_value' => '1.20,0', '#maxlength' => 35, '#required' => FALSE);
    //$form['penz'] = array('#type' => 'textfield','#title' => drupal_convert_to_utf8('Nyerem&eacute;ny "felett" (&uuml;resre &aacute;ll&iacute;tva nincs sz&ucirc;r&eacute;s)', 'iso-8859-2'),'#default_value' => '1000000', '#maxlength' => 35, '#required' => FALSE);
    $form['submit'] = array('#type' => 'submit','#value' => drupal_convert_to_utf8('M e h e t', 'iso-8859-2'));
    return $form;
}

function lista_csiko_form($node, &$form_state) {
    $evjarat_array=array('2014','2013','2012','2011','2010','2009','2008','2007','2006','2005','2004','2003','2002','2001','2000','1999','1998','1997','1996','1995','1994','1993','1992','1991','1990','1989','1988','1987','1986','1985','1984','1983','1982','1981','1980','1979','1978','1977','1976','1975','1974','1973','1972','1971','1970','1969','1968','1967','1966','1965','1964','1963','1962','1961','1960');
    $form['ev'] = array('#type' => 'select','#title' =>drupal_convert_to_utf8('Évjárat', 'iso-8859-2'),'#default_value' => 2015,'#options' => $evjarat_array);
//  $form['ev'] = array('#type' => 'textfield','#title' => drupal_convert_to_utf8('Evj&aacute;rat', 'iso-8859-2'),'#default_value' => '2005', '#maxlength' => 4, '#size' => 5, '#required' => FALSE);
    $form['submit'] = array('#type' => 'submit','#value' => drupal_convert_to_utf8('M e h e t', 'iso-8859-2'));
    return $form;
}

function lista_fedeztetes_form() {
    $evjarat_array=array('2014','2013','2012','2011','2010','2009','2008','2007','2006','2005','2004','2003','2002','2001','2000','1999','1998','1997','1996','1995','1994','1993','1992','1991','1990','1989','1988','1987','1986','1985','1984','1983','1982','1981','1980');
    $form['ev'] = array('#type' => 'select','#title' =>drupal_convert_to_utf8('Évjárat', 'iso-8859-2'),'#default_value' => $ev,'#options' => $evjarat_array);
    $form['mk'] = array('#type' => 'select','#title' =>drupal_convert_to_utf8('mén vagy kanca szerint, ill. fedeztetés dátumával', 'iso-8859-2'),'#default_value' => $mk,'#options' => array('M','K','Md','Kd'));
//  $form['ev'] = array('#type' => 'textfield','#title' => drupal_convert_to_utf8('Evj&aacute;rat', 'iso-8859-2'),'#default_value' => '2005', '#maxlength' => 4, '#size' => 5, '#required' => FALSE);
    $form['submit'] = array('#type' => 'submit','#value' => drupal_convert_to_utf8('M e h e t', 'iso-8859-2'));
    return $form;
}


function lokerteny_form() {
    $res=db_query("SELECT neve, ev, orszag FROM lovak WHERE fedezomen='IGEN' && lo_vagy_fed='LO' ORDER BY neve");
    $fedezomen_array[]=drupal_convert_to_utf8('--Válasszon!--', 'iso-8859-2');
    while($egysor = db_fetch_array($res)) {
        $fedezomen_array[]=$egysor["neve"].'--'.$egysor["ev"].'--'.$egysor["orszag"];   
    }
    $form['fedezomen'] = array('#type' => 'select','#title' =>'fedez&otilde;m&eacute;n','#default_value' => '','#options' => $fedezomen_array,'#required' => TRUE);
    $form['anyja'] = array('#type' => 'textfield','#title' => drupal_convert_to_utf8('anya', 'iso-8859-2'),'#default_value' => '', '#maxlength' => 35, '#autocomplete_path' => 'lovak/autocomplete/n','#required' => TRUE);
    $form['submit'] = array('#type' => 'submit','#value' => drupal_convert_to_utf8('M e h e t', 'iso-8859-2'));
    return $form;
}



function loker($kateg="normal", $hova="normal", $block_v_page="block"){
global $user;
$out = drupal_render(drupal_get_form('loker_form'))
;
return $out;
$ret="";
 if(isset($_POST['lonev'])){
 //print_r($_POST['lonev']);
 //return;
    $lonev_ev_o=$_POST['lonev'];
    $lodarabok = explode("--", $lonev_ev_o);
    $lonev=$lodarabok[0];
    $ev=$lodarabok[1];
    $orszag=$lodarabok[2];
    if($kateg == "normal"){
        if(trim($orszag)==""){
            if($ev==0){
                $res=db_query("SELECT no, ev, szine, neme, rekord, penz, tulajdonos, nevel FROM lovak WHERE binary neve = '%s' && ev = 0 && lo_vagy_fed='LO'", $lonev);
            }else{
                $res=db_query("SELECT no, ev, szine, neme, rekord, penz, tulajdonos, nevel FROM lovak WHERE binary neve = '%s' && ev = '%d' && lo_vagy_fed='LO'", $lonev, $ev);
            }
        }else{
            if($ev==0){
                $res=db_query("SELECT no, ev, szine, neme, rekord, penz, tulajdonos, nevel FROM lovak WHERE binary neve = '%s' && orszag = '%s' && ev = 0 && lo_vagy_fed='LO'", $lonev, $orszag);
            }else{
                $res=db_query("SELECT no, ev, szine, neme, rekord, penz, tulajdonos, nevel FROM lovak WHERE binary neve = '%s' && ev = '%d' && orszag = '%s' && lo_vagy_fed='LO'", $lonev, $ev, $orszag);
            }
        }
    }
    if($kateg == "norm_feddel"){
        if(trim($orszag)==""){
            if($ev==0){
                $res=db_query("SELECT no, ev, szine, neme, rekord, penz, tulajdonos, nevel FROM lovak WHERE binary neve = '%s' && ev = 0", $lonev);
            }else{
                $res=db_query("SELECT no, ev, szine, neme, rekord, penz, tulajdonos, nevel FROM lovak WHERE binary neve = '%s' && ev = '%d'", $lonev, $ev);
            }
        }else{
            if($ev==0){
                $res=db_query("SELECT no, ev, szine, neme, rekord, penz, tulajdonos, nevel FROM lovak WHERE binary neve = '%s' && orszag = '%s' && ev = 0", $lonev, $orszag);
            }else{
                $res=db_query("SELECT no, ev, szine, neme, rekord, penz, tulajdonos, nevel FROM lovak WHERE binary neve = '%s' && ev = '%d' && orszag = '%s'", $lonev, $ev, $orszag);
            }
        }
    }
    if($kateg == "anyja"){
        $eredmeny = db_query("SELECT $field, ev, no FROM lovak WHERE $field LIKE '$lokernev%' && neme = 'k' && lo_vagy_fed='LO' ORDER BY $field");
    }
    if($kateg == "apja"){
        $eredmeny = db_query("SELECT $field, ev, no FROM lovak WHERE $field LIKE '$lokernev%' && neme = 'm' && fedezomen = 'IGEN' && lo_vagy_fed='LO' ORDER BY $field");
    }
    while($egysor = db_fetch_array($res)) {
            $lonev_no=$egysor['no'];
            $ev=$egysor['ev'];
            $szine=$egysor['szine'];
            $neme=$egysor['neme'];
            $rekord=$egysor['rekord'];
            $penz=$egysor['penz'];
            $tulajdonos=$egysor['tulajdonos'];
            $nevel=$egysor['nevel'];
    }

    $ret=$lonev_no;
    if($lonev_no == ""){
        $out='';
        $out.='<center><font size="5">'.$lonev.' ???</font><br>
        <img name="nincsilyenlo" src="/themes/ugetomarine/nincsilyenlo.gif" width="400" height="400" border="0" usemap="#m_nincsilyenlo" alt=""><map name="m_nincsilyenlo">
<area shape="rect" coords="115,351,289,379" href="/" alt="" >
<area shape="rect" coords="158,313,246,336" href="/lovak" alt="" >
</map></center>
        ';
        print theme($block_v_page, $out);
        //header("location: /");
        return $ret;
    }
    if($hova=="normal"){
        //megnezni van-e forma adat a FORMA tablaban ehhez a lohoz
        $vaneforma=0;
        $res_lovak=db_query("SELECT neve, ev, orszag, szine, neme FROM lovak WHERE no = '%d'", $no);
        if(db_affected_rows()>=1){
        while($egysor = db_fetch_array($res_lovak)) {
                $lonev=$egysor['neve'];
                $ev=$egysor['ev'];
                $orszag=$egysor['orszag'];
                $szine=$egysor['szine'];
                $neme=$egysor['neme'];

            }
        }
       // print "<br>ev:".$ev;
        $iloid=0;
        $res_lo=db_query("SELECT ILOID FROM LO WHERE SLONEV = '%s'", $lonev);
        $talalt=db_affected_rows();
        if($talalt==1){
            while($egysor = db_fetch_array($res_lo)) {
                $iloid=$egysor['ILOID'];
              //print "<br>iloid:".$iloid;
            }
        }
        //FUTASOK KILISTAZASA NL KFT ADATBAZISABOL, kiveve azokat amik le vannak tiltva
        if($iloid!=0 && $iloid!=2877 && $iloid!=3339){
            //$res_forma=db_query("SELECT FDIJ FROM FORMA WHERE ILOID = '%d' && IFUTAMID!=0 && DTDATUM>'2000'", $iloid);
            $res_forma=db_query("SELECT ILOID FROM LO WHERE ILOID = %s", $iloid);
            if(db_affected_rows()>0){
                $vaneforma=1;
            }
        }
        //print "<br>f:".$vaneforma;
        //if($lonev_no==8407){
header("location:/lovak/sablon/$lonev_no/$vaneforma/$iloid");
//$out.='v1';
            if($vaneforma==1){
                $out.="
                    <a href='http://195.228.135.95/php/uloforma.php?id=$iloid' title='Fut&aacute;sok versenyekben1' target='_new'><img src='/themes/ugetomarine/futicon.jpg' border='0' alt='Fut&aacute;sok'></a>
                ";
            }
            $out.="</div>
               </td>
              </tr>
              <tr>
               <td></td>
              </tr>
            </table>
            ";
    //return;
        //header("location: /lovak/sablon/".$lonev_no);
    }else{
        //print "<br>lonev_no".$lonev_no;
        header("location: /lovak/adm/".$lonev_no);
        return;
    }
 }else{
   // print "<br>nonisset lonev";
   // if($kateg=='norm_feddel'){
   //       $out=drupal_render(drupal_get_form('lokerfed_form'));
   // }else{
          print drupal_render(drupal_get_form('loker_form'));
   // }
 }
return $out;
}

function loker_form($form, &$form_state) {
  //drupal_add_js(drupal_get_path('module','lovak') . '/utocomplete_autosubmit.js', 'theme');
    //$form['stadium'] = array('#type' => 'hidden','#value' => 'TEXT_VAL');
    //$form['lonev'] = array('#type' => 'textfield', '#title' => drupal_convert_to_utf8('', 'iso-8859-2'),'#default_value' => '', '#maxlength' => 35, '#size' => 22,'#autocomplete_path' => 'lovak/autocomplete/a', '#attributes' => array('class' => 'auto_submit'),'#required' => TRUE);
    $form['lonev'] = array('#type' => 'textfield', '#title' => 'teszt', '#maxlength' => 35, '#autocomplete_path' => 'lovak/autocomplete', '#required' => TRUE);
    $form['submit'] = array('#type' => 'submit','#value' => 'k e r e s');
    return $form;
}

function lokerteny(){
$ret="";
if(isset($_POST['fedezomen'])){
    $fedezomen=$_POST['fedezomen'];
    $anyja=$_POST['anyja'];
    //tombazonosito visszafejtese
    $res=db_query("SELECT neve, ev, orszag FROM lovak WHERE fedezomen='IGEN' && lo_vagy_fed='LO' ORDER BY neve");
    $fedezomen_array[]='--V&aacute;laszzon!--';
    while($egysor = db_fetch_array($res)) {
        $fedezomen_array[]=$egysor["neve"].'--'.$egysor["ev"].'--'.$egysor["orszag"];   
    }
    
    $fedezomen=$fedezomen_array[$fedezomen];
    $year=DATE("Y");
    $proba = drupal_convert_to_utf8("SZÁRMAZÁS MODELLEZÉSE", "iso-8859-2");
    $sa=explode('--',$fedezomen);
    $apja=$sa[0];
    $apja_ev=$sa[1];
    $apja_orszag=$sa[2];

    $sa=explode('--',$anyja);
    $anyja=$sa[0];
    $anyja_ev=$sa[1];
    $anyja_orszag=$sa[2];
        
    $sa=explode('--',$fedezomen);
    $apja=$sa[0];
    $apja_ev=$sa[1];
    $apja_orszag=$sa[2];
    $no = 10414;
    $orszag = 'HU';
    if($anyja == ""){
        header("location: /");
        return;
    }
    db_query("INSERT INTO lovak (no, neve, ev, apja, anyja, orszag, apja_ev, anyja_ev, apja_orszag, anyja_orszag) VALUES ('%d', '%s', '%d', '%s', '%s', '%s', '%d', '%d', '%s', '%s')", $no, $proba, $year, $apja, $anyja, $orszag, $apja_ev, $anyja_ev, $apja_orszag, $anyja_orszag);
    //print "<br>lovak_sablon_no:".$no;
    lovak_sablon($no);
    db_query("DELETE FROM lovak WHERE no=10414");
    return;
}else{
    $out=drupal_get_form('lokerteny_form');
}

print theme("page", $out);
return;
}

function lovak_rekordmin($r1,$r2,$r3){
$ret='0:00.0';
if($r1<'1:00.0'){$r1='9:99.9';}
if($r2<'1:00.0'){$r2='9:99.9';}
if($r3<'1:00.0'){$r3='9:99.9';}

if($r1<=$r2){$ret=$r1;}else{$ret=$r2;}
if($ret<=$r3){$ret=$ret;}else{$ret=$r3;}
if($ret=='9:99.9'){$ret='0:00.0';}

$ret=substr($ret,0,1).'.'.substr($ret,2,4);
$ret=substr($ret,0,4).','.substr($ret,5,1);

//print "<br>".$ret;
return $ret;
}



function lovak_upgrd ($csomagmeret){

    //drupal_('start', 'zoli@uzsoki.hu', 'Lovak frissitese', 'start');
    //$headers = "From: ugeto@ugeto.com \n";
    //$headers.= "Content-Type: text/html; charset=UTF-8";
    //$headers .= "MIME-Version: 1.0 ";
    //mail("zoli@uzsoki.hu", "START", "START", $headers);
    //$headers = "From: ugeto@ugeto.com \n";
    //$headers.= "Content-Type: text/html; charset=UTF8";
    //$headers .= "MIME-Version: 1.0 ";
    //drupal_mail($module, '2', 'zoli@uzsoki.hu', 'HU', $params = array(), $from = NULL, $send = TRUE);

    db_query("UPDATE lovak SET upgrd=''");
    //print "<br>csomagmeret:".$csomagmeret;
    $reslo=db_query("SELECT ILOID, SLONEV, ISZULETESIEV, IANYAID, IAPAID, SORSZAG, SREKORD_RT, SREKORD_KT, SREKORD_HT, FELETNYEREMENY FROM LO");
    print "<br>AFF:".db_affected_rows();
    $mailREKstr="\r\n \r\n Az alabbi lovaknal volt rekordmodositas:";
    $mailPENZstr="\r\n \r\n Az alabbi lovaknal volt penzmodositas";
    $mailNEWstr="\r\n \r\n Az alabbi uj lovak tuntek fel az adatok kozott!!! Nem vettuk fel az adatbazisba!!!:";
    $mailEGYBEstr="\r\n \r\n Az alabbi egybevetesek voltak:";
    $mailERRORstr="\r\n \r\n Az alabbi hibak vannak:";
    while($egysor = db_fetch_array($reslo)) {
        $iloid=$egysor['ILOID'];
        //db_query("UPDATE LO SET IINTERNET = 1 WHERE ILOID = '$iloid'");
        $slonev=$egysor['SLONEV'];
        $slonev=trim($slonev);
        $iszuletesiev=$egysor['ISZULETESIEV'];
        $ianyaid=$egysor['IANYAID'];
        $resanyja=db_query("SELECT SLONEV FROM LO WHERE ILOID = '$ianyaid'");
        while($egysoranyja = db_fetch_array($resanyja)) {
            $anyja=$egysoranyja['SLONEV'];
        }
        //print "<br>lo:".$slonev."-".$anyja;
        $iapaid=$egysor['IAPAID'];
        $sorszag=$egysor['SORSZAG'];
        $sorszag=lovak_orszag($sorszag);
        $srekord_rt=$egysor['SREKORD_RT'];
        $srekord_kt=$egysor['SREKORD_KT'];
        $srekord_ht=$egysor['SREKORD_HT'];
        $rekord=lovak_rekordmin($srekord_rt,$srekord_kt,$srekord_ht);
        $feletnyeremeny=$egysor['FELETNYEREMENY'];

        //eloszor megnezzuk az egybevetes mezot, hogy van-e

        $res2=db_query("SELECT * from lovak WHERE egybevetes = '%s' && lo_vagy_fed='LO'", $slonev);
        $darab=db_affected_rows();
        if($darab>=1){
            $mailEGYBEstr.="\r\n ".$slonev;
        }else{//ha nincs egybevetes mezoben ilyen
            $res2=db_query("SELECT * from lovak WHERE binary neve = '%s' && lo_vagy_fed='LO'", $slonev);
            $darab=db_affected_rows();
            if($darab==1){
            }else{
                $res2=db_query("SELECT * from lovak WHERE binary neve = '%s' && anyja = '%s' && lo_vagy_fed='LO'", $slonev, $anyja);
                $darab=db_affected_rows();
                if($darab==1){
                }elseif($iszuletesiev=="1900"){
                    $res2=db_query("SELECT * from lovak WHERE binary neve = '%s' && lo_vagy_fed='LO'", $slonev);
                }else{
                    $res2=db_query("SELECT * from lovak WHERE binary neve = '%s' && ev = '%d' && lo_vagy_fed='LO'", $slonev, $iszuletesiev);
                }
                $darab=db_affected_rows();
            }
        }
        if($darab==1){


            while($egysorazon = db_fetch_array($res2)) {
                $no=$egysorazon['no'];
                $regirekord=$egysorazon['rekord'];
                $regipenz=$egysorazon['penz'];
            }
            //$rekord=lovak_rekordmin($srekord_rt,$srekord_kt,$srekord_ht);
            $up="";
            if(substr($rekord,0,1) != '0'){
                db_query("UPDATE lovak SET rekord = '%s', upgrd = '%s' WHERE no = '%d' && (rekord > '%s' || rekord='') && lo_vagy_fed='LO'", $rekord, 'REK', $no, $rekord);
//ZOLI TESZ db_query("SELECT * FROM lovak WHERE no = '%d' && (rekord > '%s' || rekord='')");

                if(db_affected_rows()){
                    //print "<br>REK:".$slonev;
                    $up.="REK";
                    $mailREKstr.="\r\n $slonev:".$regirekord." -> ".$rekord;
                }
            }
            if($feletnyeremeny != 0){
            $penzres=db_query("UPDATE lovak SET penz = '%d', upgrd = '%s' WHERE no = '%d' && penz < '%d'", $feletnyeremeny, 'PENZ', $no, $feletnyeremeny);
//ZOLI TESZT db_query("SELECT * FROM lovak WHERE no = '%d' && penz < '%d'");

                if(db_affected_rows($penzres)){
                    //print "<br>PENZ:".$slonev;
                    $up.="PENZ";
                    $mailPENZstr.="\r\n $slonev:".$regipenz." -> ".$feletnyeremeny;
                }
            }
        }
        if($darab<1){
            $res=db_query("SELECT SLONEV FROM LO WHERE ILOID='$ianyaid'");
            while($egysor = db_fetch_array($res)) {
                $anyja=$egysor['SLONEV'];
                if(substr($anyja,0,10)=="ISMERETLEN"){
                    $anyja="";
                }
                $anyja=trim($anyja);
            }
            $res=db_query("SELECT SLONEV FROM LO WHERE ILOID='$iapaid'");
            while($egysor = db_fetch_array($res)) {
                $apja=$egysor['SLONEV'];
                if(substr($apja,0,10)=="ISMERETLEN"){
                    $apja="";
                }
                $apja=trim($apja);
            }
            //print "<br>".$egysor['ILOID'];
            //print "<br>lonev:".$slonev."-".$anyja;

            if(substr($slonev,0,10)=="ISMERETLEN"){
            }else{
                if($iloid > 3642){
                // nem t&ouml;rt&eacute;nik meg a felv&eacute;tl db_query("INSERT INTO lovak (neve, ev, orszag, apja, anyja, rekord, penz, upgrd) VALUES ('%s', '%d', '%s', '%s', '%s', '%s', '%d', '%s')", $slonev, $iszuletesiev, $sorszag, $apja, $anyja, $rekord, $feletnyeremeny, 'NEW');
                $mailNEWstr.="\r\n $iloid - $slonev ".$iszuletesiev."-".$sorszag."-".$apja."-".$anyja."-".$rekord."-".$feletnyeremeny;
                }
            }
        }
        if($darab>1){
            if($iloid > 3642){
                $mailERRORstr.= "\r\n MAR ELEVE TOBB VAN:".$slonev."-".$iszuletesiev."-".$anyja;
                $mailERRORstr.= "\r\n NEM TUDJUK ATVENNI AZ ADATBAZISBA, UTANA KELLENE NEZNI!!!!!";
            }
        }
    }

    $headers = "From: ugeto@ugeto.com \n";
    $headers.= "Content-Type: text/html; charset=UTF-8";
    $headers .= "MIME-Version: 1.0 ";
    //drupal_mail("","zoli@uzsoki.hu", "Lovak frissitese", $mailREKstr.$mailPENZstr.$mailNEWstr.$mailEGYBEstr.$mailERRORstr, $headers);
    //drupal_mail('', 'zoli@uzsoki.hu', 'Lovak frissitese', $mailREKstr.$mailPENZstr.$mailNEWstr.$mailEGYBEstr.$mailERRORstr);
    //drupal_mail('user-pass', $account->mail, $subject, $body, $from);

    //global $language;
    //$params['subject'] = t('Feltoltes megtortent');
    //$params['body']    = 'results:'.$mailREKstr.$mailPENZstr.$mailNEWstr.$mailEGYBEstr.$mailERRORstr;
    //drupal_mail('smtp', 'smtp-upgrd', 'zoli@uzsoki.hu', $language, $params);

    
    

    //global $language;
    //$params['subject'] = t('UPGRD');
    $address1='kotun.carl@gmail.com';
    $address2='zojuhasz@gmail.com';
    $message=$mailREKstr.$mailPENZstr.$mailNEWstr.$mailEGYBEstr.$mailERRORstr;
    //$params['body']    =  $message;
    //$params['headers'] = $headers;
    //drupal_mail('smtp', 'smtp-test', $address, $language, $params);
    mailsend($address1, 'Lovak upgrade', $message);
    mailsend($address2, 'Lovak upgrade', $message);
    //drupal_mail('upgrd', 'zoli@uzsoki.hu', 'Lovak frissitese', $mailREKstr.$mailPENZstr.$mailNEWstr.$mailEGYBEstr.$mailERRORstr, '', $headers);
    return;
}





function lovak_forma($no){
    $res_lovak=db_query("SELECT neve, ev, orszag, szine, neme FROM lovak WHERE no = '%d'", $no);
    if(db_affected_rows()>=1){
        while($egysor = db_fetch_array($res_lovak)) {
            $lonev=$egysor['neve'];
            $ev=$egysor['ev'];
            $orszag=$egysor['orszag'];
            $szine=$egysor['szine'];
            $neme=$egysor['neme'];
        }
    }
    $iloid=0;
    $res_lo=db_query("SELECT ILOID FROM LO WHERE SLONEV = '%s'", $lonev);
    $talalt=db_affected_rows();
    if($talalt==1){
        while($egysor = db_fetch_array($res_lo)) {
            $iloid=$egysor['ILOID'];
        }
    }
    
    if($iloid!=0){
        $out="";
        
        $out.=$lonev="<b class='lo_forma_fo'>".$lonev." ".$ev.$szine.$neme."<a href='/lovak/sablon/$no'><img src='/themes/ugetomarine/pedicon.jpg' border='0' alt='Pedigr&eacute; t&aacute;bla'></a></b>";
        
        
        $out.="<div class='loforma'><br><table><tr class='forma_fej'>";
        $out.="<td>d&aacute;tum</td>";
        $out.="<td>t&aacute;v</td>";
        $out.="<td>hely</td>";
        $out.="<td>nyerem&eacute;ny</td>";
        $out.="<td>id&otilde;</td>";
        $out.="<td>futamn&eacute;v</td>";
        $out.="<td>els&otilde; d&iacute;j</td>";
        //$out.="<td>hajt&oacute;</td>";
        //$out.="<td>idom&aacute;r</td>";
        $out.="</tr>";
        $res_forma=db_query("SELECT FORMA.IKIIRASID, FORMA.DTDATUM, FORMA.SFUTAMNEV, FORMA.FELSODIJ, FORMA.ITAV, FORMA.FDIJ, FORMA.IHELYEZES, FORMA.SKORATLAG, FORMA.IIDOMARID, FORMA.IHAJTOID, HAJTO.SHAJTONEV, IDOMAR.SIDOMARNEV FROM FORMA, HAJTO, IDOMAR WHERE ILOID = '%d' && IFUTAMID!=0 && DTDATUM>'2000' && FORMA.IHAJTOID=HAJTO.IHAJTOID && FORMA.IIDOMARID=IDOMAR.IIDOMARID ORDER BY -IFORMAID ", $iloid);
        while($egysor = db_fetch_array($res_forma)) {
            $kiirasid=$egysor['IKIIRASID'];
            $datum=$egysor['DTDATUM'];
            $futamnev=$egysor['SFUTAMNEV'];
            $elsodij=$egysor['FELSODIJ'];
            
            if(trim($futamnev)==""){
                $res_kiiras=db_query("SELECT IKIIRASID, SKIIRASNEV, FDIJ1 FROM KIIRAS WHERE IKIIRASID = '%d'", $kiirasid);
                while($egysor_kiiras = db_fetch_array($res_kiiras)) {
                    $futamnev=$egysor_kiiras['SKIIRASNEV'];
                    $elsodij=$egysor_kiiras['FDIJ1']*1000;
                }
            }
            if($elsodij==0){$elsodij=" - ";}
            $tav=$egysor['ITAV'];
            $dij=$egysor['FDIJ'];
            if($dij==0){$dij=" - ";}
            $helyezes=$egysor['IHELYEZES'];
            if($helyezes==98){$helyezes=0;}
            if($helyezes==97){$helyezes=0;}
            //if($helyezes==0){$helyezes=" ";}
            $ido=$egysor['SKORATLAG'];
            if($ido=='0:00.0'){$ido=" - ";}
            $idomar=$egysor['SIDOMARNEV'];
            $hajto=$egysor['SHAJTONEV'];
            if($helyezes==1){
                $out.="<tr class='forma_nyero'>";
            }elseif($helyezes>1 && $helyezes<=3){
                $out.="<tr class='forma_hely'>";
            }else{
                $out.="<tr class='forma_sima'>";
            }
            $out.="<td>".$datum."</td>";
            $out.="<td>".$tav."</td>";
            $out.="<td>".$helyezes."</td>";
            $out.="<td>".$dij."</td>";
            $out.="<td>".$ido."</td>";
            $out.="<td>".$futamnev."</td>";
            $out.="<td>".$elsodij."</td>";
            //$out.="<td>".$hajto."</td>";
            //$out.="<td>".$idomar."</td>";
            $out.="</tr>";
        }
        $out.="</tr></table>";
        
    }else{
        $out.="Nincs adat!";
    }
    
    $changed=time();
    //$output=preg_replace("/'/","\'",$out);
    //db_query("UPDATE node SET changed='$changed', title='Forma' where nid='999999999'");
    //db_query("UPDATE node_revisions SET body='$out', teaser='$out', uid = '1', timestamp='$changed' where nid='999999999'");
    //header("location:/node/999999999");
    
$output=preg_replace("/'/","\'",$out);

$nid=998000000+$no;
//print $nid;



$output.="<br>Az adatfelvitel jelenlegi &aacute;llapot&aacute;ban csak a 2000.01.01 - 2007.07.21 -ig tart&oacute; id&otilde;szak fut&aacute;sai el&eacute;rhet&otilde;ek!";

db_query("SELECT * FROM node WHERE nid='$nid'");
//print db_affected_rows();
if(db_affected_rows()==0){
    db_query("INSERT INTO node (nid, vid) VALUES ('%d', '%d')", $nid, $nid);
    db_query("INSERT INTO node_revisions (nid, vid) VALUES ('%d','%d')", $nid, $nid);
}

db_query("UPDATE node SET changed='$changed', uid = '1', title='Forma' where nid='$nid'");
db_query("UPDATE node_revisions SET body='$output', teaser='$output', uid = '1', timestamp='$changed' where nid='$nid'");

//cache_clear_all('content:999999999:0');
header("location:/node/".$nid);
//print theme('page', $out);

}




function lovak_sablon($no,$apnev = "", $apev = 0, $annev="", $anev = 0, $vaneforma=0, $iloid=0, $orszag=""){
//function lovak_sablon($no,$apnev = "", $vaneforma=0, $iloid=0){
global $user, $remo, $remono;
$res=db_query("SELECT neve, ev, orszag FROM {lovak} WHERE no = :no", array(":no" => $no));
foreach ($res as $record4) {
    $lonev=$record4->neve;
    $ev=$record4->ev;
    $orszag=$record4->orszag;
}  
       
//print "<br> no:".$no;
//print "<br> LONEV:".$lonev;

//ha nyomtatóra, akkor ez "0"
$monitorra=1;

$remo=array();
$remono=array();

if($apnev==0){
    //lovak_remo($lonev,$ev,$orszag,&$remo,&$remono);
    lovak_remo($lonev,$ev,$orszag,$remo,$remono);
    print "<br>foremo";
    print_r($remo);
}else{
    //lovak_remo($lonev,$ev,$orszag,&$remo,&$remono,$apnev,$apev,$annev,$anev);
    lovak_remo($lonev,$ev,$orszag,$remo,$remono,$apnev,$apev,$annev,$anev);
    print "<br>foremo";
    print_r($remo);
}
// MEG VAN A REMO !!!!!!!!!!!!!!!!JZ 2017.05.03
//print "<br>remo:";print_r($remo);
//print "<br>remono:";print_r($remono);
//return;

//$lokernev=preg_replace("/'/","\'",$lonev);
$lokernev=$lonev;
$lonev_=$lonev;

//print "<br>". $lokernev."-".$ev;

//_mailuzenet($lokernev);

if(strstr($lokernev, 'RMAZ')) { // tehát ha száRMAZás modellezés
    $res2 = db_query("SELECT szine, neme, penz, rekord, tulajdonos, nevel, elozo, orszag FROM {lovak} WHERE binary neve = :lokernev && ev = :ev", array(":lokernev" => $lonev, ":ev" => $ev));
}else{
    $res2 = db_query("SELECT szine, neme, penz, rekord, tulajdonos, nevel, elozo, orszag FROM {lovak} WHERE binary neve = :lokernev && orszag = :orszag && ev = :ev", array(":lokernev" => $lonev, ":orszag" => $orszag, ":ev" => $ev));
}
$lonev='<font size="6">'.$lonev.'</font>'.", ".$ev;

$tal_res=count($res2);
//print "<br>tal_res:".$tal_res."-".$lonev;;

if($tal_res){
  print "<br>vantalres";
    foreach($res2 as $record5){
      $loszine=$record5->szine;
      $loneme=$record5->neme;
      $lopenz=$record5->penz;
      $loorszag=$record5->orszag;
      $loelozo=$record5->elozo;
      $lorek=$record5->rekord;
      $loteny=$record5->nevel;
      $tulajdonos=$record5->tulajdonos;
      print "<br>szne:".$loszine;
    }
    $adatjo=1;
    $lonev.=', '.$loorszag;
    if($lorek==0){
        $lorek="";
    }
    if($loelozo!=""){
        $lonev.="(e.".$loelozo.")"; 
    }
    if($lopenz==0){
        if(strlen(trim($tulajdonos))==0){
            $lonev.=', '.$loszine.$loneme.', '.$lorek.' &nbsp; '.'<font size=1> '.$loteny.'</font>';
        }else{
            $lonev.=', '.$loszine.$loneme.', '.$lorek.' &nbsp; '.'<font size=1> '.$loteny.'</font>'.'<font size=1> <i>/tulajdonos:'.$tulajdonos.'/</i></font>';
        }
    }else{
        if(strlen(trim($tulajdonos))==0){
            $lonev.=', '.$loszine.$loneme.', '.$lorek.', '.$lopenz.'Ft.- '.'<font size=1> '.$loteny.'</font>';
        }else{
            $lonev.=', '.$loszine.$loneme.', '.$lorek.', '.$lopenz.'Ft.- '.'<font size=1> '.$loteny.'</font>'.'<font size=1> <i>/tulajdonos:'.$tulajdonos.'/</i></font>';
        }
    }
    
}else{
    $adatjo=0;
}

//print "<br>lonev:".$lonev;
//print "<br>kesz";

//$ped_m=pedigre_m(&$remo,'m');

//print_r($remo);
//return;
$kped=pedigre($remo['k'],'k','yeslink');

$kkped=pedigre($remo['kk'],'k','yeslink');
$kkkped=pedigre($remo['kkk'],'k','yeslink');
$kkkkped=pedigre($remo['kkkk'],'k','yeslink');

$mped=pedigre($remo['m'],'m','yeslink');

//print "<br>remo m:".$remo['m'];
//print "<br>remo 0:".$lonev_;
//return;

//print "<br>pedelott:";
$lonev_.=', '.$ev;
$ped=pedigre($lonev_,$loneme,'yeslink');
//print "<br>pedutan:".$ped;

//$kped="Richtofit<br>1992, 1325678 Ft.-<br><br>Rododendron<br>1999, 1885678 Ft.-<br>";
$kped="<div class='lo_ped'>".$kped."</div>";
$kkped="<div class='lo_ped'>".$kkped."</div>";
$kkkped="<div class='lo_ped'>".$kkkped."</div>";
$kkkkped="<div class='lo_ped'>".$kkkkped."</div>";
$mped="<div class='lo_pedm'>".$mped."</div>";
$ped="<div class='lo_ped'>".$ped."</div>";
$lonev="<b class='lo_fo'><br>".$lonev."</b>";
//$lonev_.=", ".$ev.", ".$lorek.", ".$orszag.", , ";


$apja_link=$remono['m'];
$anyja_link=$remono['k'];




//$m=preg_replace("/(.+),/U", "<b>$1</b>", $remo['m'], 1); $m="<div class='lo_o1'><br><br><br>".$m."</div>";
$m=preg_replace("/(.+),/U", "<a href='/lovak/sablon/".$remono['m']."'><b>$1</b></a><br>", $remo['m'], 1); $m="<div class='lo_o1'>".$m."</div>";
$mm=preg_replace("/(.+),/U", "<a href='/lovak/sablon/".$remono['mm']."'><b>$1</b></a><br>", $remo['mm'], 1); $mm="<div class='lo_o2'>".$mm."</div>";
$mk=preg_replace("/(.+),/U", "<a href='/lovak/sablon/".$remono['mk']."'><b>$1</b></a><br>", $remo['mk'], 1); $mk="<div class='lo_o2'>".$mk."</div>";
$mmk=preg_replace("/(.+),/U", "<a href='/lovak/sablon/".$remono['mmk']."'><b>$1</b></a><br>", $remo['mmk'], 1); $mmk="<div class='lo_o3'>".$mmk."</div>";
$mmm=preg_replace("/(.+),/U", "<a href='/lovak/sablon/".$remono['mmm']."'><b>$1</b></a><br>", $remo['mmm'], 1); $mmm="<div class='lo_o3'>".$mmm."</div>";
$mkm=preg_replace("/(.+),/U", "<a href='/lovak/sablon/".$remono['mkm']."'><b>$1</b></a><br>", $remo['mkm'], 1); $mkm="<div class='lo_o3'>".$mkm."</div>";
$mkk=preg_replace("/(.+),/U", "<a href='/lovak/sablon/".$remono['mkk']."'><b>$1</b></a><br>", $remo['mkk'], 1); $mkk="<div class='lo_o3'>".$mkk."</div>";
$mmmk=preg_replace("/(.+),(.*)$/U", "<b>$1</b>", $remo['mmmk'], 1); $mmmk="<div class='lo_o4'><a href='/lovak/sablon/".$remono['mmmk']."'>".$mmmk."</a></div>";
$mmmm=preg_replace("/(.+),(.*)$/U", "<b>$1</b>", $remo['mmmm'], 1); $mmmm="<div class='lo_o4'><a href='/lovak/sablon/".$remono['mmmm']."'>".$mmmm."</a></div>";
$mmkm=preg_replace("/(.+),(.*)$/U", "<b>$1</b>", $remo['mmkm'], 1); $mmkm="<div class='lo_o4'><a href='/lovak/sablon/".$remono['mmkm']."'>".$mmkm."</a></div>";
$mmkk=preg_replace("/(.+),(.*)$/U", "<b>$1</b>", $remo['mmkk'], 1); $mmkk="<div class='lo_o4'><a href='/lovak/sablon/".$remono['mmkk']."'>".$mmkk."</a></div>";
$mkmk=preg_replace("/(.+),(.*)$/U", "<b>$1</b>", $remo['mkmk'], 1); $mkmk="<div class='lo_o4'><a href='/lovak/sablon/".$remono['mkmk']."'>".$mkmk."</a></div>";
$mkmm=preg_replace("/(.+),(.*)$/U", "<b>$1</b>", $remo['mkmm'], 1); $mkmm="<div class='lo_o4'><a href='/lovak/sablon/".$remono['mkmm']."'>".$mkmm."</a></div>";
$mkkm=preg_replace("/(.+),(.*)$/U", "<b>$1</b>", $remo['mkkm'], 1); $mkkm="<div class='lo_o4'><a href='/lovak/sablon/".$remono['mkkm']."'>".$mkkm."</a></div>";
$mkkk=preg_replace("/(.+),(.*)$/U", "<b>$1</b>", $remo['mkkk'], 1); $mkkk="<div class='lo_o4'><a href='/lovak/sablon/".$remono['mkkk']."'>".$mkkk."</a></div>";
$m_mped=$m.'<br><br>'.$mped;


//$k=preg_replace("/(.+),/U", "<b>$1</b>", $remo['k'], 1); $k="<div class='lo_o1'><br><br><br>".$k."</div>";
$k=preg_replace("/(.+),/U", "<a href='/lovak/sablon/".$remono['k']."'><b>$1</b></a><br>", $remo['k'], 1); $k="<div class='lo_o1'>".$k."</div>";
$km=preg_replace("/(.+),/U", "<a href='/lovak/sablon/".$remono['km']."'><b>$1</b></a><br>", $remo['km'], 1); $km="<div class='lo_o2'>".$km."</div>";
$kk=preg_replace("/(.+),/U", "<a href='/lovak/sablon/".$remono['kk']."'><b>$1</b></a><br>", $remo['kk'], 1); $kk="<div class='lo_o2'>".$kk."</div>";
$kmm=preg_replace("/(.+),/U", "<a href='/lovak/sablon/".$remono['kmm']."'><b>$1</b></a><br>", $remo['kmm'], 1); $kmm="<div class='lo_o3'>".$kmm."</div>";
$kmk=preg_replace("/(.+),/U", "<a href='/lovak/sablon/".$remono['kmk']."'><b>$1</b></a><br>", $remo['kmk'], 1); $kmk="<div class='lo_o3'>".$kmk."</div>";
$kkm=preg_replace("/(.+),/U", "<a href='/lovak/sablon/".$remono['kkm']."'><b>$1</b></a><br>", $remo['kkm'], 1); $kkm="<div class='lo_o3'>".$kkm."</div>";
$kkk=preg_replace("/(.+),/U", "<a href='/lovak/sablon/".$remono['kkk']."'><b>$1</b></a><br>", $remo['kkk'], 1); $kkk="<div class='lo_o3'>".$kkk."</div>";
$kmmm=preg_replace("/(.+),(.*)$/U", "<b>$1</b>", $remo['kmmm'], 1); $kmmm="<div class='lo_o4'><a href='/lovak/sablon/".$remono['kmmm']."'>".$kmmm."</a></div>";
$kmmk=preg_replace("/(.+),(.*)$/U", "<b>$1</b>", $remo['kmmk'], 1); $kmmk="<div class='lo_o4'><a href='/lovak/sablon/".$remono['kmmk']."'>".$kmmk."</a></div>";
$kmkm=preg_replace("/(.+),(.*)$/U", "<b>$1</b>", $remo['kmkm'], 1); $kmkm="<div class='lo_o4'><a href='/lovak/sablon/".$remono['kmkm']."'>".$kmkm."</a></div>";
$kmkk=preg_replace("/(.+),(.*)$/U", "<b>$1</b>", $remo['kmkk'], 1); $kmkk="<div class='lo_o4'><a href='/lovak/sablon/".$remono['kmkk']."'>".$kmkk."</a></div>";
$kkmm=preg_replace("/(.+),(.*)$/U", "<b>$1</b>", $remo['kkmm'], 1); $kkmm="<div class='lo_o4'><a href='/lovak/sablon/".$remono['kkmm']."'>".$kkmm."</a></div>";
$kkmk=preg_replace("/(.+),(.*)$/U", "<b>$1</b>", $remo['kkmk'], 1); $kkmk="<div class='lo_o4'><a href='/lovak/sablon/".$remono['kkmk']."'>".$kkmk."</a></div>";
$kkkm=preg_replace("/(.+),(.*)$/U", "<b>$1</b>", $remo['kkkm'], 1); $kkkm="<div class='lo_o4'><a href='/lovak/sablon/".$remono['kkkm']."'>".$kkkm."</a></div>";
$kkkk=preg_replace("/(.+),(.*)$/U", "<b>$1</b>", $remo['kkkk'], 1); $kkkk="<div class='lo_o4'><a href='/lovak/sablon/".$remono['kkkk']."'>".$kkkk."</a></div>";



//$k="<div class='lo_o1'>".$remo['k'];$k=preg_replace("/(.+),/U", "<b>$1</b>", $k, 1);
//$kk="<div class='lo_o2'>".$remo['kk'];$kk=preg_replace("/(.+),/U", "<b>$1</b>", $kk, 1);
//$km="<div class='lo_o2'>".$remo['km'];$km=preg_replace("/(.+),/U", "<b>$1</b>", $km, 1);
//$kkk="<div class='lo_o3'>".$remo['kkk'];$kkk=preg_replace("/(.+),/U", "<b>$1</b>", $kkk, 1);
//$kkm="<div class='lo_o3'>".$remo['kkm'];$kkm=preg_replace("/(.+),/U", "<b>$1</b>", $kkm, 1);
//$kmk="<div class='lo_o3'>".$remo['kmk'];$kmk=preg_replace("/(.+),/U", "<b>$1</b>", $kmk, 1);
//$kmm="<div class='lo_o3'>".$remo['kmm'];$kmm=preg_replace("/(.+),/U", "<b>$1</b>", $kmm, 1);
//$kkkk=preg_replace("/(.+),(.*)$/U", "<b>$1</b>", $remo['kkkk'], 1); $kkkk="<div class='lo_o4'>".$kkkk."</div>";
//$kkkm=preg_replace("/(.+),(.*)$/U", "<b>$1</b>", $remo['kkkm'], 1); $kkkm="<div class='lo_o4'>".$kkkm."</div>";
//$kkmk=preg_replace("/(.+),(.*)$/U", "<b>$1</b>", $remo['kkmk'], 1); $kkmk="<div class='lo_o4'>".$kkmk."</div>";
//$kkmm=preg_replace("/(.+),(.*)$/U", "<b>$1</b>", $remo['kkmm'], 1); $kkmm="<div class='lo_o4'>".$kkmm."</div>";
//$kmkk=preg_replace("/(.+),(.*)$/U", "<b>$1</b>", $remo['kmkk'], 1); $kmkk="<div class='lo_o4'>".$kmkk."</div>";
//$kmkm=preg_replace("/(.+),(.*)$/U", "<b>$1</b>", $remo['kmkm'], 1); $kmkm="<div class='lo_o4'>".$kmkm."</div>";
//$kmmk=preg_replace("/(.+),(.*)$/U", "<b>$1</b>", $remo['kmmk'], 1); $kmmk="<div class='lo_o4'>".$kmmk."</div>";
//$kmmm=preg_replace("/(.+),(.*)$/U", "<b>$1</b>", $remo['kmmm'], 1); $kmmm="<div class='lo_o4'>".$kmmm."</div>";


//$output.="<table border='0'><tr><td width='30'></td><td>".$ped."</td></table>";

$output='';

                
print "<br>losablon elott:";

 //if($vaneforma==1){


$output.="

<div class='lovak_sablon_container'>
  <div class='lovak_sablon_lo'>$lonev
";
//Ha vannak futások az NL ben, akkor ezt a linket ide be szúrja 
if($vaneforma){
  $output.="
    <a href='http://195.228.135.95/php/uloforma.php?id=$iloid' title='Fut&aacute;sok versenyekben' target='_new'><img src='/themes/ugetomarine/futicon.jpg' border='0' alt='VERSENYKARRIER'></a>
  ";
} 
/////////////////////////////////////////////////////////////  



$output.="  
  
  </div>
  <div class='lovak_sablon_ped'>$ped</div>  
  <div class='lovak_sablon_container_m'> 
    <div class='lovak_sablon_m'>$m</div>
  </div>
  <div class='lovak_sablon_container_m2'>
      <div class='lovak_sablon_mm'>$mm</div>
      <div class='lovak_sablon_mk'>$mk</div>
  </div>
  <div class='lovak_sablon_container_m3'>
      <div class='lovak_sablon_mmm'>$mmm</div>
      <div class='lovak_sablon_mmk'>$mmk</div>
      <div class='lovak_sablon_mkm'>$mkm</div>
      <div class='lovak_sablon_mkk'>$mkk</div>
  </div>
  <div class='lovak_sablon_container_m4'>
      <div class='lovak_sablon_mmmm'>$mmmm</div>
      <div class='lovak_sablon_mmmk'>$mmmk</div>
      <div class='lovak_sablon_mmkm'>$mmkm</div>
      <div class='lovak_sablon_mmkk'>$mmkk</div>
      <div class='lovak_sablon_mkmm'>$mkmm</div>
      <div class='lovak_sablon_mkmk'>$mkmk</div>
      <div class='lovak_sablon_mkkm'>$mkkm</div>
      <div class='lovak_sablon_mkkk'>$mkkk</div>
  </div>
  <div class='lovak_sablon_container_k'>
    <div class='lovak_sablon_k'>$k</div>
  </div>
  <div class='lovak_sablon_container_k2'>
      <div class='lovak_sablon_km'>$km</div>
      <div class='lovak_sablon_kk'>$kk</div>
  </div>
  <div class='lovak_sablon_container_k3'>
      <div class='lovak_sablon_kmm'>$kmm</div>
      <div class='lovak_sablon_kmk'>$kmk</div>
      <div class='lovak_sablon_kkm'>$kkm</div>
      <div class='lovak_sablon_kkk'>$kkk</div>
  </div>
  <div class='lovak_sablon_container_k4'>
      <div class='lovak_sablon_kmmm'>$kmmm</div>
      <div class='lovak_sablon_kmmk'>$kmmk</div>
      <div class='lovak_sablon_kmkm'>$kmkm</div>
      <div class='lovak_sablon_kmkk'>$kmkk</div>
      <div class='lovak_sablon_kkmm'>$kkmm</div>
      <div class='lovak_sablon_kkmk'>$kkmk</div>
      <div class='lovak_sablon_kkkm'>$kkkm</div>
      <div class='lovak_sablon_kkkk'>$kkkk</div>
  </div>
  <div class='lovak_sablon_container_kped'>
    <div class='lovak_sablon_kped'>$kped</div>
  </div>
  <div class='lovak_sablon_container_kkped'>
    <div class='lovak_sablon_kkped'>$kkped</div>
  </div>
  <div class='lovak_sablon_container_kkkped'>
    <div class='lovak_sablon_kkkped'>$kkkped</div>
  </div>
  <div class='lovak_sablon_container_kkkkped'>
    <div class='lovak_sablon_kkkkped'>$kkkkped</div>
  </div>
  
</div>
";

$res_upgrd=db_query("SELECT FORMA_upgrd_versenynap FROM {UPGRD} WHERE id = :id", array(":id" => 1));
$aktu_dattime='';

$record = $res_upgrd->fetchObject(); 
$aktu_dattime=$record->FORMA_upgrd_versenynap;
$aktu=$aktu_dattime;


$output.="<div class='lovak_sablon_allapot'>";

$output.="<br><i>Az adatok aktualit&aacute;sa a ".$aktu."-i versenynap ut&aacute;ni &aacute;llapot!</i></a></div>";

//$output.="<br><div><a href='/lovak/pdf'>PDF</a></div>";


if($adatjo==0){
    $output="<b>A D A T A I N K &nbsp; H I &Aacute; N Y O S A K !</b><br><br><a href='javascript: history.go(-1)'>Vissza az el&otilde;z&otilde; lapra...</a>";
}




//Ha admin user, akkor árverési kataloguslinket beszúr ide////////
if(array_search('admin', $user->roles)){
  $output.="<br><b>Arveresi katalogusoldal nyomtatasa az alabbi szorszamon:</b><br>";
  for ($i=1; $i<50; $i++){
    $output.="<a href='/tcpdf/$no/$i' title='Arveresi lap' target='_new'><b>$i </b></a>";
  }
 
////////////////////////////////////////////////////////////////
}
$output.="</div>";
 
$changed=time();
//$nid=999000000+$no;
//return;

$output.=_synclovak();

//node_delete($nid);


$nid=_node_insert($output, $no);



header("location:/node/".$nid);

return $output;
}




function _node_insert($output, $no){

//print '<br>:insert';
//print '<br>'.$output;

 $body_text = $output;
  
  $node = new stdClass();
  $node->type = 'lo';
  node_object_prepare($node);
  
  //$node->title    = 'Node Created Programmatically on ' . date('c');
  $node->title    = 'Pedigre';
  //$node->field_no    = $no;
  
  $node->language = LANGUAGE_NONE;

  $node->body[$node->language][0]['value']   = $body_text;
  $node->body[$node->language][0]['summary'] = text_summary($body_text);
  $node->body[$node->language][0]['format']  = '2';
  
  $node->field_no[$node->language][0]['value'] = $no;

  //$path = 'lovak/'.$nid;
  //$node->path = array('alias' => $path);

  node_save($node);
  $node_id = $node->nid;

  return $node_id;
  
}

function lovak_remo($lonev,$ev,$orszag,&$remo,&$remono, $apnev ="", $apev =0, $annev ="", $apev=0){
global $user;


//zdebug($lonev,$ev,$orszag, $apnev);

//if($lonev=='Stella'){


//print "<br>remo lonev:".$lonev;
//print "<br>remo ev:".$ev;
//print "<br>remo orszag:".$orszag;


//}

$ret_m_vagy_k=array();

 if($apnev == ""){
    $prefix="";
    $lonev_osszetett=$lonev.', '.$ev.', '.$orszag;
    //if($lonev=='Stella'){
    //    print "<br>nincsapnev";
    //}
    //print "<BR>ELOTTE:".print_r($remo);
    //print "<br>slonev osszetett:".$lonev_osszetett;
    lovak_remo_prefixbol($prefix, $remo, $remono, $lonev_osszetett);
    $prefix="m";lovak_remo_prefixbol($prefix, $remo, $remono);
    $prefix="k";lovak_remo_prefixbol($prefix, $remo, $remono);
    $prefix="mk";lovak_remo_prefixbol($prefix, $remo, $remono);
    $prefix="mm";lovak_remo_prefixbol($prefix, $remo, $remono);
    $prefix="kk";lovak_remo_prefixbol($prefix, $remo, $remono);
    $prefix="km";lovak_remo_prefixbol($prefix, $remo, $remono);
    $prefix="mmm";lovak_remo_prefixbol($prefix, $remo, $remono);
    $prefix="mmk";lovak_remo_prefixbol($prefix, $remo, $remono);
    $prefix="mkm";lovak_remo_prefixbol($prefix, $remo, $remono);
    $prefix="mkk";lovak_remo_prefixbol($prefix, $remo, $remono);
    $prefix="kmm";lovak_remo_prefixbol($prefix, $remo, $remono);
    $prefix="kmk";lovak_remo_prefixbol($prefix, $remo, $remono);
    $prefix="kkm";lovak_remo_prefixbol($prefix, $remo, $remono);
    $prefix="kkk";lovak_remo_prefixbol($prefix, $remo, $remono);
    
    
    //zdebug($prefix,$remo,$remono);
 }else{
    //if($lonev=='Stella'){
    //    print "<br>vanapnev";
    //}
    $prefix="m";lovak_remo_prefixbol($prefix, $remo, $apnev.', '.$apev);
    $prefix="k";lovak_remo_prefixbol($prefix, $remo, $annev.', '.$anev);
    $prefix="mk";lovak_remo_prefixbol($prefix, $remo, $remono);
    $prefix="mm";lovak_remo_prefixbol($prefix, $remo, $remono);
    $prefix="kk";lovak_remo_prefixbol($prefix, $remo, $remono);
    $prefix="km";lovak_remo_prefixbol($prefix, $remo, $remono);
    $prefix="mmm";lovak_remo_prefixbol($prefix, $remo, $remono);
    $prefix="mmk";lovak_remo_prefixbol($prefix, $remo, $remono);
    $prefix="mkm";lovak_remo_prefixbol($prefix, $remo, $remono);
    $prefix="mkk";lovak_remo_prefixbol($prefix, $remo, $remono);
    $prefix="kmm";lovak_remo_prefixbol($prefix, $remo, $remono);
    $prefix="kmk";lovak_remo_prefixbol($prefix, $remo, $remono);
    $prefix="kkm";lovak_remo_prefixbol($prefix, $remo, $remono);
    $prefix="kkk";lovak_remo_prefixbol($prefix, $remo, $remono);
   
    
  //zdebug($prefix,$remo,$remono);
  
 }


//print "<br>RET:";print_r($ret);

//print "<br>RETNO:";print_r($retno);
//print "<br>3832";
//print_r($remo);
return;
}

function lovak_remo_prefixbol($prefix, &$ret, &$retno, $lonev=''){
global $user;
//zdebug('debugneve','n1','n2','','','','v1','v2','','','');
//zdebug('lovak_remo_prefixbol kezdete','prefix','ret','retno','lonev','',$prefix,$ret,$retno,$lonev,'');


//print "<br>remo_prefixSTART:".$prefix;
//print_r($ret);

    if($prefix==''){
        $lonev_osszetett=$lonev;
    }else{
        $lonev_osszetett=$ret[$prefix];
    }
    
    $lonev_array=preg_split('!, !',$lonev_osszetett);
    if(isset($lonev_array['3'])){
        $lonev_array['2']=$lonev_array['3'];
    }
    //zdebug ($lonev_array);
    
    //print "<br>elotte-".$prefix;
    //zdebug($lonev_array['0'],$lonev_array['1'],$lonev_array['2'],$ret_m_vagy_k);
   
   //print "<br>elötte:";
   //print_r($remo);
   
  // zdebug('loarray  REMO1 elott',$loarray);
    //////////////////////////////////////////////a $lonev_array['2']-nek mindig az orszagnak kellene lennie
    lovak_remo1($lonev_array['0'],$lonev_array['1'],$lonev_array['2'],$ret_m_vagy_k);
      
    //zdebug('loarray  REMO1 utan',$loarray);
    //print "<br>utána:";
    //print_r($remo);
    //print "<br>utana-".$prefix;
    //zdebug($lonev_array['0'],$lonev_array['1'],$lonev_array['2'],$ret_m_vagy_k);
    //print "<br>k:".$ret_m_vagy_k['m'];
    //print "<br>m:".$ret_m_vagy_k['k'];
    $m=$ret_m_vagy_k['m'];
    $k=$ret_m_vagy_k['k'];
    
    preg_match('!(.+)/!', $m, $mm);
    preg_match('!(.+)/!', $k, $kk);
    preg_match('!/(.+)!', $m, $mmno);
    preg_match('!/(.+)!', $k, $kkno);

//ZOLI  
    //$ret[$prefix]="<b>".$ret[$prefix]."</b>"; 
    $ret[$prefix.'m']=$mm['1'];
    $ret[$prefix.'k']=$kk['1'];
    $retno[$prefix.'m']=$mmno['1'];
    $retno[$prefix.'k']=$kkno['1'];
//    zdebug('qqqqqqq',$ret);
    //print "<br>RET:";print_r($ret);
    //print "<br>RETNO:";print_r($retno);
    //print "<br>remo_prefixEND:".$prefix;
  //  print_r($ret);
  //zdebug('lovak_remo_prefixbol vege','prefix','ret','retno','lonev','',$prefix,$ret,$retno,$lonev,'');
}
function lovak_remo1($lonev,$ev,$orszag,&$loarray){
global $user;
    $ret=array();
    //zdebug('lovak_remo1eleje','lonev','ev','orszag','loarray','',$lonev,$ev,$orszag,$loarray,'');
   
    //zdebug($lonev,$ev,$orszag,$loarray);
    //print "3882 <br>lonev:".$lonev;
    $loapan_root=lovak_one($lonev,$ev,$orszag);
    
    //print_r($loapan_root);    
    //return;
    if(strstr($loapan_root['ap'],"ISMERETLEN")){$loapan_root['ap']="";}
    if(strstr($loapan_root['an'],"ISMERETLEN")){$loapan_root['an']="";}
    
    
    if($loapan_root['ap']==""){
        $loarray['m']="";
    }else{
        if($loapan_root['ap_penz']==0){
            $loarray['m']=$loapan_root['ap'].', '.$loapan_root['ap_ev'].', '.$loapan_root['ap_szine'].$loapan_root['ap_neme'].', '.$loapan_root['ap_orszag'].', '.$loapan_root['ap_rek'].',  /'.$loapan_root['ap_no'].'';
        }else{
            $loarray['m']=$loapan_root['ap'].', '.$loapan_root['ap_ev'].', '.$loapan_root['ap_szine'].$loapan_root['ap_neme'].', '.$loapan_root['ap_orszag'].', '.$loapan_root['ap_rek'].', '.$loapan_root['ap_penz'].'Ft.- /'.$loapan_root['ap_no'].'';
        }
    }
    if($loapan_root['an']==""){
        $loarray['k']="";
    }else{
        if($loapan_root['an_penz']==0){
            $loarray['k']=$loapan_root['an'].', '.$loapan_root['an_ev'].', '.$loapan_root['an_szine'].$loapan_root['an_neme'].', '.$loapan_root['an_orszag'].', '.$loapan_root['an_rek'].',  /'.$loapan_root['an_no'].'';
        }else{
            $loarray['k']=$loapan_root['an'].', '.$loapan_root['an_ev'].', '.$loapan_root['an_szine'].$loapan_root['an_neme'].', '.$loapan_root['an_orszag'].', '.$loapan_root['an_rek'].', '.$loapan_root['an_penz'].'Ft.- /'.$loapan_root['an_no'].'';
        }
    }
    //zdebug('lovak_remo1vege','lonev','ev','orszag','loarray','',$lonev,$ev,$orszag,$loarray,'');
   
return;
}

function lovak_one($lonev,$ev,$orszag=''){
global $user;  
$ret=array();
//zdebug('lovak_one_eleje','lonev','ev','orszag','','',$lonev,$ev,$orszag,'','');
//zdebug($lonev,$ev,$orszag);
$lokernev=preg_replace("/'/","\'",$lonev);
//$lokernev=$lonev;
//print "<br>lonev_ev_orszagE:".$lonev."-".$ev."-".$orszag;
$eredmeny = db_query("SELECT apja, apja_ev, apja_orszag, anyja, anyja_ev, anyja_orszag FROM lovak WHERE binary neve = :lokernev && ev = :ev", array(":lokernev" => $lonev, ":ev" => $ev));
//JZ20111115$eredmeny = db_query("SELECT apja, apja_ev, apja_orszag, anyja, anyja_ev, anyja_orszag FROM lovak WHERE binary neve = '$lokernev'");
//print "<br>count1:".count($eredmeny);
//return;
if(count($eredmeny)>1){  
    //$eredmeny = db_query("SELECT apja, apja_ev, anyja, anyja_ev FROM lovak WHERE binary neve = '$lokernev' && ev = '$ev' && orszag = '$orszag'");
    if($orszag==''){
        $eredmeny = db_query("SELECT apja, apja_ev, apja_orszag, anyja, anyja_ev, anyja_orszag FROM {lovak} WHERE binary neve = :lokernev && ev = :ev", array(":lokernev" => $lokernev, ":ev" => $ev));
    }else{
      //$arr=array();
      $arr= array(":lokernev" => $lokernev, ":ev" => $ev, ":orszag" => $orszag);
      $eredmeny = db_query("SELECT apja, apja_ev, apja_orszag, anyja, anyja_ev, anyja_orszag FROM {lovak} WHERE binary neve = :lokernev && ev = :ev && orszag = :orszag", $arr);
    }

}
$tal_db=count($eredmeny);

//print "<br>tal:".$tal_db;
//print "<br>lonev_ev_orszag:".$lonev."-".$ev."-".$orszag;
//print "<br>count2:".$tal_db;

//zdebug($orszag,$lokernev,db_affected_rows());

if($tal_db){
    //print "<br>taldbben";
    foreach($eredmeny as $record){
      $ap = $record->apja;
      $apev = $record->apja_ev;
      $an=$record->anyja;
      $anev=$record->anyja_ev;
    }
    //$apker=preg_replace("/'/","\'",$ap);
     $apker=$ap;
//    print "<br>apker:".$apker;
//    print "<br>apev:".$apev;
    if($apev==0){
        $eredmenyap = db_query("SELECT ev, szine, neme, orszag, penz, rekord, no FROM {lovak} WHERE binary neve = :apker", array(":apker" => $apker));
    }else{
        $eredmenyap = db_query("SELECT ev, szine, neme, orszag, penz, rekord, no FROM {lovak} WHERE binary neve = :apker && ev = :ev", array(":apker" => $apker, ":ev" => $apev));
    }
    $tal_ap=count($eredmenyap);
  //  print "<br>tal:".$tal_ap;
    if($tal_ap){
      $record = $eredmenyap->fetchObject(); 
        //foreach($eredmenyap as $record){
          $apev=$record->ev;
          $apszine=$record->szine;
          $apneme=$record->neme;
          $aporszag=$record->orszag;
          $aprek=$record->rekord;
          $appenz=$record->penz;
          $apno=$record->no;
          
        //}
        
        //print_r($record);
    }
    //print "<br>ANEV:".$anev;
    $anker=preg_replace("/'/","\'",$an);
    if($anev==0){
        $eredmenyan = db_query("SELECT ev, szine, neme,  orszag, penz, rekord, no FROM lovak WHERE binary neve = :anker", array(":anker" => $anker));
    }else{
        $eredmenyan = db_query("SELECT ev, szine, neme,  orszag, penz, rekord, no FROM lovak WHERE binary neve = :anker && ev = :ev", array(":anker" => $anker, ":ev" => $anev));
    }
    $tal_an=count($eredmenyan);
    if($tal_an){
        //foreach($eredmenyap as $record){
        $record = $eredmenyan->fetchObject();
        //print "<br>record:";
        //print_r($record);
          $anev=$record->ev;
          $anszine=$record->szine;
          $anneme=$record->neme;
          $anorszag=$record->orszag;
          $anrek=$record->rekord;
          $anpenz=$record->penz;
          $anno=$record->no;
        //}
        
    }
    $ret['ap']=$ap;
    $ret['ap_ev']=$apev;
    $ret['ap_szine']=$apszine;
    $ret['ap_neme']=$apneme;
    $ret['ap_orszag']=$aporszag;
    $ret['ap_rek']=$aprek;
    $ret['ap_penz']=$appenz;
    $ret['ap_no']=$apno;
    $ret['an']=$an;
    $ret['an_ev']=$anev;
    $ret['an_szine']=$anszine;
    $ret['an_neme']=$anneme;
    $ret['an_orszag']=$anorszag;
    $ret['an_rek']=$anrek;
    $ret['an_penz']=$anpenz;
    $ret['an_no']=$anno;
}
//if($lonev=='Fandango'){print_r($ret);}
//if($lonev=='Calandrello'){print_r($ret);}
//if($lonev=='Fandango'){print "<br>orszag".$orszag;}
//zdebug('lovak_one_vege','ret','','','','',$ret,'','','','');
return $ret;
}


function pedigre($lo,$mk,$yeslink='nolink'){
global $user;

$ret='';

//print "<br>pedigré";
//zdebug($lo,$mk);
//print "<br>Ped:";
//print "<br>lo:".$lo;
if($lo==""){return $ret;}

$lonev=$lo;
$lonev_array=preg_split('!, !',$lonev);
$lonev=$lonev_array['0'];
$ev=$lonev_array['1'];
$orszag=$lonev_array['3'];



//print "<br>lo:".$lo.'-'.$km;
//print_r($lonev_array);


//print "<br>orszag:".$orszag;
//print "<br>lonev:".$lonev;
//$lokernev=preg_replace("/'/","\'",$lonev);
$lokernev=$lonev;
//print '<br>lokernev:'.$lokernev;

//$eredmenyan = db_query("SELECT ev, szine, neme,  orszag, penz, rekord, no FROM lovak WHERE binary neve = :anker && ev = :ev", array(":anker" => $anker, ":ev" => $ev));


//$select="SELECT no, neve, ev, szine, neme, rekord, penz, apja AS szarm_ap, anyja AS szarm_an, lo_vagy_fed FROM {lovak} WHERE lo_vagy_fed = 'LO' && ";
//if($mk == 'k'){ $select.= "anyja = '$lokernev' ";}else{ $select.= "apja = '$lokernev' && apja_ev = '$ev' && orszag = 'HU' && rekord !=0 ";}
//if($mk == 'k' and $ev != 0){ $select.= "&& anyja_ev = '$ev' ";}else{ $select.= "" ;}
//if($orszag != '' and $mk=='k' ){ $select.= "&& anyja_orszag = '$orszag' ";}
//if($orszag != '' and $mk!='k' ){ $select.= "&& apja_orszag = '$orszag' ";}
//if($mk == 'k'){ $select.= "ORDER BY -ev LIMIT 16 ";}else{ $select.= "ORDER BY rekord LIMIT 5 ";}

$arr=array();
$select="SELECT no, neve, ev, szine, neme, rekord, penz, apja AS szarm_ap, anyja AS szarm_an, lo_vagy_fed FROM {lovak} WHERE lo_vagy_fed = :lo_vagy_fed ";
$arr[":lo_vagy_fed"] = "LO";
if($mk == 'k'){
  $select.= "&& anyja = :anyja ";
  $arr[":anyja"] = $lokernev;
}else{
  //$select.= "&& apja = :apja && apja_ev = :apja_ev && orszag = :orszag && rekord > :rekord ";
  //$arr[":apja"] = $lokernev; $arr[":apja_ev"] = $ev; $arr[":orszag"] = "HU"; $arr[":rekord"] = '1.00,1';
  $select.= "&& apja = :apja && apja_ev = :apja_ev && orszag = :orszag && rekord > :rekord ";
  $arr[":apja"] = $lokernev; $arr[":apja_ev"] = $ev; $arr[":orszag"] = "HU"; $arr[":rekord"] = '1.00,1';
  //_mailuzenet($lokernev);
}
if($mk == 'k' and $ev != 0){
  $select.= "&& anyja_ev = :anyja_ev ";
  $arr[":anyja_ev"] = $ev;
}else{
  $select.= "" ;
}
if($orszag != '' and $mk=='k' ){
  $select.= "&& anyja_orszag = :anyja_orszag ";
  $arr[":anyja_orszag"] = $orszag;
}
if($orszag != '' and $mk!='k' ){
  $select.= "&& apja_orszag = :apja_orszag ";
  $arr[":apja_orszag"] = $orszag;
}
if($mk == 'k'){
  $select.= "ORDER BY -ev LIMIT 16";
}else{
  $select.= "ORDER BY rekord LIMIT 5 ";
}

$result=db_query($select, $arr);


$tal_ap=count($result);
//print "<br>tal_ap:".$tal_ap;
//return;
if($tal_ap != 0){
    $i=0;
    if($mk=="k"){
        $ret.=''.drupal_convert_to_utf8("<i><font color='#D1B61B'>ivadékai:</font></i>", "iso-8859-2").'<br>';
    }else{
        $ret.=''.drupal_convert_to_utf8("<i><font color='#D1B61B'>legjobb 5 ivadéka (HU):</font></i>", "iso-8859-2").'<br>';
    }
    //$res = $result->fetchObject(); 
    while ($res = $result->fetchObject()) {
        $i++;
        $no=$res->no;
        $nev=$res->neve;
        $ev=$res->ev;
        $szine=$res->szine;
        $neme=$res->neme;
        $rek=$res->rekord;
        $penz=$res->penz;
       // print "<br>RES:";
       // print_r($res);
       // print "<br>nev:".$nev;
        
       // print "<br>rek:".$rek;
        $lovagyfed=$res->lo_vagy_fed;
        if($mk == 'k'){$szarm=$res->szarm_ap;}
        if($mk == 'm'){$szarm=$res->szarm_an;}
        $ret.='';
        //if($penz==0){
//          $ret.=''.$nev.'---'.$no.', <font size="1">'.$ev.', '.$szine.''.$neme.', '.$rek.', '.$szarm.'</font><br>';

        if($lovagyfed=='SIKERTELEN FEDEZTETES'){
        //  print "<br>if";
        //JZ ezt kell kivenni, ha éles lesz a sikertelen fedeztetés $ret.='<font size="1"> nem vemhesult - '.$ev.', '.$szine.''.$neme.', '.$rek.', '.$szarm.'</font><br>';
        }elseif($lovagyfed=='FEDEZTETES'){
        //  print "<br>elseif";
        //JZ EZT KELL KIKOMMENTEZNI HA MEG AKARJUK JELENITENI A PEDIGRENEL A "FEDEZTETES ALATT" -ot    $ret.='<font size="1"> fedeztet&eacute;s alatt - '.$ev.', '.$szine.''.$neme.', '.$rek.', '.$szarm.'</font><br>';
        }else{
        //  print "<br>else";
          $iloid=loazon_to_iloid($no);
          
        //  print "<br>no-iloid-nev:".$no.'---'.$iloid.'---'.$nev;
          if($iloid!=0){$vaneforma=1;}else{$vaneforma=0;}
          if($yeslink!='nolink'){
           // print "<br>nolink";
            //if($user->name == 'jz'){
              //Itt kell kikeresni a LO -táblából a név+apa segítségével az ILOID változót.
              //$iloid=loazon_to_iloid($no);
              //$ret.=$iloid.'-jz- <a href="/lovak/sablon/'.$no."/".$vaneforma."/".$iloid.'">'.$nev.'</a>, <font size="1">'.$ev.', '.$szine.''.$neme.', '.$rek.', '.$szarm.'</font><br>';
            //}else{  
              //$iloid=loazon_to_iloid($no);
              $ret.='<a href="/lovak/sablon/'.$no."/".$vaneforma."/".$iloid.'">'.$nev.'</a>, <font size="1">'.$ev.', '.$szine.''.$neme.', '.$rek.', '.$szarm.'</font>, &nbsp; ';
            //}
          }else{
          //  print "<br>nolink else";
              $ret.=''.$nev.', <font size="1">'.$ev.', '.$szine.''.$neme.', '.$rek.', '.$szarm.'</font>, &nbsp; ';
          }
        
          //ZOLI ez volt mielõtt a fentebbi user authos teszt ágat bele nem tettem        $ret.=''.$nev.', <font size="1">'.$ev.', '.$szine.''.$neme.', '.$rek.', '.$szarm.'</font><br>';
  //          $ret.='<a href="/lovak/sablon/$no>"'.$nev.'</a>, <font size="1">'.$ev.', '.$szine.''.$neme.', '.$rek.', '.$szarm.'</font><br>';
          //}else{
          //  $ret.='<b>'.$nev.'</b>, '.$ev.', '.$szine.''.$neme.', '.$rek.', '.$penz.'Ft.- '.$szarm.' &nbsp; ';
          //}
          $ret.='';
          if($i==4){
            $i=0;
            $ret.='';
          }
        }
    }
}
//print "<br>ret:".$ret;
return $ret;
}
function pedigrearveres($lo,$mk,$yeslink='nolink'){
global $user;

$ret='';

//print "<br>pedigré";
//zdebug($lo,$mk);
//print "<br>Ped:";
//print "<br>lo:".$lo;
if($lo==""){return $ret;}

$lonev=$lo;
$lonev_array=preg_split('!, !',$lonev);
$lonev=$lonev_array['0'];
$ev=$lonev_array['1'];
$orszag=$lonev_array['3'];



//print "<br>lo:".$lo.'-'.$km;
//print_r($lonev_array);


//print "<br>orszag:".$orszag;
//print "<br>lonev:".$lonev;
//$lokernev=preg_replace("/'/","\'",$lonev);
$lokernev=$lonev;
//print '<br>lokernev:'.$lokernev;

//$eredmenyan = db_query("SELECT ev, szine, neme,  orszag, penz, rekord, no FROM lovak WHERE binary neve = :anker && ev = :ev", array(":anker" => $anker, ":ev" => $ev));


//$select="SELECT no, neve, ev, szine, neme, rekord, penz, apja AS szarm_ap, anyja AS szarm_an, lo_vagy_fed FROM {lovak} WHERE lo_vagy_fed = 'LO' && ";
//if($mk == 'k'){ $select.= "anyja = '$lokernev' ";}else{ $select.= "apja = '$lokernev' && apja_ev = '$ev' && orszag = 'HU' && rekord !=0 ";}
//if($mk == 'k' and $ev != 0){ $select.= "&& anyja_ev = '$ev' ";}else{ $select.= "" ;}
//if($orszag != '' and $mk=='k' ){ $select.= "&& anyja_orszag = '$orszag' ";}
//if($orszag != '' and $mk!='k' ){ $select.= "&& apja_orszag = '$orszag' ";}
//if($mk == 'k'){ $select.= "ORDER BY -ev LIMIT 16 ";}else{ $select.= "ORDER BY rekord LIMIT 5 ";}

$arr=array();
$select="SELECT no, neve, ev, szine, neme, rekord, penz, apja AS szarm_ap, anyja AS szarm_an, lo_vagy_fed FROM {lovak} WHERE lo_vagy_fed = :lo_vagy_fed ";
$arr[":lo_vagy_fed"] = "LO";
if($mk == 'k'){
  $select.= "&& anyja = :anyja ";
  $arr[":anyja"] = $lokernev;
}else{
  //$select.= "&& apja = :apja && apja_ev = :apja_ev && orszag = :orszag && rekord > :rekord ";
  //$arr[":apja"] = $lokernev; $arr[":apja_ev"] = $ev; $arr[":orszag"] = "HU"; $arr[":rekord"] = '1.00,1';
  $select.= "&& apja = :apja && apja_ev = :apja_ev && orszag = :orszag && rekord > :rekord ";
  $arr[":apja"] = $lokernev; $arr[":apja_ev"] = $ev; $arr[":orszag"] = "HU"; $arr[":rekord"] = '1.00,1';
  //_mailuzenet($lokernev);
}
if($mk == 'k' and $ev != 0){
  $select.= "&& anyja_ev = :anyja_ev ";
  $arr[":anyja_ev"] = $ev;
}else{
  $select.= "" ;
}
if($orszag != '' and $mk=='k' ){
  $select.= "&& anyja_orszag = :anyja_orszag ";
  $arr[":anyja_orszag"] = $orszag;
}
if($orszag != '' and $mk!='k' ){
  $select.= "&& apja_orszag = :apja_orszag ";
  $arr[":apja_orszag"] = $orszag;
}
if($mk == 'k'){
  $select.= "ORDER BY -ev LIMIT 16";
}else{
  $select.= "ORDER BY rekord LIMIT 5 ";
}

$result=db_query($select, $arr);


$tal_ap=count($result);
//print "<br>tal_ap:".$tal_ap;
//return;
if($tal_ap != 0){
    $i=0;
    if($mk=="k"){
        //$lonev=''.drupal_convert_to_utf8("<br>$lonev", "iso-8859-2").'';
        $ret.='<tr><td colspan="2"><br><div style=" font-size: .7em; font-weight: bold; line-height: 100%; ">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'.$lonev.'</div></td><td></td><td></td><td></td></tr>';
    }else{
        $ret.=''.drupal_convert_to_utf8("<i><font color='#D1B61B'>legjobb 5 ivadéka (HU):</font></i>", "iso-8859-2").'<br>';
    }
    //$res = $result->fetchObject(); 
    while ($res = $result->fetchObject()) {
        $i++;
        $no=$res->no;
        $nev=$res->neve;
        $ev=$res->ev;
        $szine=$res->szine;
        $neme=$res->neme;
        $rek=$res->rekord;
        $penz=$res->penz;
       // print "<br>RES:";
       // print_r($res);
       // print "<br>nev:".$nev;
        
       // print "<br>rek:".$rek;
        $lovagyfed=$res->lo_vagy_fed;
        if($mk == 'k'){$szarm=$res->szarm_ap;}
        if($mk == 'm'){$szarm=$res->szarm_an;}
        $ret.='';
        //if($penz==0){
//          $ret.=''.$nev.'---'.$no.', <font size="1">'.$ev.', '.$szine.''.$neme.', '.$rek.', '.$szarm.'</font><br>';

        if($lovagyfed=='SIKERTELEN FEDEZTETES'){
        //  print "<br>if";
        //JZ ezt kell kivenni, ha éles lesz a sikertelen fedeztetés $ret.='<font size="1"> nem vemhesult - '.$ev.', '.$szine.''.$neme.', '.$rek.', '.$szarm.'</font><br>';
        }elseif($lovagyfed=='FEDEZTETES'){
        //  print "<br>elseif";
        //JZ EZT KELL KIKOMMENTEZNI HA MEG AKARJUK JELENITENI A PEDIGRENEL A "FEDEZTETES ALATT" -ot    $ret.='<font size="1"> fedeztet&eacute;s alatt - '.$ev.', '.$szine.''.$neme.', '.$rek.', '.$szarm.'</font><br>';
        }else{
        //  print "<br>else";
          $iloid=loazon_to_iloid($no);
          
        //  print "<br>no-iloid-nev:".$no.'---'.$iloid.'---'.$nev;
          if($iloid!=0){$vaneforma=1;}else{$vaneforma=0;}
          if($yeslink!='nolink'){
           // print "<br>nolink";
            //if($user->name == 'jz'){
              //Itt kell kikeresni a LO -táblából a név+apa segítségével az ILOID változót.
              //$iloid=loazon_to_iloid($no);
              //$ret.=$iloid.'-jz- <a href="/lovak/sablon/'.$no."/".$vaneforma."/".$iloid.'">'.$nev.'</a>, <font size="1">'.$ev.', '.$szine.''.$neme.', '.$rek.', '.$szarm.'</font><br>';
            //}else{  
              //$iloid=loazon_to_iloid($no);
              $ret.='<a href="/lovak/sablon/'.$no."/".$vaneforma."/".$iloid.'">'.$nev.'</a>, '.$ev.', '.$szine.''.$neme.', '.$rek.', '.$szarm.', &nbsp; ';
            //}
          }else{
          //  print "<br>nolink else";
            if(strlen($rek)==0){$rek="   ";}
              $ret.='<tr><td><div style="text-align:left; font-size: .6em; line-height: 100%;">&nbsp;&nbsp;'.$nev.'</div></td><td><div style="text-align:left; font-size: .6em; line-height: 100%;">'.$ev.'</div></td><td><div style="text-align:left; font-size: .6em; line-height: 100%;">'.$szine.''.$neme.'</div></td><td><div style="text-align:left; font-size: .6em; line-height: 100%;">'.$rek.'</div></td><td><div style="text-align:left; font-size: .6em; line-height: 100%;">'.$szarm.'</div></td></tr>';
              
          }
        
          //ZOLI ez volt mielõtt a fentebbi user authos teszt ágat bele nem tettem        $ret.=''.$nev.', <font size="1">'.$ev.', '.$szine.''.$neme.', '.$rek.', '.$szarm.'</font><br>';
  //          $ret.='<a href="/lovak/sablon/$no>"'.$nev.'</a>, <font size="1">'.$ev.', '.$szine.''.$neme.', '.$rek.', '.$szarm.'</font><br>';
          //}else{
          //  $ret.='<b>'.$nev.'</b>, '.$ev.', '.$szine.''.$neme.', '.$rek.', '.$penz.'Ft.- '.$szarm.' &nbsp; ';
          //}
          $ret.='';
          if($i==4){
            //$i=0;
            //$ret.='';
          }
        }
    }
}
//print "<br>ret:".$ret;
return $ret;
}
function lovak_keres($table, $field, $title1, $title2, $size=50, $feature){
$ret='';


print theme("page", $form . theme("table", $fejlecek, $tablazat));

return $ret;
}


function lovak_filter($op, $delta = 0, $format = -1, $text = '') {
  switch ($op) {
    case 'list':
      return array(0 => 'Csunyaszo szuro');

    case 'description':
      return 'A csunya szavakat kiszuri.';

    case 'no cache':
      return TRUE;

    case "process":
      $szavak = array("ortogonalis", "bifokalis", "intellektualisztikus");
      foreach ($szavak as $szo) {
        $text = str_replace($szo, "***", $text);
      }
      return $text;

    default:
      return $text;
  }
}
function lovak_filter_tips($delta, $format, $long = false) {
  return 'A csunya szavak automatikus moderalasra kerulnek.';
}


        
function convert_key_to_value($db, $fieldname, $array_key, $margin_low=0, $margin_high=9999999999){
            $ret="";
            
            //kikeresni, hogy mi az x-edik elem, mert a SELECT -bõl csak a key jön át
            $res = db_query("SELECT $fieldname FROM $db GROUP BY $fieldname");
            $ii=0;
            while($egysor = db_fetch_array($res)){
            
//          print_r($egysor);
    
                if(isset($margin_low) && isset($margin_high)){
                    if($egysor[$fieldname]>=$margin_low && $egysor[$fieldname]<=$margin_high){
                        if($ii==$array_key){
                        $ret=$egysor[$fieldname];
                        return $ret;
                        }
                    }
                    $ii++;
                
                }else{
                    if($ii==$array_key){

                        $ret=$egysor[$fieldname];

                        return $ret;
                    }
                    $ii++;
                }
            }

                        return $ret;
}
        
        
function lovak_nodeapi(&$node, $op, $arg) {
  switch ($op) {
    case 'validate':
      if (isset($node->path) && 
          $node->type == 'story' &&
          strpos($node->path, "hirek/") !== 0
         ) {
         form_set_error('path', 'Ehhez a tipushoz nem megfelelo alnev.');
      }
      break;
  }
}



function lovak_evbeiras_univerzalis(){

$ivadek_res=db_query('SELECT no, neve, ev, anyja, apja FROM lovak WHERE binary neve like "%"');
print "<br>aff:".db_affected_rows();
while($egysor = db_fetch_array($ivadek_res)){
    $ivadek_neve=$egysor['neve'];
    $ivadek_no=$egysor['no'];
    $ivadek_apja=$egysor['apja'];
    $ivadek_anyja=$egysor['anyja'];
    print "<br>Ivadek:".$ivadek_neve;    
    //keresni anyjat
    $ivadek_anyja=preg_replace("/'/","\'",$ivadek_anyja);
    $anyja_res=db_query("SELECT no, neve, ev FROM lovak WHERE binary neve = '$ivadek_anyja'");
    if(db_affected_rows()==1){
    print "ANYJA".db_affected_rows();
    while($egysor = db_fetch_array($anyja_res)){
        $anyja_ev=$egysor['ev'];
    }
    //db_query("UPDATE lovak SET anyja_ev = '$anyja_ev' WHERE no='$ivadek_no'");
    if(db_affected_rows()){
        print "ANYJABEIR ".$ivadek_anyja.db_affected_rows();
    }

    
    }
    //keresni apjat
    $ivadek_apja=preg_replace("/'/","\'",$ivadek_apja);
    $apja_res=db_query("SELECT no, neve, ev FROM lovak WHERE binary neve = '$ivadek_apja'");
    if(db_affected_rows()==1){
    print "APJA".db_affected_rows();

    while($egysor = db_fetch_array($apja_res)){
        $apja_ev=$egysor['ev'];
    }
    //db_query("UPDATE lovak SET apja_ev = '$apja_ev' WHERE no='$ivadek_no'");
    if(db_affected_rows()){
        print "APJABEIR ".$ivadek_apja.db_affected_rows();
    }
    }
}
return;
}

function lovak_evbeiras_apja(){
$res=db_query("SELECT apja, apja_ev, apja_orszag FROM lovak WHERE apja_ev<1111 || apja_orszag='' GROUP BY apja");
while($egysor = db_fetch_array($res)){
    $apja=$egysor['apja'];
    $res2=db_query("SELECT neve, ev, orszag FROM lovak WHERE binary neve= '%s'", $apja);
    if(db_affected_rows()==1){
        print "<br>ONLY:".$apja;
        while($egysor = db_fetch_array($res2)){
            $neve=$egysor['neve'];
            $ev=$egysor['ev'];
            $orszag=$egysor['orszag'];
            print "<br>APJANEVE:".$neve.$ev.$orszag;
            //$res3=db_query("SELECT * FROM lovak WHERE apja='%s'", $neve);
            $res3=db_query("UPDATE lovak SET apja_ev='%d', apja_orszag='%s' WHERE apja='%s' && lo_vagy_fed='LO'", $ev, $orszag, $neve);
            print "AFF:".db_affected_rows();
        }
    }elseif(db_affected_rows()<1){
        print "<br>!!!!!NINCS:".$apja;
    }elseif(db_affected_rows()>1){
        print "<br>!!!!!!MULTI:".$apja;
    }
}
}

function lovak_evbeiras_anyja(){

$res=db_query("SELECT anyja, anyja_ev, anyja_orszag FROM lovak WHERE anyja_ev<1111 || anyja_orszag='' GROUP BY anyja");
while($egysor = db_fetch_array($res)){
    $anyja=$egysor['anyja'];
    $res2=db_query("SELECT neve, ev, orszag FROM lovak WHERE binary neve= '%s'", $anyja);
    if(db_affected_rows()==1){
        print "<br>ONLY:".$anyja;
        while($egysor = db_fetch_array($res2)){
            $neve=$egysor['neve'];
            $ev=$egysor['ev'];
            $orszag=$egysor['orszag'];
            print "<br>ANYJANEVE:".$neve.$ev.$orszag;
            //$res3=db_query("SELECT * FROM lovak WHERE anyja='%s'", $neve);
            $res3=db_query("UPDATE lovak SET anyja_ev='%d', anyja_orszag='%s' WHERE anyja='%s' && lo_vagy_fed='LO'", $ev, $orszag, $neve);
            print "AFF:".db_affected_rows();
        }
    }elseif(db_affected_rows()<1){
        print "<br>!!!!!NINCS:".$anyja;
    }elseif(db_affected_rows()>1){
        print "<br>!!!!!!MULTI:".$anyja;
    }
}
}


function nevdecode($str){
    $ret="nulla";
    $len=strlen($str);
    $ordreg=0;
    $ret="";
    for($s=0;$s<=$len;$s++){
    $char=substr($str,$s,1);
    $ord=ord($char);
        if($ord==0){
        $char="";
    }
    if($ordreg==113 && $ord==1){
        $ret=substr($ret,0,-1)."û";
        }elseif($ordreg==81 && $ord==1){
        $ret=substr($ret,0,-1)."õ";}
        else{
        $ret.=$char;
        }
    if($ord!=0){
        $ordreg=$ord;
    }

        
    }
//$ret=drupal_convert_to_utf8($ret, "iso-8859-2");  
return $ret;
}
                
function lovak_orszag($o){
    if($o=='AUT'){$o='AT';}
    if($o=='CAN'){$o='CA';}
    if($o=='CZE'){$o='CZ';}
    if($o=='DEN'){$o='DK';}
    if($o=='FIN'){$o='FI';}
    if($o=='FRA'){$o='FR';}
    if($o=='GER'){$o='DE';}
    if($o=='HOL'){$o='NL';}
    if($o=='HUN'){$o='HU';}
    if($o=='ITY'){$o='IT';}
    if($o=='NOR'){$o='NO';}
    if($o=='RUS'){$o='RU';}
    if($o=='SWE'){$o='SE';}
    if($o=='UKR'){$o='UA';}
    if($o=='USA'){$o='US';}
    if($o=='YUG'){$o='YU';}
$ret=$o;
return $ret;
}
 
function lovak_block($op = 'list', $delta = 0, $edit = array()) {
  global $user;
  if ($op == 'list') {
        $blocks[0]['info'] = t('Lovak');
        $blocks[0]['cache'] = BLOCK_NO_CACHE;
        return $blocks;
  }
  else{

      $block = array();
      if(isset($_POST['lonev'])){
        $lonev_ev_o=$_POST['lonev'];
        //print "<br>lo:".$lonev_ev_o;
        $lodarabok = explode("--", $lonev_ev_o);
        $lonev=$lodarabok[0];
        $ev=$lodarabok[1];
        $orszag=$lodarabok[2];
        if(trim($orszag)==""){
            if($ev==0){
                $res=db_query("SELECT no, ev, szine, neme, rekord, penz, tulajdonos, nevel FROM lovak WHERE binary neve = '%s' && ev = 0", $lonev);
            }else{
                $res=db_query("SELECT no, ev, szine, neme, rekord, penz, tulajdonos, nevel FROM lovak WHERE binary neve = '%s' && ev = '%d'", $lonev, $ev);
            }
        }else{
            if($ev==0){
                $res=db_query("SELECT no, ev, szine, neme, rekord, penz, tulajdonos, nevel FROM lovak WHERE binary neve = '%s' && orszag = '%s' && ev = 0", $lonev, $orszag);
            }else{
                $res=db_query("SELECT no, ev, szine, neme, rekord, penz, tulajdonos, nevel FROM lovak WHERE binary neve = '%s' && ev = '%d' && orszag = '%s'", $lonev, $ev, $orszag);
            }
        }
        //print "<br>aff:".db_affected_rows();
        while($egysor = db_fetch_array($res)) {
            $lonev_no=$egysor['no'];
            //print "<br>lonev_no:".$lonev_no;
            $ev=$egysor['ev'];
            $szine=$egysor['szine'];
            $neme=$egysor['neme'];
            $rekord=$egysor['rekord'];
            $penz=$egysor['penz'];
            $tulajdonos=$egysor['tulajdonos'];
            $nevel=$egysor['nevel'];

        }
        $ret=$lonev_no;
        if($lonev_no == ""){
            $out='';
            $out.='<center><font size="5">'.$lonev.' ???</font><br>
            <img name="nincsilyenlo" src="/themes/ugetomarine/nincsilyenlo.gif" width="400" height="400" border="0" usemap="#m_nincsilyenlo" alt=""><map name="m_nincsilyenlo">
            <area shape="rect" coords="115,351,289,379" href="/" alt="" >
            <area shape="rect" coords="158,313,246,336" href="/lovak" alt="" >
            </map></center>
            ';
            print theme("page", $out);
            //header("location: /");
            return;
        }
        //megnezni van-e forma adat a FORMA tablaban ehhez a lohoz
        $vaneforma=0;
        $res_lovak=db_query("SELECT neve, ev, orszag, szine, neme FROM lovak WHERE no = '%d'", $no);
        if(db_affected_rows()>=1){
            while($egysor = db_fetch_array($res_lovak)) {
                $lonev=$egysor['neve'];
                $ev=$egysor['ev'];
                $orszag=$egysor['orszag'];
                $szine=$egysor['szine'];
                $neme=$egysor['neme'];

            }
        }
        $iloid=0;
        $res_lo=db_query("SELECT ILOID FROM LO WHERE SLONEV = '%s' && ISZULETESIEV = '%d'", $lonev, $ev);
        $talalt=db_affected_rows();
        if($talalt==1){
            while($egysor = db_fetch_array($res_lo)) {
                $iloid=$egysor['ILOID'];
            }
        }
        if($iloid!=0 && $iloid!=2877 && $iloid!=3339){
            //$res_forma=db_query("SELECT FDIJ FROM FORMA WHERE ILOID = '%d' && IFUTAMID!=0 && DTDATUM>'2000'", $iloid);
            //print "<br>iloid:".$iloid;
			$res_forma=db_query("SELECT ILOID FROM LO WHERE ILOID = %s", $iloid);
            if(db_affected_rows()>0){
                $vaneforma=1;
            }
        }
        header("location:/lovak/sablon/$lonev_no/$vaneforma/$iloid");
        //$out.='v3';
        if($vaneforma==1){
            $out.="
                <a href='http://195.228.135.95/php/uloforma.php?id=$iloid' title='Fut&aacute;sok versenyekben3' target='_new'><img src='/themes/ugetomarine/futicon.jpg' border='0' alt='Fut&aacute;sok'></a></div>
            ";
        }
        $out.="</div></td></tr><tr><td></td> </tr></table>";
        print theme("page", $out);
        return;
    }
    else{
        $block['subject'] = t('L&oacute;keres&eacute;s');
        $block['content'] = drupal_get_form('loker_form');
    }         
    return $block;
    



  }
  

}
function loazon_to_iloid($loazon){
  global $db;
  $ret=0;
  $res=db_query("SELECT neve, apja FROM {lovak} WHERE no = :no", array(":no" => $loazon));
  
  $tal_an=count($res);
  if($tal_an!=1){return 0;}
  $reski = $res->fetchObject();
  $loneve=$reski->neve;
  $loneve_=preg_replace("/'/","\'",$loneve);
  $apjaneve=$reski->apja;
  $apjaneve_=preg_replace("/'/","\'",$apjaneve);
      
  $res2=db_query("SELECT LO.ILOID AS tal_iloid, LO.SLONEV AS lonev, LO2.SLONEV AS apjanev FROM {LO} JOIN {LO} AS LO2 ON LO2.ILOID = LO.IAPAID
                 WHERE LO2.SLONEV = :lo2slonev && LO.SLONEV = :loslonev", array(":lo2slonev" => $apjaneve_, ":loslonev" => $loneve_));
  $tal_an2=count($res2);
  if($tal_an2!=1){return 0;}
  $reski2 = $res2->fetchObject();
  //print "<br>reski2:";
  //print "<br>tal_an2:".$tal_an2;
  //print "loazon:".$loazon;
  //print gettype($reski2);
  //print_r($reski2);
  $iloid=$loneve=$reski2->tal_iloid;
  $ret=$iloid;
  
  return $ret;
}


function zdebug($debugneve='',$name1='', $name2='', $name3='', $name4='', $name5='',$value1='', $value2='', $value3='', $value4='', $value5=''){
    global $user;
    if($user->uid==1){
      print "<br><br>DEBUGNEVE:<font color=blue>".$debugneve."</font><br><font color=green>=================================================================================================START</font><br>";
        if($name1){print "|".$name1." = ";if(gettype($value1)=='array'){print_r($value1);}else{print $value1;}}
        if($name2){print "|".$name2." = ";if(gettype($value2)=='array'){print_r($value2);}else{print $value2;}}
        if($name3){print "|".$name3." = ";if(gettype($value3)=='array'){print_r($value3);}else{print $value3;}}
        if($name4){print "|".$name4." = ";if(gettype($value4)=='array'){print_r($value4);}else{print $value4;}}
        if($name5){print "|".$name5." = ";if(gettype($value5)=='array'){print_r($value5);}else{print $value5;}}
      print "<br><font color=red>==================================================================================================END</font><br><br>";
     
    }
    return;
}


function _mailuzenet($str=""){
  $to      = 'zoli@uzsoki.hu';
$subject = 'MailUzenet';
$message = $str;
$headers = 'From: webmaster@example.com' . "\r\n" .
    'Reply-To: webmaster@example.com' . "\r\n" .
    'X-Mailer: PHP/' . phpversion();

mail($to, $subject, $message, $headers);
  
return;  
  
}


function _syncFORMA(){
$out="";
$forma_array=array();
$sz=0;
//betölteni tömbbe a source-ból
db_set_active('regi');
$res=db_query("SELECT * FROM {FORMA} WHERE attoltve = 0");
$uj=count($res);
if($uj==0){
  //$out="NINCS új FORMA!";
  return;
}else{
  foreach ($res as $regirecord) {
    $sz++;
    $forma_array['iformaid'][]=$regirecord->IFORMAID;
    $forma_array['ifutamid'][]=$regirecord->IFUTAMID;
    $forma_array['dtdatum'][]=$regirecord->DTDATUM;
    $forma_array['iloid'][]=$regirecord->ILOID;
    $forma_array['itav'][]=$regirecord->ITAV;
    $forma_array['ihelyezes'][]=$regirecord->IHELYEZES;
    $forma_array['fdij'][]=$regirecord->FDIJ;
    $forma_array['skoratlag'][]=$regirecord->SKORATLAG;    
  }
}
//kiirni a tömbböl a destinationba
db_set_active('default');  
//$forma_array['iformaid'][$i], $forma_array['ifutamid'][$i], $forma_array['dtdatum'][$i], $forma_array['iloid'][$i], $forma_array['itav'][$i], $forma_array['ihelyezes'][$i], $forma_array['fdij'][$i], $forma_array['skoratlag'][$i]);  
$sz2=0;
for($i = 0; $i<sizeof($forma_array['iformaid']); $i++){
  //db_query("INSERT INTO FORMA (IFORMAID, IFUTAMID, DTDATUM, ILOID, ITAV, IHELYEZES, FDIJ, SKORATLAG) VALUES ('%d', '%d', '%s', '%d', '%d', '%d', '%d', '%s')",
  //        $sz, $sz, $sz, $sz, $sz, $sz, $sz, $sz);
  $nid = db_insert('FORMA')
->fields(array(
  'IFORMAID' => $forma_array['iformaid'][$i],'IFUTAMID' => $forma_array['ifutamid'][$i],'DTDATUM' => $forma_array['dtdatum'][$i],'ILOID' => $forma_array['iloid'][$i],
  'ITAV' => $forma_array['itav'][$i],'IHELYEZES' => $forma_array['ihelyezes'][$i],'FDIJ' => $forma_array['fdij'][$i],'SKORATLAG' => $forma_array['skoratlag'][$i],
  ))
->execute();
$sz2++;
}
//beirni a régiben az attoltve valtozot 1-nek, hogy legközelebb már ne töltse ezeket a rekordokat
db_set_active('regi'); 
$num_update=db_update('FORMA')
 ->fields(array(
    'attoltve' => 1,    
  ))
  ->condition('attoltve', 0, '=')
  ->execute();
if($sz!=$sz2){
  _mailuzenet('UGETOupdateFORMA- NEM egyenlo sz - sz2');  
}
if($num_update!=$sz2){
  _mailuzenet('UGETOupdateFORMA - NEM egyenlo sz2 - num_delete');  
}
if($num_update==$sz2 && $sz2!=0){
  _mailuzenet('UGETOupdateFORMA - érkezett:'.$sz2);  
}
db_set_active('default');   
return;  
}


function _synclovak(){

$out="";
goto end;
//Megnézni, hogy a DEST táblában van-e olyan "no", ami a SOURCE -ban már törlésre került, majd TÖRÖLNI a DEST -be is.
db_set_active('regi');
$res=db_query("SELECT * FROM {lovak}");
$uj=count($res);
if($uj==0){
  db_set_active('default');
  return;
}else{
  foreach ($res as $regi_lovak) {
    $regi_lovak_no[]=$regi_lovak->no;        
  }
}
db_set_active('default');   
$del_no=array();
$res1=db_query("SELECT * FROM {lovak} ORDER BY no");
foreach ($res1 as $default_lovak) {
  $ker_no=$default_lovak->no;
  $ker_neve=$default_lovak->neve;
  if(array_search($ker_no, $regi_lovak_no) || $ker_no==1){
  }else{
    $del_no[]=$ker_no;
  }
}
for($i=0; $i<=sizeof($del_no);$i++){
  $no = $del_no[$i];
  $num_deleted = db_delete('lovak')
  ->condition('no', $no)
  ->execute();
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
end:

//Kigyüjteni a SOURCE táblából az authored_dat ill. updated_date szerinti frisseket, és INSERT-elni, vagy UPDATE-elni a DEST-be.

//Kigyüjteni a tábla-mezöinfókat, hogy automatizálni lehessen
db_set_active('regi');   
$sql = "SHOW COLUMNS FROM {lovak}";
$result = db_query($sql);
if (!$result) {
    echo "DB Error, could not list tables\n";
    echo 'MySQL Error: ' . mysql_error();
    exit;
}
$fname=array();
$ftype=array();
while($record = $result->fetchAssoc()) {
  //print "<br>".$record['Field'].'-'.$record['Type'];
  $fname[]=$record['Field'];
  $ftype[]=$record['Type'];
}
/////////////////////////////////////////////////////////////

//Kigyüjteni az elmúlt X napra visszamenöleg az újonan bekerült lovakat///////////////
$res=db_query("SELECT * FROM {lovak} WHERE authored_date >= NOW() - INTERVAL 15 DAY");
$darab=count($res);
if($darab==0){
  print"<br>NINCS!";
  return;
}else{
  //fields array-t összerakni a db_insert -hez
  $fields=array();
  $no=array();
  $recno=0;
  foreach ($res as $lovakrecord) {
    $recno++;
    for($i=0; $i<sizeof($fname); $i++){
      $fieldname=$fname[$i];
      if($fieldname!='no'){// mivel a "no" field az AUTOINCREMENT, azt kihagyjuk a fields-böl
        $fields[$recno][$fieldname] = $lovakrecord->$fieldname;
      }else{
        $no[$recno]=$lovakrecord->$fieldname;
      }
      if($fieldname=='updated_date' && $lovakrecord->$fieldname==0){// az UPDATED_DATE mezö 0000-00-00 00:00:00 értékével baj van, ezért külön kezeljük.
        $fields[$recno][$fieldname] = date("Y-m-d H:i:s", strtotime("1911-11-11"));
      }
    }
  }
}
///////////////////////////////////////////////////////////////////////////////////////

//db_insert a DEFAULT db -ben/////////////
db_set_active('default');
$ujbeirasvolt=0;
for($i=1; $i<=sizeof($fields); $i++){
  $vanmar = db_select('lovak','l')
  ->fields('l',array('no'))
  ->condition('l.no',  $no[$i])
  ->countQuery()
  ->execute()
  ->fetchField();
  if(!$vanmar){
    $ujbeirasvolt++;
    //print "<br>Nincsmég";
    $insert_fields=$fields[$i];
    $nid = db_insert('lovak')
    ->fields($insert_fields)
    ->execute();
  }
}
if($ujbeirasvolt>0){
_mailuzenet('UGETOupdate_lovak - újbeírásvolt:'.$ujbeirasvolt);
}
//////////////////////////////////////////

//Kigyüjteni az elmúlt X napra visszamenöleg a módosított lovakat///////////////
$fields=array();
$no=array();
$recno=0;
db_set_active('regi');  
$res=db_query("SELECT * FROM {lovak} WHERE updated_date >= NOW() - INTERVAL 15 DAY");
$darab=count($res);
if($darab==0){
  print"<br>NINCS!";
  return;
}else{
  // print"<br>UPDATElnivaló!:".$darab;
  //fields array-t összerakni a db_update -hez
  $fields=array();
  $no=array();
  $recno=0;
  foreach ($res as $lovakrecord) {
    $recno++;
    for($i=0; $i<sizeof($fname); $i++){
      $fieldname=$fname[$i];
      if($fieldname!='no'){// mivel a "no" field az AUTOINCREMENT, azt kihagyjuk a fields-böl
        $fields[$recno][$fieldname] = $lovakrecord->$fieldname;
      }else{
        $no[$recno]=$lovakrecord->$fieldname;
      }
      if($fieldname=='updated_date' && $lovakrecord->$fieldname==0){// az UPDATED_DATE mezö 0000-00-00 00:00:00 értékével baj van, ezért külön kezeljük.
        $fields[$recno][$fieldname] = date("Y-m-d H:i:s", strtotime("1911-11-11"));
      }
      if($fieldname=='authored_date' && $lovakrecord->$fieldname==0){// az AUTHORED_DATE mezö 0000-00-00 00:00:00 értékével baj van, ezért külön kezeljük.
        $fields[$recno][$fieldname] = date("Y-m-d H:i:s", strtotime("1911-11-11"));
      }
    }
  }
  if($darab>0){
    //_mailuzenet('UGETOupdate_lovak - módosítasvolt:'.$darab);
  }
}
////////////////////////////////////////////////////////////////////////////////

//db_update a DEFAULT db -ben/////////////
db_set_active('default');
for($i=1; $i<=sizeof($fields); $i++){
    $update_fields=$fields[$i];
    $nid = db_update('lovak')
    ->fields($update_fields)
    ->condition('no',  $no[$i])
    ->execute();
}
//////////////////////////////////////////

return;
}

function _syncLO(){

$out="";
//print "<br>syncLO";
//Kigyüjteni a SOURCE táblából az összes rekordot.

//Kigyüjteni a tábla-mezöinfókat, hogy automatizálni lehessen
db_set_active('regi');   
$sql = "SHOW COLUMNS FROM {LO}";
$result = db_query($sql);
if (!$result) {
    echo "DB Error, could not list tables\n";
    echo 'MySQL Error: ' . mysql_error();
    exit;
}
$fname=array();
$ftype=array();
while($record = $result->fetchAssoc()) {
  //print "<br>".$record['Field'].'-'.$record['Type'];
  $fname[]=$record['Field'];
  $ftype[]=$record['Type'];
}
/////////////////////////////////////////////////////////////

//Kigyüjteni az összes rekordot///////////////
$res=db_query("SELECT * FROM {LO}");

$affec = db_select('LO','L')
  ->fields('L')
  ->condition('L.ILOID',  99999999, '<>')
  ->countQuery()
  ->execute()
  ->fetchField();

$darab=$affec;
//print "<br>darab:".$darab;
//print_r($fname);
$regi_db=$darab;
$res=db_query("SELECT * FROM {LO}");

if($darab==0){
  print"<br>NINCS!";
  return;
}else{
  //fields array-t összerakni a db_insert -hez
  $fields=array();
  $no=array();
  $recno=0;
  foreach ($res as $LOrecord) {
    $recno++;
    //print "<br>recno:".$recno;
    for($i=0; $i<sizeof($fname); $i++){
      $fieldname=$fname[$i];
      $fields[$recno][$fieldname] = $LOrecord->$fieldname;
      //$no[$recno]=$LOrecord->$fieldname;
    }
  }
}
///////////////////////////////////////////////////////////////////////////////////////

//elöbb törlés, majd db_insert a DEFAULT db -ben/////////////
db_set_active('default');

//print "<br>sizeoffields:".sizeof($fields);

$num_deleted = db_delete('LO')
  ->condition('ILOID', 99999999, '<>')
  ->execute();
$uj_db=0;  
for($i=1; $i<=sizeof($fields); $i++){
  $uj_db++;
  $insert_fields=$fields[$i];
  $nid = db_insert('LO')
  ->fields($insert_fields)
  ->execute();
}
if($uj_db>$regi_db){
_mailuzenet('UGETOinsert_LO - LO rekordok száma:'.$uj_db);
}
////////////////////////////////////////////////////////////////////////////////////


return;
}






